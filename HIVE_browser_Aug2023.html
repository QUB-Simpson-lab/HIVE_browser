<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex, nofollow">
  <title>HIVE : Heatmap for Interactive Viewing of Expression data</title>
  <!--link rel="shortcut icon" href="{%  static 'webedit/favicon.ico' %}" /-->
  
  <!-- From: https://base64.guru/converter/encode/image/ico BUT not working on my Safari browser -->
  <link rel="icon" type="image/x-icon" sizes="16x16" href="data:image/x-icon;base64,AAABAAEADxAAAAEAIAAoBAAAFgAAACgAAAAPAAAAIAAAAAEAIAAAAAAAwAMAABMLAAATCwAAAAAAAAAAAAAAAAAAX3SQAr6dNlvNoyOrzqMhrc+jIK3IoSmttZs+rbWbPq3JoSitz6Mhrc+jIa3KoCSppoozRwAEtQDnUWoAhnlYCeWvFMD/uwP//7sD//+8Af/isyT/lJp9/5uddP/rtRr//7wB//+8A//8uQP/yJcPoQAAdQIAAFkAOJrIG5a0crO5vE3+u7tJ/7y7Sf+3uk7/rLZb/7C3Vv+6u0v/u7tJ/7u8Sf+3t0v9lppTgE07bQFWEk8BELLnkgjD9/gOwvP/JKns/yGi6/8hoOr/JJ3p/yOe6f8hoOr/IaHr/xG98f8MxPP+DKvcwRxjhBR6fZMDGLjvmg/J+v8Ox/r/H7L2/xe09/8Xs/b/F7T3/xa09/8Wtvf/Frb3/w7F+v8MyPv/DqviySVojxcbJNxYEiHs2g808P4ONfD/GEnu/xlS7P8aV+v/GVbs/xpY6/8XUO3/F1Ds/xA58P8ONPD/ECTq6hcbyooQGeyMBwf//wQE//8FBf//HTb8/xw8+v8ZOfr/GTn6/xk7+f8SKPz/Eyr8/wgN//8FA///BQX//wgK28sxQOgyRTy30k46of9NOqL/SUCs/0c+rf9FPLD/RDyx/0Q8sP9HO6z/RTuv/0o7p/9OOaH/Sjmk+Dg1rHV2X1QdmF072qRdMv+gXzr/eG6D/2xtjf9nbpT/aW6S/3Bshf9xbIX/am2Q/45jVv+lXTH/nVwz/3lNMod4anUOom9Zl5pvWeWIdGj/fXl6/393df9+d3f/gXZx/4F2cf9+d3b/f3Z0/4V1a/+Tb1vwnmVJx3pTQlKBWUoASJbHFxmy48gWt+3/KqPn/ySd5v8inuf/JJvm/yOc5v8epuj/Ip7n/xaz7P8Vr93pM4KlPHXV/wEWce4AJ6TcEhPM+sESzP75I7f5+hi7+foYuvj4F7z5+BW9+/cUv/z5FMD8+g3M/voKwPLiEoq3MXiAmwAAAAAAqKT/ADTP+SMh0PpJGs/5Si3A42kmqcu6JqfItCTD7I0rwuRkG9D6ShzO+UojuuwyOXy1AwAAAAAAAAAARpHhAC/R+gAg1/sADuD/AC+r1D4eoMreM6HE8iW66s9Mrs00E9n/ABzV+wAfvewAMXyzAAAAAAAAAAAAAAAAAAAAAAAAAAAA+0IAACnA8AO4ztVyztba25LAzlejo5wmzJh6AgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC3B8ADWzswU1dPURvPXzgvZoIYC06eOAAAAAAAAAAAAAAAAAAAAAACAAgAAgAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAIACAADAAgAA+D4AAPgeAAD8PgAA">
  <link rel="icon" type="image/x-icon" sizes="32x32" href="data:image/x-icon;base64,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">

  <!-- To eliminate the stringdb javascript exception: Access to XMLHttpRequest at 'https://string-db.org/api/interactive_svg/network' from origin 'null' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. -->
  <meta http-equiv="Content-Security-Policy" content="default-src *; font-src 'self' data: https://string-db.org; script-src 'self' https://string-db.org 'unsafe-inline' 'unsafe-eval'; style-src 'self' data: http://* https://* 'unsafe-inline'; img-src 'self' http https data: *;  media-src 'self' *; " >

  <!-- meta http-equiv="Content-Security-Policy" content="default-src *; font-src 'self' data: https://string-db.org; script-src 'self' https://string-db.org; style-src 'self' data: http://* https://* 'unsafe-inline'; img-src 'self' http https data: *;  media-src 'self' *; " -->

  <script type="text/javascript" src="https://string-db.org/javascript/combined_embedded_network_v2.0.4.js"></script>

  <!-- TODO: Ask stringdb to add ajax test:  "try {}" based on: https://www.codeproject.com/Articles/20114/Test-Internet-Connection-using-AJAX -->

  <base target="_blank"> <!-- Should open all links in a new browser tab (unless specify otherwise in the link), including the stringdb form "string_embedded_linkout" -->
<style>


/*
id="show_hide_selected_genes_table_button      style="border: 1px solid #0066cc; background-color: #0099cc; color: #ffffff;"
id="show_hide_gprofiler_table_button           style="border: 1px solid #0066cc; background-color: #0099cc; color: #ffffff;"
id="show_hide_copy_selected_genes_table_button style="border: 1px solid #0066cc; background-color: #0099cc; color: #ffffff;"

id="show_hide_stringdb_table_button" style="border: 1px solid #0066cc; background-color: #0099cc; color: #ffffff;"
id="show_hide_david_table_button" style="border: 1px solid #0066cc; background-color: #0099cc; color: #ffffff;" 
id="show_hide_create_heatmap_image_table_button" style="border: 1px solid #0066cc; background-color: #0099cc; color: #ffffff;" 
id="show_hide_download_heatmap_image_table_button" style="border: 1px solid #0066cc; background-color: #0099cc; color: #ffffff;"
id="show_hide_input_data_parameters_table_button" style="border: 1px solid #0066cc; background-color: #0099cc; color: #ffffff;" 
id="show_heatmap_with_column_names_and_types_button" style="border: 1px solid #0066cc; background-color: #0099cc; color: #ffffff;" 

*/
  input, select, textarea, button { font-family: inherit; font-weight: inherit; font-size: inherit; border-radius: 7px; }

  button:disabled, input:not([type=button]):disabled   {color:#404040; background: #e6eeff; border: none; font-weight:bold;} /* outline: none ?*/
  
  button:not(:disabled), input[type=button]:not(:disabled), input[type=file]:not(:disabled), input[type=submit]:not(:disabled) {border: 1px solid #0066cc; background-color: #0099cc; color: #ffffff;} /* padding: 5px 5px; */

  button.red:not(:disabled), input.red[type=button]:not(:disabled) {border: 1px solid #0066cc; background-color: #ff6666; color: #ffffff;} /* padding: 5px 5px; */
  button.big_red:not(:disabled), input.big_red[type=button]:not(:disabled) {border: 1px solid #0066cc; background-color: #ff6666; color: #ffffff; padding: 10px; font-weight:bold;} /* padding: 5px 5px; */

/* string buttons style="background-color: #0099cc; padding: 10px; */
  

  /*
 input[type=button]:not(:disabled), input[type=submit]:not(:disabled) {background-color: #6495ed; color:white; cursor:pointer;}
 .required_span_info {border: 2px solid red; background-color: #fffafa;}
  */
  
  input:not(:disabled), select:not(:disabled), button:not(:disabled) {cursor:pointer;} /* background-color: #6495ed; color:white; */

  input:not([type=radio]):disabled   {color:#404040;} /* outline: none ?*/
  /* input[type=text]:disabled   {color:#000000; background: #e6eeff; border: none;} */ /* outline: none ?*/
  select:disabled {color:#404040; background: #e6eeff; border: none; font-weight:bold;} /* outline: none ?*/


  input:required:not(:disabled), select:required:not(:disabled), textarea:required:not(:disabled) {border: 2px solid red;}
  input:required:invalid, textarea:required:invalid, select:required:invalid {background-color: #fffafa;}

  /* https://css-tricks.com/snippets/html/form-submission-new-window/
  <form id="string_embedded_linkout" action="https://string-db.org//cgi/network" method="post" target="_blank"><input type="hidden" name="identifiers" value="10090.ENSMUSP00000010807%0d10090.ENSMUSP00000015829%0d10090.ENSMUSP00000025243%0d10090.ENSMUSP00000043424%0d10090.ENSMUSP00000045291%0d10090.ENSMUSP00000052872%0d10090.ENSMUSP00000072483%0d10090.ENSMUSP00000099634%0d10090.ENSMUSP00000109215%0d10090.ENSMUSP00000112908%0d10090.ENSMUSP00000126464"><input type="hidden" name="network_flavor" value="actions"><input type="hidden" name="species" value="10090"><input type="hidden" name="required_score" value="0"><input type="hidden" name="hide_node_labels" value="False"><input type="hidden" name="hide_disconnected_nodes" value="False"><input type="hidden" name="block_structure_pics_in_bubbles" value="False"><input type="hidden" name="suppressDisambiguation" value="1"><input type="hidden" name="caller_identity" value="embedded_svg"></form> */

 
  /* th {background-color: #808080; position: sticky; top: 0; z-index: 10;} */
  
  /* #heatmap_thead thead {background-color: #eee; position: sticky; top: 0; z-index: 10;} */
  /* th, td {border-bottom: 1px solid #000;} */
  /* You can’t position: sticky; a <thead>. Nor a <tr>. But you can sticky a <th>,... see:  https://css-tricks.com/position-sticky-and-table-headers/ */
  /* th {position: sticky; top: 0;} */
  
  th, td {border: 1px solid #909090; padding: 5px 10px;}

  th {background-color: #b0b0b0;}
  td {background-color: #ffffee; text-align:center;}


  /* Rounded table corners - need to specify the tr:first-of-type as heatmap table has two 'th' rows. */


  /* Cannot use these for the input_data_parameters_table table as causes the corners of all the rows of the two enclosed tables to also be rounded, so I assigned rounded directly to it's corners */
  
  table.round_corners tr:first-of-type th:first-of-type {border-top-left-radius: 15px;}
  table.round_corners tr:first-of-type th:last-of-type {border-top-right-radius: 15px;}

  table.round_corners tr:last-of-type td:first-of-type {border-bottom-left-radius: 15px;}
  table.round_corners tr:last-of-type td:last-of-type {border-bottom-right-radius: 15px;}

  
  /*
  table.round_corners thead tr:first-child th:first-child { border-top-left-radius: 10px; }
  table.round_corners thead tr:first-child th:last-child  { border-top-right-radius: 10px; }

  table.round_corners tbody tr:last-of-type td:first-child  { border-bottom-left-radius: 20px; }
  table.round_corners tbody tr:last-of-type td:last-child   { border-bottom-right-radius: 20px; }
*/
  /* Also the heatmap scale has no 'th' row so round the 'td' in first row */

  #heatmap_scale_table tr:first-of-type td:first-of-type {border-top-left-radius: 15px;}
  #heatmap_scale_table tr:first-of-type td:last-of-type {border-top-right-radius: 15px;}


  
  
  /*
  table { 
    border: 1px solid #f00;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 30px;
    background-color: yellow;
    padding: 10px;
    margin:0 auto; 
}
  */

  table {
    border-collapse: separate;
    border-spacing: 0;
    margin: 5px auto; 
  }


  table.input_data_tables {}
  table.input_data_tables tr:first-of-type {position: sticky; top: 30px; z-index: 20;}
  

  table.filter_and_display_options_tables {}
  table.filter_and_display_options_tables tr:first-of-type {position: sticky; top: 30px; z-index: 20;}
  
  
  table.tool_table {} /* Not using: display: none; */

  table.tool_table tr:first-of-type {position: sticky; top: 30px; z-index: 10;}

  table.tool_table th:first-of-type {border-top-left-radius: 15px;}
  table.tool_table th:last-of-type {border-top-right-radius: 15px;}
  
  table.tool_table_hide_td th:first-of-type {border-bottom-left-radius: 15px;}
  table.tool_table_hide_td th:first-of-type {border-bottom-right-radius: 15px;}  
  table.tool_table_hide_td td {display: none;}

  th.tool_table_show_td th:first-of-type {border-bottom-left-radius: 0;}
  th.tool_table_show_td th:first-of-type {border-bottom-right-radius: 0;}
  table.tool_table_show_td td {}
  

   
  /* #heatmap_top1_row th {border-bottom: 0; border-left: 1px solid #000000; border-right: 1px solid #000000;}
  #heatmap_top2_row th {border-top: 0; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000;}
*/

  /* #table_sum_row th {border-top: 1px solid #000000;}
  #table_sum_row2 th {border-top: 1px solid #000000;}
  */

  #heatmap_tbody tr:nth-child(even) {background-color: #f0f0f0;}
  
  #heatmap_tbody tr:hover {background-color: #d0d0d0;} /* color:#ffffff;} */
  #heatmap_tbody tr:hover td {background-color: #d0d0d0;} /* color:#ffffff;} */
  #heatmap_tbody tr:hover a {color:#ffffff;}


  #celltypes_tbody tr:hover {background-color: #d0d0d0;} /* color:#ffffff;} */
  #celltypes_tbody tr:hover td {background-color: #d0d0d0;} /* color:#ffffff;} */
  #times_tbody tr:hover {background-color: #d0d0d0;} /* color:#ffffff;} */
  #times_tbody tr:hover td {background-color: #d0d0d0;} /* color:#ffffff;} */

  li {margin-bottom: 8px;}



/* There are predefined list types, but none for Info: https://developer.mozilla.org/en-US/docs/Web/CSS/list-style-type */
/* So I'm using Unicode Info icons: ℹ  ℹ  ⓘ but I can also use, eg: list-style: url('/media/examples/rocket.svg');  */




/* From: https://css-tricks.com/exploring-what-the-details-and-summary-elements-can-do/  */

details.tooltip {
  border-radius: 4px;
  cursor: pointer;
  display: inline-block;
  position: relative;
  transition: 0.15s background linear;
}

details.tooltip:hover, details.tooltip:focus {
  background: #d4d1ec;
}

/* background: url("https://assets.codepen.io/14179/Info.svg") 11px 11.5px no-repeat;
  list-style: none;
    padding-left: 33px;  
*/

summary.tooltip {
  list-style: 'ⓘ';
  padding: 4px;
  padding-left: 2px;
  color: blue;
  vertical-align: top;
  margin-left: 15px;
  font-size: 90%;
}

details.tooltip p {
  font-size: 85%;
  font-style: normal;
  font-weight: normal;
  text-align: left;
  cursor: auto;
  background: #eee;
  padding: 10px;
  width: 350px;
  position: absolute;
  left: 0;
  top: 35px;
  border-radius: 4px;
  right: 0;
  z-index: 999; /* Added by SJB 22 Jan 2023, as otherwise any other summary behind is seen within this paragraph */
}

/* Tiny triangle that points up */
details.tooltip p:before, details.tooltip div:before {
  content: "";
  border-bottom: 12px solid #eee;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  height: 0;
  left: 10px;
  position: absolute;
  top: -10px;
  width: 0;
}

details.tooltip[open] p, details.tooltip[open] div {
  animation: animateDown 0.2s linear forwards;
}
/*
@keyframes animateDown {
  0% {
    opacity: 0;
    transform: translatey(-15px);
  }
  100% {
    opacity: 1;
    transform: translatey(0);
  }
}
*/

/* Also see the javascript below that clears the this when click elsewhere on the page */




/* Tabbed divs */
   div.sjb_tab_main {margin: auto auto; min-width: 320px;  max-width: 1600px; background: #cccccc; text-align:center; border-radius: 15px; padding: 5px;} /* max-width: 1600px; width:100%; */

   div.sjb_tab {}
   
   .sjb_tab_content {background: #ffffee; color: #373737;}
   .sjb_tab_content > div {display: none; padding: 1px 1px 0;}

   input.sjb_tab {display: none;}
   input.sjb_tab_disabled {display: none;}
   
/*
   label.sjb_tab_disabled {}
   label.sjb_tab_disabled:hover {}
*/

   label.sjb_tab {display: inline-block; padding: 6px 6px; font-weight: 600; text-align: center; position:sticky; top:0; margin: 0; background: #cccccc; border-radius: 10px; 
   border: 1px solid #77aaff;
/*
         -2px 2px #77aaff,
         -3px 3px #77aaff,
         -4px 4px #77aaff,
         -5px 5px #77aaff; 
         */
         }
   
   label.sjb_tab.bottom {display: inline-block; padding: 6px 6px; font-weight: 600; text-align: center; position:sticky; bottom: 0; margin: 0; background: #cccccc;}

   label.sjb_tab:hover {color: #fff; cursor: pointer; box-shadow: 2px -1px #77aaff;}

   input.sjb_tab:disabled + label.sjb_tab {color: #777; cursor: not-allowed; border: 1px solid #777777;} /* or: cursor:default */

   input.sjb_tab:not(:disabled) + label.sjb_tab {background: #bbcce0; box-shadow: 2px -1px #77aaff;} /* background: #bbccdd; #39bcfe; */

   input.sjb_tab:checked + label.sjb_tab {background: #365da2 !important; color: #fff; cursor: default; box-shadow: 2px -1px #77aaff;} /* was: background: #ed5a6a for red, but changed to match the dark-blue of the HIVE logo, as red usually indicates an error */

   #sjb_tab1:checked ~ .sjb_tab_content #sjb_tab_content1,
   #sjb_tab2:checked ~ .sjb_tab_content #sjb_tab_content2,
   #sjb_tab3:checked ~ .sjb_tab_content #sjb_tab_content3,
   #sjb_tab4:checked ~ .sjb_tab_content #sjb_tab_content4,
   #sjb_tab5:checked ~ .sjb_tab_content #sjb_tab_content5,
   #sjb_tab6:checked ~ .sjb_tab_content #sjb_tab_content6,
   #sjb_tab7:checked ~ .sjb_tab_content #sjb_tab_content7,
   #sjb_tab8:checked ~ .sjb_tab_content #sjb_tab_content8,
   #sjb_tab9:checked ~ .sjb_tab_content #sjb_tab_content9,
   #sjb_tab10:checked ~ .sjb_tab_content #sjb_tab_content10,
   #sjb_tab11:checked ~ .sjb_tab_content #sjb_tab_content11,
   #sjb_tab12:checked ~ .sjb_tab_content #sjb_tab_content12,
   #sjb_tab13:checked ~ .sjb_tab_content #sjb_tab_content13,
   #sjb_tab14:checked ~ .sjb_tab_content #sjb_tab_content14,
   #sjb_tab15:checked ~ .sjb_tab_content #sjb_tab_content15 {display: block;} 



</style>


<script>
'use strict'; // ES5+ to report undeclared variables.



/*
// checkbox_elem1.indeterminate = true; // can set this indeterminate property via JavaScript (it cannot be set using an HTML attribute):



// Aug 2023: To select multiple checkboxes using shift key:  from: https://gist.github.com/aaemnnosttv/30fc91338c71e5b9ed31a7378d23983d
const boxes = Array.from(document.querySelectorAll('.inbox .item [type="checkbox"]'));
let lastChecked;

function changeBox(event) {
  if (event.shiftKey && this != lastChecked) {
    checkIntermediateBoxes(lastChecked, this);
  }

  lastChecked = this;
}
boxes.forEach(item => item.addEventListener('click', changeBox));

function checkIntermediateBoxes(first, second) {
  if (boxes.indexOf(first) > boxes.indexOf(second)) {
    [second, first] = [first, second];
  }

  intermediateBoxes(first, second).forEach(box => box.checked = true);
}

function intermediateBoxes(start, end) {
  return boxes.filter((item, key) => {
    return boxes.indexOf(start) < key && key < boxes.indexOf(end);
  });
}
*/




function set_tooltip_click_outside_details_event() {
  // From: https://css-tricks.com/exploring-what-the-details-and-summary-elements-can-do/ 
  // const tooltip = document.querySelector(".tooltip");
  
  // const tooltips = document.querySelectorAll(".tooltip"); // Using querySelectorAll() as querySelector() just selects the first one.

  var tooltips = document.getElementsByTagName("DETAILS");

  console.log("tooltips:",tooltips);

//alert(tooltip);

  document.addEventListener("click", function (e) {
    //alert("document.addEventListener()");
    for (var i=0; i<tooltips.length; i++) { 
      // alert(tooltip);
      var tooltip = tooltips[i];

      if (tooltip.hasAttribute("open") && !tooltip.contains(e.target)) tooltip.removeAttribute("open");
    
//    var insideTooltip = tooltip.contains(e.target);
//    if (!insideTooltip) {
//        alert("document.addEventListener() !insideTooltip"); 
//      tooltip.removeAttribute("open");
    }
  });
}


var j_gene_id, j_fc, j_pvalue, j_pct1, j_pct2; // Columns in input files.

var celltypes, fc_amounts, times, logfcs, logpvs, pct1s, pct2s, logsort, head1, head2, num_fc_in_cols; // arrays. The first row of logfcs contains the column headings, and first column contains the gene-name 
var gene_dict; // gene name dictionary used when reading in multiple files.
var num_cols, fc_min, fc_max;
var has_pct12_columns = false, has_pvalues_columns = false;
var num_files, num_files_read; // For reading multiple files. 
var taxid="", ensembl_id="", gprofiler_id="", organism_text="";

var num_files_with_unknown_headings;

// was: var taxid, organism, organism_text;

var show_fold_change_or_pvalue = "fold_change";

var lightRed="#FF6666", red="red", green="green", greenYellow="greenyellow", yellow="yellow", blue="blue", lightBlue="lightblue"; 

// eg: 
// times = ["EARLY","MID","LATE"]; // or ["E","M","L"]; // to fit more in.
// celltypes = ["Amacrine","Astrocyte","Bipolar","Cone","Endothelial","Horizontal","Microglia","Muller Glia","Pericyte","RGC","Rod","RPE"];

// logfcs cols: headings = ["Gene","Amacrine_1:EARLY","Amacrine_1:MID","Amacrine_1:LATE","Amacrine_2:EARLY","Amacrine_2:MID","Amacrine_2:LATE","Amacrine_3:EARLY","Amacrine_3:MID","Amacrine_3:LATE","Amacrine_4:EARLY","Amacrine_4:MID","Amacrine_4:LATE","Amacrine_5:EARLY","Amacrine_5:MID","Amacrine_5:LATE","Amacrine_6:EARLY","Amacrine_6:MID","Amacrine_6:LATE","Amacrine_7:EARLY","Amacrine_7:MID","Amacrine_7:LATE","Amacrine_8:EARLY","Amacrine_8:MID","Amacrine_8:LATE","Amacrine_9:EARLY","Amacrine_9:MID","Amacrine_9:LATE","Amacrine_10:EARLY","Amacrine_10:MID","Amacrine_10:LATE","Amacrine_11:EARLY","Amacrine_11:MID","Amacrine_11:LATE","Amacrine_12:EARLY","Amacrine_12:MID","Amacrine_12:LATE","Amacrine_13:EARLY","Amacrine_13:MID","Amacrine_13:LATE","Amacrine_14:EARLY","Amacrine_14:MID","Amacrine_14:LATE","Amacrine_15:EARLY","Amacrine_15:MID","Amacrine_15:LATE","Amacrine_16:EARLY","Amacrine_16:MID","Amacrine_16:LATE","Amacrine_17:EARLY","Amacrine_17:MID","Amacrine_17:LATE","Astrocyte:EARLY","Astrocyte:MID","Astrocyte:LATE","Bipolar_1:EARLY","Bipolar_1:MID","Bipolar_1:LATE","Bipolar_2:EARLY","Bipolar_2:MID","Bipolar_2:LATE","Bipolar_3:EARLY","Bipolar_3:MID","Bipolar_3:LATE","Bipolar_5:EARLY","Bipolar_5:MID","Bipolar_5:LATE","Bipolar_6:EARLY","Bipolar_6:MID","Bipolar_6:LATE","Bipolar_7:EARLY","Bipolar_7:MID","Bipolar_7:LATE","Bipolar_8:EARLY","Bipolar_8:MID","Bipolar_8:LATE","Bipolar_9:EARLY","Bipolar_9:MID","Bipolar_9:LATE","Bipolar_10:EARLY","Bipolar_10:MID","Bipolar_10:LATE","Bipolar_11:EARLY","Bipolar_11:MID","Bipolar_11:LATE","Bipolar_12:EARLY","Bipolar_12:MID","Bipolar_12:LATE","Bipolar_13:EARLY","Bipolar_13:MID","Bipolar_13:LATE","Bipolar_14:EARLY","Bipolar_14:MID","Bipolar_14:LATE","Bipolar_15:EARLY","Bipolar_15:MID","Bipolar_15:LATE","Bipolar_16:EARLY","Bipolar_16:MID","Bipolar_16:LATE","Bipolar_17:EARLY","Bipolar_17:MID","Bipolar_17:LATE","Bipolar_18:EARLY","Bipolar_18:MID","Bipolar_18:LATE","Bipolar_19:EARLY","Bipolar_19:MID","Bipolar_19:LATE","Bipolar_20:EARLY","Bipolar_20:MID","Bipolar_20:LATE","Bipolar_21:EARLY","Bipolar_21:MID","Bipolar_21:LATE","Bipolar_22:EARLY","Bipolar_22:MID","Bipolar_22:LATE","Bipolar_23:EARLY","Bipolar_23:MID","Bipolar_23:LATE","Bipolar_24:EARLY","Bipolar_24:MID","Bipolar_24:LATE","Bipolar_25:EARLY","Bipolar_25:MID","Bipolar_25:LATE","Cone_1:EARLY","Cone_1:MID","Cone_1:LATE","Cone_2:EARLY","Cone_2:MID","Cone_2:LATE","Cone_3:EARLY","Cone_3:MID","Cone_3:LATE","Endothelial:EARLY","Endothelial:MID","Endothelial:LATE","Horizontal:EARLY","Horizontal:MID","Horizontal:LATE","Microglia:EARLY","Microglia:MID","Microglia:LATE","Muller Glia_1:EARLY","Muller Glia_1:MID","Muller Glia_1:LATE","Muller Glia_2:EARLY","Muller Glia_2:MID","Muller Glia_2:LATE","Muller Glia_3:EARLY","Muller Glia_3:MID","Muller Glia_3:LATE","Muller Glia_4:EARLY","Muller Glia_4:MID","Muller Glia_4:LATE","Pericyte:EARLY","Pericyte:MID","Pericyte:LATE","RGC_1:EARLY","RGC_1:MID","RGC_1:LATE","RGC_2:EARLY","RGC_2:MID","RGC_2:LATE","RPE:EARLY","RPE:MID","RPE:LATE","Rod_1:EARLY","Rod_1:MID","Rod_1:LATE","Rod_2:EARLY","Rod_2:MID","Rod_2:LATE","Rod_3:EARLY","Rod_3:MID","Rod_3:LATE","Rod_4:EARLY","Rod_4:MID","Rod_4:LATE","Rod_5:EARLY","Rod_5:MID","Rod_5:LATE","Rod_6:EARLY","Rod_6:MID","Rod_6:LATE"];


//missing = ["RPE:EARLY","RPE:MID","RPE:LATE"];
// or: 
// missing = ["Amacrine_10:M","Bipolar_3:M","Bipolar_8:M","Bipolar_10:E","Bipolar_10:M","Bipolar_10:L","Bipolar_12:M","Bipolar_16:E","Bipolar_16:M","Bipolar_17:M","Bipolar_21:M","RGC_2:M","RPE:M","RPE:L"];
  

//  logfcs = [
// ["1190005I06Rik",0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
// or: 
// ["1110004F10Rik",0,0.5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
//];

//// var numcols=187, min = -7.100000, max = 4.600000;

function isOnLine() {
 return window.navigator.onLine;
}


function onLoadPage() { // Is called in the '<body ...> tag below using: onload="onLoadPage()" 
  // Get DeviceId:
  //if (typeof(Storage) === "undefined") return;  
  //device_id  = localStorage.getItem("{{ app }}_device_id");  if (device_id===null)  device_id ="";
  //device_key = localStorage.getItem("{{ app }}_device_key"); if (device_key===null) device_key="";

  //document.getElementById('cluster_type_in_title').innerHTML = FINE ? ' Fine ' : ' Coarse ';
  //show_heatmap_scale();
  //set_filter_menu_options();
  //show_heatmap();

  set_tooltip_click_outside_details_event();
  
  // Could give an optional 'url' param to data files on a webserver:
  var searchParams = new URLSearchParams(window.location.search),
      url_param = searchParams.get('url'),
      url_to_read_input = document.getElementById("url_to_read");

  if (url_param) url_to_read_input.value = url_param.trim();
  //alert("Set url_param="+url_param);

  enable_read_from_url_button(url_to_read_input); // Will always run this.

  if (url_param) url_to_read_clicked(); // So will load the heatmap without needing to click the button.
}





function onBeforeUnloadPage() {  // Can be called in the '<body ...> tag below using: onbeforeunload="return onBeforeUnloadPage();"
   //if (data_needs_saving()) {
   //    return "Do you really want to leave this Heatmap webpage?";   // Browsers give their own general message.
   //} else {
      return;
   //}
}


function guess_identifier_type_and_species(gene_id) {
  // Full regexp's for gene ids, eg: Ensembl: https://registry.identifiers.org/registry/ensembl
  var id_type = "GENE_SYMBOL"; // Default : Gene symbol (eg: VEGFA)
  if      (/^ENS[A-Z]{0,3}G\d+/.test(gene_id)) id_type = "ENSEMBL_GENE_ID"; // Ensembl Gene Id, (eg: ENSG00000112715 or: ENSMUSG00000023951)
  else if (/^ENS[A-Z]{0,3}T\d+/.test(gene_id)) id_type = "ENSEMBL_TRANSCRIPT_ID"; // Ensembl Transcript Id (eg: ENST00000672860.3 or ENSMUST00000142351.9)
  else if (/^ENS[A-Z]{0,3}P\d+/.test(gene_id)) id_type = "ENSEMBL_PROTEIN_ID"; // Ensembl Protein Id (eg: ENSP00000500082.3 or ENSMUSP00000115883.3)
  else if (             /^\d+$/.test(gene_id)) id_type = "ENTREZ_GENE_ID"; // Entrez Gene Id (eg: 7422)
//  else if (          /^[PQ]\d+/.test(gene_id)) id_type = "UNIPROT_ID"; // UniProt Protein Id (eg: P15692 or Q00731 or Q99PS1). 
  else if (/[OPQ][0-9][A-Z0-9]{3}[0-9]|[A-NR-Z][0-9]([A-Z][A-Z0-9]{2}[0-9]){1,2}/.test(gene_id)) id_type = "UNIPROT_ID"; // UniProt Protein Id (eg: P15692 or Q00731 or Q99PS1 or A0A023GPI8). This RegExp is from https://www.uniprot.org/help/accession_numbers
  
  document.getElementById("gene_symbol_type").value = id_type;
  //alert("guess_identifier_type_and_species("+gene_id+") = "+id_type);
}




function enable_sjb_tab(idfrom, idto, enable) {
  // eg: enable_sjb_tab('2','2',true);
  for (var id = idfrom; id <= idto; id++)
    document.getElementById("sjb_tab"+id).disabled = !enable;
}



function fold_change_or_pvalue_changed() {
  // NOT USED AS ALWAYS SHOWING P-VALUES IF AVAILABLE
  
  var fold_change_or_pvalue_select = document.getElementById("fold_change_or_pvalue_select");

  show_fold_change_or_pvalue = fold_change_or_pvalue_select.value; // Is global and is initialised above in var declaration to "fold_change", and title is also initialised to "Fold change" - alternatively call this fold_change_or_pvalue_changed() function in page onload?

  document.getElementById("fold_change_or_pvalue_title").innerHTML = fold_change_or_pvalue_select.text; // Intialised to Fold change. was: = (show_fold_change_or_pvalue === "fold_change") ? "Fold change" : "P-values for fold-change";

  alert("fold_change_or_pvalue_changed() to:"+show_fold_change_or_pvalue);
}


function other_organism_species_changed() {
  var tax_ensembl_gprofiler_ids = document.getElementById("other_organism_species").value.trim().split(':');

  if (tax_ensembl_gprofiler_ids.length !== 3) {
     taxid = ensembl_id = gprofiler_id = organism_text = ""; // Global variables.
     // alert("You need to enter other species in the format: 'tax_id : ensembl_name : gprofiler_organism_name' You have entered: "+tax_ensembl_gprofiler_ids); // Better to just give a message not an alert.
     set_stringdb_and_gprofiler_species_text("Select species details above");
     return;
     }

  // These are global variables:
  taxid         = tax_ensembl_gprofiler_ids[0].trim();
  ensembl_id    = tax_ensembl_gprofiler_ids[1].trim();
  gprofiler_id  = tax_ensembl_gprofiler_ids.length > 2 ? tax_ensembl_gprofiler_ids[2].trim() : ''; // some have no gprofiler_id, so split() doesn't include value after the last ':'
  organism_text = ensembl_id.split('_'); // Global

  set_stringdb_and_gprofiler_species_text(tax_ensembl_gprofiler_ids.join(' : '));
  enable_stringdb_buttons();
  enable_gprofiler_button();
  enable_david_button();
  
  console.log("other_organism_species_changed():  Taxid="+taxid+"    Ensembl_id="+ensembl_id+"   gProfiler_id="+gprofiler_id+"   Organism_text="+organism_text);
}


function organism_species_changed() {
  // Set organism for G:Profiler and StringDB
  var taxid_organism_elem       = document.getElementById("organism_species"),
      other_organism_div        = document.getElementById("other_organism_species_div"),
      tax_ensembl_gprofiler_ids = taxid_organism_elem.value.trim().split(':');

  taxid    = tax_ensembl_gprofiler_ids[0]; // This tax_id is a Global variable.

  if (taxid === "OTHER") { // taxid_organism is "OTHER:OTHER"
    other_organism_div.style.display = ''; // show the OTHER input box and label.
    other_organism_species_changed(); // As may have previously entered another organism.
  } else {
     other_organism_div.style.display = 'none'; // hide OTHER species input box.
     
     // Global variables:
     ensembl_id    = tax_ensembl_gprofiler_ids[1].trim();
     gprofiler_id  = tax_ensembl_gprofiler_ids.length > 2 ? tax_ensembl_gprofiler_ids[2].trim() : ''; // some have no gprofiler_id, so split() doesn't include value after the last ':'
     organism_text = taxid_organism_elem.text;
     
     set_stringdb_and_gprofiler_species_text(tax_ensembl_gprofiler_ids.join(' : '));
     enable_stringdb_buttons();
     enable_gprofiler_button();
     enable_david_button();
  }

  console.log("other_organism_species_changed():  Taxid="+taxid+"    Ensembl_id="+ensembl_id+"   gProfiler_id="+gprofiler_id+"   Organism_text="+organism_text);
}


function set_organism_species_selected(species_param) {
  var taxid_organism_elem = document.getElementById("organism_species"),
      other_organism_div  = document.getElementById("other_organism_species_div"),
      options             = taxid_organism_elem.options;

  if (options.length === 0) alert("set_organism_species_selected(): options.length is zero");

  var found = false;
  for (var i=0; i<options.length; i++) {
     if (options[i].value === species_param) {
       options[i].selected = true; // or: taxid_organism_elem.selectedIndex = i;
       found = true;
     }
  }

  if (!found) {
     taxid_organism_elem.value = "OTHER";
     other_organism_div.value = species_param;
  }

  organism_species_changed(); // This sets global vars and show/hides the 'other' input box, and calls other_organism_species_changed();
}



var fc_hue_factor_red, fc_hue_factor_blue; // set in show_heatmap_scale().  Also used in show_heatmap()

function hsl_color(fc) {
    // I changed so that, red is positive, blue is negative:
    // +3   : red    (hsl(  0, 100%, 50%))
    // >0   : yellow (hsl( 60, 100%, 50%))
    // 0    : green  (hsl(120, 100%, 50%))
    // <0   : cyan   (hsl(180, 100%, 50%))
    // -3   : blue   (hsl(240, 100%, 50%))

    var h;
    
    // if (fc == null) ....
    if (fc == 0) h = 120; // green.
    else if (fc > 0) h = Math.max(0, 60 - fc_hue_factor_red*fc); // the 15 assumes fc range 0 to +4, or 30 assumes fc range 0 to +2, 20 is fc range 0 to +3
    else h = Math.min(240, 180 - fc_hue_factor_blue*fc); // if (fc < 0)  // the 30 assumes fc range 0 to -2.  20 is fc range 0 to -3

    // could increase the 'L' to make the blue and yellow lighter near zero.
    var l = Math.round(90 - 40*Math.min(1,Math.abs(fc))); // so will be 60% at 1, 80% near zero, 
  // return [h,l]; // keeping s=100%
  // https://riptutorial.com/html5-canvas/example/13472/fillstyle--a-path-styling-attribute-
  return 'hsl('+h+', 100%, '+l+'%)';
}
 
function show_heatmap_scale() {
  var html = "";

  // or aim:  1.2 -> 2 and -1.2 -> -2
  //var fc_min_lower  = fc_min > 0 ? Math.ceil(fc_min) : Math.floor(fc_min),  // was -3 in test
  //    fc_max_higher = fc_max > 0 ? Math.ceil(fc_max) : Math.floor(fc_max),  // was +3 in test
  //    fc_step = 0.5;
  
  // We want to organise it so '0' is included when stepping below:
  if (fc_min > fc_max) {alert("ERROR: show_heatmap_scale(): fc_min="+fc_min+" > fc_max="+fc_max); return;}
  
  var fc_range = fc_max - fc_min; // range might even be zero.
  
  // BUT This isn't good for small ranges: 
  var fc_min_lower  = Math.floor(fc_min), // was -3 in test
      fc_max_higher = Math.ceil(fc_max);  // was +3 in test
  // if bpth are -0.17 then fc_min_lower = -1  fc_max_higher = -0

  var fc_step = (fc_max_higher)/6; // = 0/6
  var fc_step_temp = (-fc_min_lower)/6; // = 1/6
  if (fc_step_temp > fc_step) fc_step = fc_step_temp; // = 1/6
  if (fc_step === 0) alert("show_heatmap_scale(): fc_step="+fc_step+"  fc_step_temp="+fc_step_temp);

console.log("show_heatmap_scale(): fc_max:",fc_max, fc_max_higher, "  fc_min:", fc_min, "  fc_min_lower:",fc_min_lower,"  fc_max_higher:",fc_max_higher, "  (fc_max_higher - fc_min_lower)/12:",(fc_max_higher - fc_min_lower)/12, "  fc_step_temp:",fc_step_temp, "  fc_step:",fc_step);

  // Round the step:
  fc_step = (fc_step > 2) ? Math.round(fc_step) : (fc_step > 0.2) ? Math.round(10*fc_step)/10.0 : Math.round(100*fc_step)/100.0;  // was: 0.5

//alert("fc_step="+fc_step);

  // Math.floor(1.4)  gives: 1
  // Math.floor(-1.4) gives: -2

  // Math.ceil(1.4)   gives: 2
  // Math.ceil(-1.4)  gives: -1
  var fc_min_lower_minus_half_step = fc_min_lower  - 0.9*fc_step; // increasing min by half step as otherwise rounding error in fc_step means fc can be slightly larger than fc_min_lower eg. +000000.
  var fc_max_higher_plus_half_step = fc_max_higher + 0.9*fc_step; // increasing min by half step as otherwise rounding error in fc_step means fc can be slightly larger than fc_min_lower eg. +000000.

//console.log("show_heatmap_scale(): 1 : fc_min="+fc_min+"  fc_max="+fc_max+"  fc_min_lower="+fc_min_lower+"  fc_max_higher="+fc_max_higher+"  fc_step="+fc_step, "  fc_min_lower_minus_half_step=",fc_min_lower_minus_half_step,"  fc_max_higher_plus_half_step=",fc_max_higher_plus_half_step);

  var fc_list = [], fc;
  
  for (fc = 0; fc >= fc_min_lower_minus_half_step; fc -= fc_step) {console.log("fc="+fc," >= fc_min_lower_minus_half_step",fc_min_lower_minus_half_step); fc_list.push(fc);}
//console.log("show_heatmap_scale(): 1.1");

  fc_list.reverse(); // reverses and overwrites the original array, so most negative should be first in the new list.

  for (fc = 0; fc <= fc_max_higher_plus_half_step; fc += fc_step) if (fc !== 0) {console.log("fc="+fc); fc_list.push(fc);} // don't include zero twice.

//console.log("show_heatmap_scale(): 1.2");
  fc_hue_factor_red  = 60/fc_max_higher;
  fc_hue_factor_blue = -60/fc_min_lower; 
//console.log("show_heatmap_scale(): 1.3");
  // OLD: for (var fc = fc_min_lower; fc <= fc_max_higher; fc += fc_step) {
  for (var i=0; i<fc_list.length; i++) {
    var fc = fc_list[i];

    //if (fc == 0) html += '<td> &nbsp; 0 &nbsp; </td>';
    //else {
      // old: var h = (5 - fc)* 24;

//console.log("show_heatmap_scale",i,fc);

    var fc_rounded = Math.round(100*fc)/100; // to two decimal places.
    html += '<td style="background-color: '+hsl_color(fc_rounded)+';"> &nbsp; '+fc_rounded+' &nbsp; </td>';
    //}
  }
//console.log("show_heatmap_scale(): 2");
  document.getElementById("heatmap_scale_tbody").innerHTML = '<tr><td style="border:0;"><b>Heatmap log2fc colour scale:</b></td>'+html+'</tr>';

console.log("show_heatmap_scale(): finished");

}

 




var fc_amounts_options_signed = true;
function set_fc_amount_options_old() { // pre Aug 2023.
  var html = '<option value="Any" selected>Any fold-change</option>', i, val;

  if (fc_amounts_options_signed) {
  
    //for (var i=0; i<fc_amounts.length; i++) // Absolute 
    //  html += '<option value="a'+fc_amounts[i]+'">&ge;&plus;'+fc_amounts[i]+' or &le;&minus;'+fc_amounts[i]+'</option>\n'; // lowercase 'a' here for absolute,  as Any is uppercase a
    
    // for .. of ... in ES6+
    for (val of fc_amounts)
      html += '<option value="A'+val+'">&ge;&plus;'+val+' or &le;&minus;'+val+'</option>\n'; // uppercase 'A' here for absolute,  as Any is uppercase a
  
    //for (var i=0; i<fc_amounts.length; i++)
    //  html += '<option value="+'+fc_amounts[i]+'">&ge; &plus; '+fc_amounts[i]+'</option>\n';

    for (val of fc_amounts)
      html += '<option value="+'+val+'">&ge; &plus;'+val+'</option>\n';


    //for (var i=0; i<fc_amounts.length; i++)
    //  html += '<option value="-'+fc_amounts[i]+'">&le; &minus; '+fc_amounts[i]+'</option>\n';

    for (val of fc_amounts)
      html += '<option value="-'+val+'">&le; &minus;'+val+'</option>\n';

    document.getElementById('fc_more_or_less').style.display = 'none'; // hide the sign select

  } else {

    //for (var i=0; i<fc_amounts.length; i++)
    //  html += '<option value="'+fc_amounts[i]+'">'+fc_amounts[i]+'</option>\n';

    for (val of fc_amounts)
      html += '<option value="'+val+'">'+val+'</option>\n';

    document.getElementById('fc_more_or_less').style.display = '';  // show the sign select
  }

  document.getElementById('fc_amount').innerHTML = html;
}



// Alternative 

function set_fc_amount_options() {
  var i, val, html;

  html = '<optgroup label="Any fold-change ...">' +
         ' <option value="Any" selected>Any fold-change</option>' +
         '</optgroup>\n';

  html += '<optgroup label="fold-change &ge; &plus; ...">';
  for (val of fc_amounts)
    html += '<option value="+'+val+'">fold-change &ge; &plus;'+val+'</option>\n';
  /*
   <option value="+0.5">fold-change &ge; &plus;0.5</option>
   <option value="+1.0">fold-change &ge; &plus;1.0</option>
   <option value="+1.5">fold-change &ge; &plus;1.5</option>
   <option value="+2.0">fold-change &ge; &plus;2.0</option>
   <option value="+3.0">fold-change &ge; &plus;3.0</option>
   <option value="+4.0">fold-change &ge; &plus;4.0</option>
   <option value="+5.0">fold-change &ge; &plus;5.0</option>
  */
  html += '</optgroup>\n';
    
 
  html += '<optgroup label="fold-change &le; &minus; ...">\n';

  for (val of fc_amounts)
    html += '<option value="-'+val+'">fold-change &le; &minus;'+val+'</option>\n';
  /*
   <option value="-0.5">fold-change &le; &minus;0.5</option> 
   <option value="-1.0">fold-change &le; &minus;1.0</option>
   <option value="-1.5">fold-change &le; &minus;1.5</option>
   <option value="-2.0">fold-change &le; &minus;2.0</option>
   <option value="-3.0">fold-change &le; &minus;3.0</option>
   <option value="-4.0">fold-change &le; &minus;4.0</option>
   <option value="-5.0">fold-change &le; &minus;5.0</option>
  */ 
  html += '</optgroup>\n';  

  html += '<optgroup label="Absolute(fold-change) &ge; ...">\n';
  for (val of fc_amounts)
    html += '<option value="A'+val+'">Absolute(fold-change) &ge; '+val+' (ie. &ge;&plus;'+val+' or &le;&minus;'+val+')</option>\n'; // uppercase 'A' here for absolute > ...,  but Any is uppercase a
  /*
   <option value="A0.5">Absolute(fold-change) &ge; 0.5 (ie. &ge; &plus;0.5 OR &le; &minus;0.5)</option>
   <option value="A1.0">Absolute(fold-change) &ge; 1.0 (ie. &ge; &plus;1.0 OR &le; &minus;1.0)</option>
   <option value="A1.5">Absolute(fold-change) &ge; 1.5 (ie. &ge; &plus;1.5 OR &le; &minus;1.5)</option>
   <option value="A2.0">Absolute(fold-change) &ge; 2.0 (ie. &ge; &plus;2.0 OR &le; &minus;2.0)</option>
   <option value="A3.0">Absolute(fold-change) &ge; 3.0 (ie. &ge; &plus;3.0 OR &le; &minus;3.0)</option>
   <option value="A4.0">Absolute(fold-change) &ge; 4.0 (ie. &ge; &plus;4.0 OR &le; &minus;4.0)</option>
   <option value="A5.0">Absolute(fold-change) &ge; 5.0 (ie. &ge; &plus;5.0 OR &le; &minus;5.0)</option>
  */
  html += '</optgroup>\n';
  
  
  html += '<optgroup label="Absolute(fold-change) &le; ...">\n';
  for (val of [0.5,0.3,0.1,0.01])
    html += '<option value="a'+val+'">Absolute(fold-change) &le; '+val+' (ie. &le;&plus;'+val+' AND &ge;&minus;'+val+')</option>\n'; // lowercase 'a' here for absolute < ...,  but Any is uppercase a

  /*
   <option value="a0.5">Absolute(fold-change) &le; 0.5 (ie. &le; &plus;0.5 AND &ge; &minus;0.5)</option>
   <option value="a0.3">Absolute(fold-change) &le; 0.3 (ie. &le; &plus;0.3 AND &ge; &minus;0.3)</option>
   <option value="a0.1">Absolute(fold-change) &le; 0.1 (ie. &le; &plus;0.1 AND &ge; &minus;0.1)</option>
   <option value="a0.01">Absolute(fold-change) &le; 0.01 (ie. &le; &plus;0.01 AND &ge; &minus;0.01)</option>
  */
  html += '</optgroup>\n';
  
  document.getElementById('fc_amount').innerHTML = html;
}




function show_pvalue_select_on_filter(show) {
  document.getElementById("pvalue_less_than_label").style.display = document.getElementById("pvalue_less_than").style.display = document.getElementById("p_show_all_pvalues_in_row").style.display = show ? '' : 'none';
  document.getElementById("pvalue_less_than_message").innerHTML = show ? '' : 'Cannot filter on p-value as the Input data has no p-value/FDR/q-value columns defined, which is okay.';
}


function hide_show_celltype_times_checkboxes() {
  var fc_amount = document.getElementById('fc_amount').value,
      pv_less_than    = document.getElementById('pvalue_less_than').value;      
  document.getElementById('fc_separate_celltype_times_checkboxes_fieldset').style.display = (fc_amount === 'Any' && pv_less_than === 'Any') ? 'none' : '';
}


function fc_amount_changed() {
  hide_show_celltype_times_checkboxes();
  show_heatmap();
}

function pvalue_less_than_changed() {
  hide_show_all_pvalues();
  hide_show_celltype_times_checkboxes();
  show_heatmap();
}


/*
Not used:
function clickCheckbox(id_cb) {
  document.getElementById(id_cb).click();
}
*/

function set_fc_in_celltype_options() {
  var html = '<option value="Any" selected>Any</option>\n<option value="All">All</option>', val;
//  for (var i=0; i<celltypes.length; i++) 
//    html += '<option value="'+celltypes[i]+'">'+celltypes[i]+'</option>\n';

  for (val of celltypes)
    html += '<option value="'+val+'">'+val+'</option>\n';

  var e = document.getElementById('fc_in_celltype');
  e.innerHTML = html;
  e.size = celltypes.length+2; // +2 for All and Any
}



function set_fc_at_time_options() {
  var html = '<option value="Any" selected>Any</option>\n<option value="All">All</option>', val;

//  for (var i=0; i<times.length; i++)
//    html += '<option value="'+times[i]+'">'+times[i]+'</option>\n';
  for (val of times)
    html += '<option value="'+val+'">'+val+'</option>\n';

    // eg: <option value="EARLY">EARLY</option>
  
  var e = document.getElementById('fc_at_time');
  e.innerHTML = html;
  e.size = times.length+1; // +2 for All and Any
}



function checkIntermediateBoxes(id_prefix, cb1,cb2) {
  var i1 = Number(cb1.id.substring(id_prefix.length)),
      i2 = Number(cb2.id.substring(id_prefix.length));
  if (i1 > i2) {var temp=i1; i1=i2; i2=temp;} // sawp first and second order. 
  for (var i = i1+1; i < i2; i++) { // correctly i1 +1 to < i2
    var cb = document.getElementById(id_prefix+i);
    cb.checked = cb1.checked;
    cb.indeterminate = false;
  }
  cb2.checked = cb1.checked; // correctly using i<i2 above then setting cb2 separately here as when cb1 (clicked first) is below cb2 in checkbox list.
}

function enable_all_none_checkbox_buttons(checkboxes_name) {
  var all_none_checked = all_or_none_CheckboxChecked(checkboxes_name);
  //alert("enable_all_none_checkbox_buttons(): "+checkboxes_name+'_all_button  all_none_checked='+all_none_checked);
  document.getElementById(checkboxes_name+'_all_button').disabled = all_none_checked === 'all';
  document.getElementById(checkboxes_name+'_none_button').disabled = all_none_checked === 'none';
}


var celltype_lastChecked;
function fc_in_celltype_checkbox_clicked(this_cb, event) {
  event.stopPropagation(); // To enable clicking on the table cell and on checkbox this is needed. Also to prevent the label propagating to cell the label has inline onclick="event.stopPropagation();"
  // event.stopImmediatePropagation();
  // alert("celltype_checkbox_clicked() cb="+this_cb);
  if (typeof this_cb === 'string') {this_cb = document.getElementById(this_cb); this_cb.checked = !this_cb.checked;} // As on clicking the table cell I send the cb id string. 
  if (event.shiftKey && this_cb != celltype_lastChecked) {
    checkIntermediateBoxes('fc_in_celltype_cb_', celltype_lastChecked, this_cb);
  }
  celltype_lastChecked = this_cb;
  enable_all_none_checkbox_buttons('fc_in_celltype_checkboxes');
  set_head_checkboxes_to_match_celltype_time_checkboxes();
  show_heatmap();
  // return false; false would prevent the checkbox checked stae changing.
}

var time_lastChecked;
function fc_at_time_checkbox_clicked(this_cb, event) {
  event.stopPropagation(); // To enable clicking on the table cell and on checkbox this is needed. Also to prevent the label propagating to cell the label has inline onclick="event.stopPropagation();"
  // event.stopImmediatePropagation();
  // alert("time_checkbox_clicked() cb="+this_cb);

  // "Say you have multiple events on the same element. If you use event.stopPropagation(), sure it will stop any parent events from firing. But if you have multiple events on the same element, they will still all fire.
  // To prevent other events on the same element from firing, use event.stopImmediatePropagation() instead. It will stop both parents and the same element events from firing.
  // If you are in a situation where event.stopPropagation() doesn’t work for you, try event.stopImmediatePropagation() instead.
  if (typeof this_cb === 'string') {this_cb = document.getElementById(this_cb); this_cb.checked = !this_cb.checked;} // As on clicking the table cell I send the cb id string. 
  if (event.shiftKey && this_cb != time_lastChecked) {
    checkIntermediateBoxes('fc_at_time_cb_', time_lastChecked, this_cb);
  }
  time_lastChecked = this_cb;
  enable_all_none_checkbox_buttons('fc_at_time_checkboxes');
  set_head_checkboxes_to_match_celltype_time_checkboxes();
  /*
  var fc_in_celltypes = getSelectedCheckboxValues('fc_in_celltype_checkboxes'), // WAS: getSelectedValues( document.getElementById('fc_in_celltype') ),
      fc_at_times     = getSelectedCheckboxValues('fc_at_time_checkboxes'),     // WAS: getSelectedValues( document.getElementById('fc_at_time') ),
      fc_in_celltype_and_time = getSelectedCheckboxValues('fc_in_celltype_and_time_checkboxes'), // <-- this is numbers (the indexes of the head1[] array) as strings. Added 19 Aug 2023.
      k = fc_in_celltypes_and_times_to_head_index_array(fc_in_celltypes, fc_at_times); // 19 Aug 2023
  console.log("fc_at_time_checkbox_clicked()  fc_in_celltypes:", fc_in_celltypes, "  fc_at_times:",fc_at_times, "  k:",k, "  fc_in_celltype_and_time:",fc_in_celltype_and_time);
  */
  show_heatmap();
  // return false; // if I used onclick="return fc_at_time_checkbox_clicked(this,event);">' (ie. onclick="return...", then returning false would prevent the checkbox checked stae changing.
}

function set_fc_in_celltype_checkboxes() {
  var html = '';
  for (var j=0; j<celltypes.length; j++) { // j correctly starts at zero here.  Default td padding is padding: 5px 10px;
    html += ' <tr><td style="text-align:left; border-radius:0; padding: 3px 5px;" onclick="fc_in_celltype_checkbox_clicked( \'fc_in_celltype_cb_'+j+'\',event);">\n' +
            '  <input type="checkbox" id="fc_in_celltype_cb_'+j+'" name="fc_in_celltype_checkboxes" value="'+celltypes[j]+'" checked onclick="fc_in_celltype_checkbox_clicked(this,event);">' +
            '<label for="fc_in_celltype_cb_'+j+'" onclick="event.stopPropagation();" style="user-select:none; cursor:pointer;">'+celltypes[j]+'</label>' +
            ' </td></tr>\n';
  }
  document.getElementById('celltypes_tbody').innerHTML = html;
  enable_all_none_checkbox_buttons('fc_in_celltype_checkboxes');
}

function set_fc_at_time_checkboxes() {
  var html = '';
  for (var j=0; j<times.length; j++) { // j correctly starts at zero here.  Default td padding is padding: 5px 10px;
    html += ' <tr><td style="text-align:left; border-radius:0; padding: 3px 5px;" onclick="fc_at_time_checkbox_clicked( \'fc_at_time_cb_'+j+'\', event);">\n' +
            '  <input type="checkbox" id="fc_at_time_cb_'+j+'" name="fc_at_time_checkboxes" value="'+times[j]+'" checked onclick="fc_at_time_checkbox_clicked(this,event);">' +
            '<label for="fc_at_time_cb_'+j+'" onclick="event.stopPropagation();" style="user-select:none; cursor:pointer;">'+times[j]+'</label>\n' +
            ' </td></tr>\n';
  }
  document.getElementById('times_tbody').innerHTML = html;
  enable_all_none_checkbox_buttons('fc_at_time_checkboxes');
}


function set_celltype_time_checkboxes_to_match_head_checkboxes() {
  // There's probably an shorter way to do this:
  
  // 'i'; // for indeterminate.
  // 'c'; // for checked.
  // 'n'; // for not checked.

  // Using these arrays as dict with empty head2 key could cause a problem.
  var celltypes_checked = new Array(celltypes.length),
      times_checked     = new Array(times.length);

  for (var j=1; j<head1.length; j++) { // correctly j=1 as head starts at 'Gene' at j=0
    var elem = document.getElementById('fc_in_celltype_and_time_cb_'+j),
        checked = elem.checked ? 'c' : 'n',
        pos1 = celltypes.indexOf(head1[j]),
        pos2 = times.indexOf(head2[j]);

  //console.log("checked:",checked,"  pos1:",pos1," pos2:",pos2,"  celltypes_checked[pos1]=",celltypes_checked[pos1], "  times_checked[pos2]=",times_checked[pos2]);

    // if (head1[j]+' : '+head2[j] !== elem.text) {alert("ERROR: Mismatch j="+j+" : head1[j]+' : '+head2[j]="+head1[j]+' : '+head2[j]+"  !==  elem.text="+elem.text); return false;}

    if (elem.value !== j.toString()) {alert("ERROR: Mismatch j="+j+"  !==  elem.value="+elem.value); return false;}

    if (pos1 === -1 || pos2 === -1) {alert("ERROR: pos1 === -1 || pos2 === -1"); return false;}

    if (typeof celltypes_checked[pos1] === 'undefined') celltypes_checked[pos1] = checked;
    else if (celltypes_checked[pos1] !== checked && celltypes_checked[pos1] !== 'i') celltypes_checked[pos1] = 'i'; // for indeterminate.

    if (typeof times_checked[pos2] === 'undefined') times_checked[pos2] = checked;
    else if (times_checked[pos2] !== checked && times_checked[pos2] !== 'i') times_checked[pos2] = 'i'; // for indeterminate.
  }
  //console.log("celltypes:",celltypes," celltypes_checked:",celltypes_checked);
  //console.log("times:",times," times_checked:",times_checked);

  // Now set the celltypes checkboxes to match: 
  for (j=0; j<celltypes.length; j++) { // correctly j=0
     elem = document.getElementById('fc_in_celltype_cb_'+j);
     if (celltypes[j] !== elem.value) {alert("ERROR: Mismatch j="+j+" : celltypes[j]="+celltypes[j]+"  !==  elem.value="+elem.value); return false;}
     checked = celltypes_checked[j];
     elem.indeterminate = (checked === 'i');
     elem.checked = (checked === 'c'); // if 'i' set to unchecked so clicking will make it checked.   || checked === 'i'); // set indefinite as checked but I could be set to unchecked.
  }

  // Now set the times checkboxes to match: 
  for (j=0; j<times.length; j++) { // correctly j=0
     elem = document.getElementById('fc_at_time_cb_'+j);
     if (times[j] !== elem.value) {alert("ERROR: Mismatch j="+j+" : times[j]="+times[j]+"  !==  elem.value="+elem.value); return false;}
     checked = times_checked[j];
     elem.indeterminate = (checked === 'i');
     elem.checked = (checked === 'c'); // if 'i' set to unchecked so clicking will make it checked.   || checked === 'i'); // set indefinite as checked but I could be set to unchecked.
  }

  enable_all_none_checkbox_buttons('fc_in_celltype_checkboxes');
  enable_all_none_checkbox_buttons('fc_at_time_checkboxes');

  return true;
}


function set_head_checkboxes_to_match_celltype_time_checkboxes() {
  // This is the reverse of the above.
  
  for (var j=1; j<head1.length; j++) { // correctly j=1 as head starts at 'Gene' at j=0
     var pos1 = celltypes.indexOf(head1[j]),
         pos2 = times.indexOf(head2[j]);

     if (pos1 === -1 || pos2 === -1) {alert("ERROR: pos1 === -1 || pos2 === -1"); return false;}

     var celltype_elem = document.getElementById('fc_in_celltype_cb_'+pos1),
         time_elem     = document.getElementById('fc_at_time_cb_'+pos2);

     if (celltype_elem.indeterminate || time_elem.indeterminate) continue; // as we don't if elem should checked or unchecked.

     var elem = document.getElementById('fc_in_celltype_and_time_cb_'+j),
         checked = celltype_elem.checked && time_elem.checked; // both the celltype and time need to be checked.

     if (elem.value !== j.toString()) {alert("ERROR: Mismatch j="+j+"  !==  elem.value="+elem.value); return false;}
         
     if (elem.checked !== checked) elem.checked = checked;
  }

  enable_all_none_checkbox_buttons('fc_in_celltype_and_time_checkboxes');

  return true;
}



// checkbox_elem1.indeterminate = true;  // can set this indeterminate property via JavaScript (it cannot be set using an HTML attribute):





var celltype_and_time_lastChecked;
function fc_in_celltype_and_time_checkbox_clicked(this_cb, event) {
  event.stopPropagation(); // To enable clicking on the table cell and on checkbox this is needed. Also to prevent the label propagating to cell the label has inline onclick="event.stopPropagation();"
  // event.stopImmediatePropagation();
  if (typeof this_cb === 'string') {this_cb = document.getElementById(this_cb); this_cb.checked = !this_cb.checked;} // As on clicking the table cell I send the cb id string. 
  // If you are in a situation where event.stopPropagation()doesn’t work for you, try event.stopImmediatePropagation()instead.
  if (event.shiftKey && this_cb != celltype_and_time_lastChecked) {
    checkIntermediateBoxes('fc_in_celltype_and_time_cb_', celltype_and_time_lastChecked, this_cb);
  }
  celltype_and_time_lastChecked = this_cb;
  enable_all_none_checkbox_buttons('fc_in_celltype_and_time_checkboxes');
  set_celltype_time_checkboxes_to_match_head_checkboxes();
  show_heatmap();
  // return false; false would prevent the checkbox checked stae changing.
} 

function set_fc_in_celltype_and_time_checkboxes() {
  var html = "";
  for (var j=1; j<head1.length; j++) {
    // <tr><td ... onclick="fc_in_celltype_and_time_checkbox_clicked(\'fc_in_celltype_and_time_cb_'+j+'\') 
    html += ' <input type="checkbox" id="fc_in_celltype_and_time_cb_'+j+'" name="fc_in_celltype_and_time_checkboxes" value="'+j+'" checked onclick="fc_in_celltype_and_time_checkbox_clicked(this,event);">' +
            '<label for="fc_in_celltype_and_time_cb_'+j+'" onclick="event.stopPropagation();" style="user-select:none; cursor:pointer;">'+head1[j]+' : '+head2[j]+'</label><br>\n';
  
  }  // or should I use 'onchange=' instead of onclick=...
  document.getElementById("fc_in_celltype_and_time_checkboxes_td").innerHTML = html;
  enable_all_none_checkbox_buttons('fc_in_celltype_and_time_checkboxes');
}



/*
OLD:
function set_min_num_fc_for_gene2_options() {

  var html = '<optgroup id="noneOptGroup" label="No columns...">\n' +
             ' <option value="none" selected>No column</option>\n';

  html += '<optgroup id="anyOptGroup" label="Any columns...">\n' +
          ' <option value="any1" selected>Any 1 column</option>\n';
  for (var j=2; j<head1.length-1; j++) html += ' <option value="any'+j+'">Any '+j+' columns</option>\n'; // eg: <option value="any2">Any 2 columns</option>
  html += '</optgroup>\n';
  // head1[0] is Gene column.
  // j<head1.length-1 as j<=head1.length-1 would give ALL columns which is ALL columns below.

  html += '<optgroup id="allOptGroup" label="All columns:">\n' + 
          ' <option value="all">ALL '+(head1.length-1)+' columns</option>\n' +
          '</optgroup>\n';

  html += '<optgroup id="anySelectedOptGroup" label="Selected column(s)...">\n' +
          ' <option value="selectedAny1">Any 1 of the column(s) that I select (eg: column2 OR column3 OR column4)</option>\n';
  for (var j=2; j<head1.length-1; j++) html += ' <option value="selectedAny'+j+'">Any '+j+' of the column(s) that I select (eg: [column2 AND column3] OR [column2 AND column4] ...)</option>\n'; // eg: <option value="selectedAny2">Any 2 of the column(s) that I select (eg: column2 AND column3)</option>
  // head1[0] is Gene column.
  // j<head1.length-1 as j<=head1.length-1 would give ALL columns which is ALL columns below.
  html += '</optgroup>\n';
  
  // <option value="selectedAny2">Any 2 of the column(s) that I select (eg: column2 AND column3)</option>
  // <option value="selectedAny3">Any 3 of the column(s) that I select (eg: column2 AND column3 AND column4)</option>

  html += '<optgroup id="allSelectedOptGroup" label="All Selected column(s)...">\n' +
          ' <option value="selectedAll">ALL of the column(s) that I select (eg: column2 AND column3 AND column4 ....)</option>\n' + // '+(head1.length-1)+
          '</optgroup>\n';

  var e = document.getElementById('min_num_fc_for_gene2');
  e.innerHTML = html;
}
*/



function set_min_num_fc_for_gene2_options() {

  var html = ' <option value="any1" selected>Any 1 column of my selected \'Heatmap columns\' below</option>\n';

  for (var j=2; j<head1.length-1; j++) html += ' <option value="any'+j+'">Any '+j+' columns of my selected \'Heatmap columns\' below</option>\n'; // eg: <option value="any2">Any 2 columns</option>
  // head1[0] is Gene column.
  // j<head1.length-1 as j<=head1.length-1 would give ALL columns which is ALL columns below.

  html += ' <option value="all">ALL my selected \'Heatmap columns\' below</option>\n'; // '+(head1.length-1)+'

  var e = document.getElementById('min_num_fc_for_gene2');
  e.innerHTML = html;
}


function show_celltype_times_checkboxes_fieldset(single_or_separate) {
  document.getElementById('fc_single_celltype_times_checkboxes_fieldset').style.display = single_or_separate === 'single' ? '' : 'none';
  document.getElementById('fc_separate_celltype_times_checkboxes_fieldset').style.display = single_or_separate !== 'single' ? '' : 'none'; // to show.

  document.getElementById('show_fc_single_celltype_times_checkboxes_fieldset_button').style.display = single_or_separate !== 'single' ? '' : 'none';
  document.getElementById('show_fc_separate_celltype_times_checkboxes_fieldset_button').style.display = single_or_separate === 'single' ? '' : 'none';
}


function set_filter_menu_options() {

console.log("set_filter_menu_options():",celltypes,times);

  //alert("set_filter_menu_options");

  set_fc_amount_options();
  show_pvalue_select_on_filter(logpvs.length > 1 && has_pvalues_columns); // probably just need to test logpvs.length > 1 without the has_pvalues_columns.
  set_fc_in_celltype_options();
  set_fc_at_time_options();
  set_fc_in_celltype_and_time_checkboxes();
  set_fc_in_celltype_checkboxes();
  set_fc_at_time_checkboxes();
  

  // show_celltype_times_checkboxes_fieldset('separate'); // Not needed now as showing both together.


  set_min_num_fc_for_gene2_options();

console.log("set_filter_menu_options():","C");
  
  var select_elem = document.getElementById("pvalue_less_than");
  var msg_elem = document.getElementById("pvalue_less_than_message");

  // select_elem.value = "Any";
  select_elem.value = "0.5"; // To reduce time to first display the heatmap.
  
  if (logpvs.length>1) { // as logpvs will always have one heading row.
    select_elem.disabled = false;
     msg_elem.innerHTML =  " for the fold-change(s)"; // msg_elem.innerHTML = " for at least one <i>p</i>-value in the row.";
  }
  else {
    select_elem.disabled = true;
    msg_elem.innerHTML = " No <i>p</i>-values were read from file(s) for this data.";
  }

  document.getElementById("logsort_select").value = 'none';

  hide_show_all_pvalues();
console.log("set_filter_menu_options():","finished");
}


function hide_show_all_pvalues() {
  var hide = document.getElementById("pvalue_less_than").value === "Any";
  document.getElementById("p_show_all_pvalues_in_row").style.display = hide ? 'none' : '';
}



function show_hide_pct12_columns_checkbox(show) {
  // Called after the dat ahs been read from input files, so has_pct12_columns is set.
  document.getElementById("p_show_pct12_values").style.display = show && has_pct12_columns ? '' : 'none';  
  if (!show) document.getElementById("show_pct12_values").checked = false; // Don't change to false when showing after updating the heatmap table, only when hiding.
}

function show_hide_pvalue_columns_checkbox(show) {
  // Called after the dat ahs been read from input files, so has_pct12_columns is set.
  document.getElementById("p_show_pvalues").style.display = show && has_pvalues_columns ? '' : 'none';  
  if (!show) document.getElementById("show_pvalues").checked = has_pvalues_columns; // Don't change to false when showing after updating the heatmap table, only when hiding.
}


//function show_sort_order_checkbox(show) {
//  document.getElementById("p_show_sort_order").style.display = show && has_pvalues_columns ? '' : 'none';  
//}

function show_hide_download_single_data_file_link(show) {
  document.getElementById('download_single_data_file_link_p').style.display = show ? '' : 'none'; 
}

function show_tool_tables(show) { 
  var display = show ? '' : 'none'; 

  document.getElementById('filter_heatmap_table').style.display = display; // To show the filtering box.
  document.getElementById('display_options_table').style.display = display; 
  /*
  document.getElementById('selected_genes_table').style.display = display; // To show the selected genes box.
  document.getElementById('copy_selected_genes_table').style.display = display; 
  document.getElementById('stringdb_table').style.display = display; // To show the top of the stringdb table.
  document.getElementById('gprofiler_table').style.display = display; 
  document.getElementById('david_table').style.display = display; 
  document.getElementById('heatmap_image_table').style.display = display;    
  */

  var tool_tables = document.getElementsByClassName("tool_table");
  // console.log("tool_tables:",tool_tables);

  for (var i = 0; i < tool_tables.length; i++)
     tool_tables[i].style.display = display;
  
//  OR:  for (var val of tool_tables)
//     tool_tables[i].style.display = display;
// BUT is val a copy or pont to the original?
  
  document.getElementById('filter_heatmap_table_instructions').style.display = display;

  clear_and_shrink_canvas();
  clear_heatmap_show_image_size();
  show_hide_pvalue_columns_checkbox(show);
  show_hide_pct12_columns_checkbox(show);
}




var timer1=null;


function show_heatmap_with_column_names_and_types() {

  if (num_files === 1) {if (!parse_single_non_hive_file_after_column_headings_assigned()) return false;}

  else if (!parse_multiple_files_after_column_headings_assigned()) {return false;}
  
  disable_heatmap_with_column_names_and_types_button(true);

  // Not resetting sort order here: sort_data(null);

  show_heatmap();
  // disable_heatmap_with_column_names_and_types_button(false); // is reenabled in the timeout of show_heatmap() 

  set_select_ids_species_columns_tab_color('');  // to reset tab to normal color.
}



function disable_heatmap_with_column_names_and_types_button(disable) {
  document.getElementById("show_heatmap_with_column_names_and_types_button").disabled = disable;
}


function show_heatmap() {
  if (timer1) {clearTimeout(timer1); timer1 = null;}

  selected_gene_list = []; // to clear the list.
  
  filtered_row_list = []; // to clear the list.

  //alert("show_heatmap 1");
  enable_stringdb_buttons(true); // so disabled is true here as no genes selected.
  //alert("show_heatmap 2");

  enable_gprofiler_button();
  enable_david_button();
  enable_copy_genelist_buttons();

  show_selected_genes(); // to clear the displayed list.
  remove_stringdb_image();

  show_filter_heatmap_message("<b><i>Updating heatmap ...</i></b>",'green');

  show_display_options_message("<b><i>Updating heatmap ...</i></b>",'green');


  // Using this setTimeout so that the above message is displayed, before running the following. Works in Chrome, but doesn't work in Firefox.
  // The setTimeout() method calls a function after a number of milliseconds.
  timer1 = setTimeout(function() {
    if (!show_heatmap_thead()) {disable_heatmap_with_column_names_and_types_button(false); console.log("ERROR: Failed to show_heatmap_thead();"); return false;} // Need to redraw the thead here as otherwise it appears with some cell borders white.
    if (!show_heatmap_tbody()) {disable_heatmap_with_column_names_and_types_button(false); console.log("ERROR: Failed to show_heatmap_tbody();"); return false;}
    
    show_tool_tables(true);

    // show_hide_table_row('input_data_parameters',false); // false to hide table as finished with it now
    enable_sjb_tab(3, 10, true); // To enable tabs 3 to 10: - for non-HIVE files, not showing Display options until here after user sets column names & types and heatmap. 
      // 3 = 'Display options' tab.  
      // 4 = 'Filter rows' tab.
      // 5 = 'Selected genes' tab.
      // 6 = 'g:Profiler' tab.
      // 7 = 'STRING' tab.
      // 8 = 'DAVID' tab.
      // 9 = 'Heatmap image' tab.
      // 10 = 'UpSet/Vein' tab.

//alert("show_heatmap(): E");  

    //show_num_filtered_rows(...); // is called in show_heatmap_thead() above
    
    show_validate_input_data_parameters_message('<b>The heatmap is displayed below</b>.', 'green'); // don't add teh +tab_instructions here as +tab_instructions is displayed in 'loading_heatmap_message' just below this.
    // show_validate_input_data_parameters_message('<b>Column headings and data were read okay.</b>.', 'green'); // don't add the +tab_instructions here as +tab_instructions is displayed in 'loading_heatmap_message' just below this.
    
    timer1 = null;
//alert("show_heatmap(): F");  
  }, 10); // end of the setTimeout(

}


function show_heatmap_thead() {
  // 'cols' is array of: ["Amacrine:EARLY", "....", .... ]  
  var html1 = '', html2=''; // top row of celltypes with colspan 3, then second row of times:EARLY/MID/LATE
  // var colspan = 0;

  /*
  for (var i=0; i<celltypes.length; i++) { // The first in the array is no-longer "Gene" here, but is stil genename in the logfcs array.
    if (html1 != '') html1 += '</th>';
    html1 += '<th colspan="3" style="border-bottom: 0; border-left: 2px solid black; border-right: 2px solid black;">' + celltypes[i].replace('_',' '); // so FINE number goes on second line to fit more into width of browser.

    for (var t=0; t<times.length; t++) { 
      //console.log(celltypes[i]+':'+times[t]);
      var style = (t==0) ? ' border-left: 2px solid black;' : ''; // not border-right: 2px solid black; here.
      //if (missing.indexOf(celltypes[i]+':'+times[t]) != -1) alert("Found missing: "+celltypes[i]+':'+times[t]);
      style += (missing.indexOf(celltypes[i]+':'+times[t]) != -1) ? ' color:#a0a0a0;' : ''; // gray M for eg: "Amacrine_10:MID"
      if (times[t]=='EARLY') style += ' font-size:90%;'; // so columns are similar widths.
      html2 += '<th style="border-top: 0;'+style+'">'+times[t]+'</th>';
    }
  }
  */

  // I could use this same logic to draw the header row in heatmap image download:
  var head1_last = null, head1_colspan, head2_style;
  if (head1.length != head2.length) {alert("show_heatmap_thead(): head1.length != head2.length"); show_reading_and_loading_messages("head1.length != head2.length", 'red'); return false;} // shouldn't ever happen anyway.

  // for (var i=1; i<head1.length; i++) console.log("i=",i,"  head1=",head1[i],"  head2=",head2[i]);


  for (var i=1; i<=head1.length; i++) { // The first in the array is "Gene" here, but is still genename in the logfcs array.
    // Note the 'i<=' is to be sure to use the final head1_last column, then calls break before access head1[i]
  // for (var val of head1) { // The first in the array is "Gene" here, but is still genename in the logfcs array.

    if (i==head1.length || head1[i] !== head1_last) {
      if (head1_last !== null) html1 += '<th colspan="'+head1_colspan+'" style="border-bottom: 0; border-left: 2px solid black; border-right: 2px solid black;">' + head1_last + '</th>'; // so FINE number goes on second line to fit more into width of browser.
      if (i==head1.length) break;
      head1_last = head1[i]; // to use for the next heading cell.
      head1_colspan = 1;

      head2_style = ' border-left: 2px solid black;'; // not border-right: 2px solid black; here.            
    } else {
      head1_colspan++;
      head2_style = '';
    }
    // if (missing.indexOf(celltypes[i]+':'+times[t]) != -1) alert("Found missing: "+celltypes[i]+':'+times[t]);
    // head2_style += (missing.indexOf(celltypes[i]+':'+times[t]) != -1) ? ' color:#a0a0a0;' : ''; // gray M for eg: "Amacrine_10:MID"

    if ( (i+1)>=head1.length || head1[i] !== head1[i+1]) head2_style += ' border-right: 2px solid black;'; // not border-right: 2px solid black; here.

    if (num_fc_in_cols[i]==0) head2_style += ' color:#a0a0a0;'; // gray M for eg: "Amacrine_10:MID"
    if (head2[i].length > 3)  head2_style += ' font-size:85%;'; // so columns are similar widths, eg: 'EARLY'.

    html2 += '<th style="border-top: 0;'+head2_style+'">'+head2[i]+'</th>';
  }

  var select_all_none_buttons = '<button onclick="select_genes(\'all\');">All</button><br><button onclick="select_genes(\'none\');">None</button>';
  document.getElementById('heatmap_thead').innerHTML = '<tr><th rowspan="2">'+select_all_none_buttons+'</th><th rowspan="2"><label id="genename_or_protein_heading" for="filter_genes_input_text">'+head1[0]+'</label> <span id="genename_filtering_progress" style="font-size:75%;"></span><br><input type="search" id="filter_genes_input_text" size="12" oninput="filter_genes_by_name();"></th>'+html1+'<th rowspan="2" style="border-left: 2px solid black;">'+head1[0]+'</th></tr>\n<tr>'+html2+'</tr>'; // head1[0] will be 'Gene' or 'Genename'

  return true;
}



function getSelectedValues(selectElem) {
  var options = selectElem.options, result = [];

  for (var i=0; i<options.length; i++) {
    if (options[i].selected) result.push(options[i].value);
  }
  // Note that when there is no value attribute, then opt.value = opt.text.
  return result;

  // Or use the newer selectedOptions:
  // return Array.from(selectElem.selectedOptions).map(({ value }) => value);
}


function getSelectedCheckboxValues(checkboxesName) {
  var checkboxes = document.getElementsByName(checkboxesName), result = [];
  // or: var checkboxes = document.querySelectorAll('input[name="'+checkboxesName+'"]:checked'); // querySelectorAll() returns a NodeList 
  // for (var i=0; i<checkboxes.length; i++) result.push(checkboxes[i].value);
  // for (var cb of checkboxes.values()) result.push(cb.value);
  // for (var cb of checkboxes) result.push(cb.value);
    
  for (var i=0; i<checkboxes.length; i++) {
    if (checkboxes[i].checked) result.push(checkboxes[i].value);
  }
  // Note that when there is no value attribute, then opt.value = opt.text.
  return result;

  // Or use the newer selectedOptions:
  // return Array.from(selectElem.selectedOptions).map(({ value }) => value);
}

function numCheckboxChecked(checkboxesName) {
  var checkboxes = document.getElementsByName(checkboxesName), count=0;
  // return document.querySelectorAll('input[name="'+checkboxesName+'"]:checked').length; // querySelectorAll() returns a NodeList 

  for (var i=0; i<checkboxes.length; i++) if (checkboxes[i].checked) count++;

  // Note that when there is no value attribute, then opt.value = opt.text.
  return count;
}

function all_or_none_CheckboxChecked(checkboxesName) {
  var checkboxes = document.getElementsByName(checkboxesName), count=0;
  for (var i=0; i<checkboxes.length; i++) if (checkboxes[i].checked) count++;
  if (count === 0) return 'none';
  if (count === checkboxes.length) return 'all';
  return count; // is int.
}


/*
Ripb1 - good marker for the cluster of 
Too few endothelial cells.
*/

function set_gene_link(this_link, genename) {
  
  var gene_symbol_type = document.getElementById('gene_symbol_type').value; // Not used here for stringdb
  if (gene_symbol_type === "") {alert("Please select the Gene/Protein symbol type using the drop-down menu near the top of this HIVE webpage."); this_link.target="_self"; this_link.href="#gene_symbol_type"; return false;}
  // Need to set this_link.target=""; otherwise will open a new empty tab above.
  
// eg: 
// <option value="ENSEMBL_GENE_ID">Ensembl Gene Id (eg: <b>ENS</b><b>G</b>ENSG00000112715 or: ENSMUSG00000023951)</option>
// <option value="ENSEMBL_TRANSCRIPT_ID">Ensembl Transcript Id (eg: ENS<b>T</b>00000672860.3 or ENSMUST00000142351.9)</option>
// ENSEMBL_PROTEIN_ID eg: ENSP00000500082.3
// <option value="ENTREZ_GENE_ID">Entrez Gene Id (eg: 7422)</option>
// <option value="GENE_SYMBOL" selected>Gene symbol (eg: VEGFA)</option>
// <option value="UNIPROT_ID">UniProt Protein Id</option>

  // https://www.ncbi.nlm.nih.gov/gene?term=(VEGFA%5BGene%20Name%5D)%20AND%2010090%5BTaxonomy%20ID%5D
  
  // or:  Mus%20musculus[orgn] 

  if (taxid === "") {alert("First: You need to select the Organism/Species using the drop-down menu near top of this HIVE webpage."); this_link.target="_self"; this_link.href="#organism_species"; return false;} // false cancel the action.

  var gene_or_protein_url = gene_symbol_type_is_gene_or_protein(); // was: ['ENSEMBL_PROTEIN_ID', 'REFSEQ_PROTEIN', 'UNIPROT_ID'].indexOf(gene_symbol_type) >= 0 ? 'protein' : 'gene'; 

  // var name_type = '[Gene Name]';
  var name_type = '[Gene/Protein Name]';
  this_link.target="_blank"; 
  this_link.href='https://www.ncbi.nlm.nih.gov/'+gene_or_protein_url+'?term=('+encodeURIComponent(genename + name_type +') AND ('+taxid+'[Taxonomy ID])');
  return true;
}


function disable_all_any_options(select_elem, disable) {
  var options = select_elem.options;
  for (var i=0; i<options.length; i++) {
    var o = options[i];
    if (o.value === "All" || o.value === "Any") {
      o.disabled = disable;
      if (disable && o.selected) o.selected = false;
    } 
  }
}


function select_all_options(select_elem_id, all_or_none) {
  //var options = select_elem.options;
  var options = document.getElementById(select_elem_id).options;
  for (var i=0; i<options.length; i++) {
    var o = options[i];
    o.selected = all_or_none==='all' && !o.disabled; 
  }
}


function select_all_checkboxes(checkbox_name, all_or_none) {
  //var options = select_elem.options;
  var checkboxes = document.getElementsByName(checkbox_name), // is getElementsByName() NOT getElementById()
      checked = all_or_none==='all'
  for (var i=0; i<checkboxes.length; i++) {
    // var o = checkboxes[i];
    checkboxes[i].checked = checked; // && !o.disabled;
    checkboxes[i].indeterminate = false;
  }
  enable_all_none_checkbox_buttons(checkbox_name);

  if (checkbox_name === 'fc_in_celltype_checkboxes' || checkbox_name === 'fc_at_time_checkboxes') set_head_checkboxes_to_match_celltype_time_checkboxes();
  else if (checkbox_name === 'fc_in_celltype_and_time_checkboxes') set_celltype_time_checkboxes_to_match_head_checkboxes();
}


function min_num_fc_for_gene2_changed(this_select) {
  if (!this_select) this_select = document.getElementById("min_num_fc_for_gene2");

/*
// Aug 2023: This was for the old select type lists 
// Not needed as using checkboxes instead of the select lists now:  
  var val = this_select.value,
      celltypes_select = document.getElementById('fc_in_celltype'), // using celltypes_select here (as celltypes is a global array).
      times_select     = document.getElementById('fc_at_time'),     // using times_select here (as times is a global array).
      disable   = false;

//      fc_or_and       = document.getElementById('fc_or_and').value,
//      pv_less_than    = document.getElementById('pvalue_less_than').value;
  
  // '<option value="Any" selected>Any</option>

  celltypes_select.disabled = times_select.disabled = (val === "all" || val.substring(0, 3) === "any"); // || val === "none" ?  

  if      (val === "none") {}
  else if (val === "all") {celltypes_select.value = times_select.value = "All"; disable=true;}
  else if (val.substring(0, 3) === "any") {celltypes_select.value = times_select.value = "Any";}
  else if (val.substring(0,11) === "selectedAny") {disable = true;}
  // {if (celltypes_select.value === "All" || celltypes_select.value === "Any") celltypes_select.selectedIndex = -1; if (times_select.value === "All" || times_select.value === "Any") times_select.selectedIndex = -1;}
  else if (val === "selectedAll") {}
  else {alert("Unexpected val="+val); return;}

  disable_all_any_options(celltypes_select, disable);
  disable_all_any_options(times_select, disable);
  
*/  
  
  
  show_heatmap();
}


/*
  (a) Fold changes in at least:
<select id="min_num_fc_for_gene2">
<optgroup id="noneOptGroup" label="No columns...">
 <option value="none" selected>No column</option>

<optgroup id="anyOptGroup" label="Any columns...">
 <option value="any1" selected>Any 1 column</option>
 <option value="any2">Any 2 columns</option>
 <option value="any3">Any 3 columns</option>
</optgroup>

<optgroup id="allOptGroup" label="All columns:">
 <option value="all">ALL columns</option>
</optgroup>

<optgroup id="selectedOptGroup" label="Selected column(s)...">
 <option value="selectedAny1">Any 1 of the column(s) that I select (eg: column2 OR column3 OR column4)</option>
 <option value="selectedAny2">Any 2 of the column(s) that I select (eg: column2 AND column3)</option>
 <option value="selectedAny3">Any 3 of the column(s) that I select (eg: column2 AND column3 AND column4)</option>
 <option value="selectedAll">ALL of the column(s) that I select (eg: column2 AND column3 AND column4 and column5)</option>
</optgroup>
</select>
*/    


function fc_in_celltypes_and_times_to_head_index_array(fc_in_celltypes, fc_at_times) {
  var k = []; // indexing positions into the logfc[] row arrays.
  for (var j = 1; j < head1.length; j++) { // Start at 1 as the as the first column in the headings and logfc arrays is the gene name
    if (fc_in_celltypes.indexOf(head1[j]) > -1 && fc_at_times.indexOf(head2[j]) > -1) k.push(j); // Not j+1
  }
    // if (!fc_in_celltypes_Any && fc_in_celltypes.indexOf(head1[j]) == -1) continue;
    // if (!fc_at_times_Any && fc_at_times.indexOf(head2[j]) == -1) continue;
    // k.push(j); // Not j+1
  return k; 
  }
  
  
function show_heatmap_tbody() {
  // alert("In show_heatmap_tbody()");
  
  if (logsort === null) sort_data(null); // null will set to file input order in logsort array.


  var err="", fc_more_or_less, fc_amount_Any, fc_more_than, fc_less_than, fc_abs_more_than, fc_abs_less_than,
      fc_amount = document.getElementById('fc_amount').value;

  if (fc_amounts_options_signed) {
     if (fc_amount === 'Any') fc_more_or_less = "Any";
     else {
       var fc_sign = fc_amount[0];
       fc_more_or_less = (fc_sign==='+') ? 'more' : (fc_sign==='-') ? 'less' : (fc_sign==='A') ? 'absMore' : (fc_sign==='a') ? 'absLess' : 'unknown';      // Otherwise is 'A' for Absolute value >=
       fc_amount = fc_amount.slice(1); // Skip the starting '+' or '-' or 'A'
       }
  } else {
     fc_more_or_less = document.getElementById('fc_more_or_less').value; // less/
  }

  fc_amount_Any    = (fc_amount === 'Any'); // and above: (fc_more_or_less === "Any");
  fc_more_than     = (fc_more_or_less === "more");
  fc_less_than     = (fc_more_or_less === "less");
  fc_abs_more_than = (fc_more_or_less === "absMore");
  fc_abs_less_than = (fc_more_or_less === "absLess");

  if (!fc_amount_Any && !fc_more_than && !fc_less_than && !fc_abs_more_than && !fc_abs_less_than) {alert("ERROR: fc_more_or_less="+fc_more_or_less); return false;}
  
  // OLD: if fc_more_or_less==="more_or_less" then both the above are false

 
  // var fc_at_time = document.getElementById('fc_at_time').value;
  // var fc_in_celltype = document.getElementById('fc_in_celltype').value;
  
  // Multiple select enabled now for 'fc_in_celltypes' and 'fc_at_times', so using 'getSelectedValues()', but NOT multiple for 'fc_or_and':
  var fc_in_celltypes = getSelectedCheckboxValues('fc_in_celltype_checkboxes'), // WAS: getSelectedValues( document.getElementById('fc_in_celltype') ),
      fc_at_times     = getSelectedCheckboxValues('fc_at_time_checkboxes'),     // WAS: getSelectedValues( document.getElementById('fc_at_time') ),
      fc_in_celltype_and_time = getSelectedCheckboxValues('fc_in_celltype_and_time_checkboxes'); // <-- this is numbers (the indexes of the head1[] array) as strings. Added 19 Aug 2023.
      // fc_or_and       = document.getElementById('fc_or_and').value; // fc_or_and is set below now


  // Better to set a message, instead of using the alert() box:
  // if (fc_in_celltypes.length == 0) err += "You haven't selected any Cell-types. Please select 'Any' OR specific cell-types.\n";
  // if (fc_at_times.length     == 0) err += "You haven't selected any 'Time-point or condition'. Please select 'Any' OR specific timepoints.\n";
  
  // fc_in_celltypes and fc_at_times can have indeterminite checkboxes, which will have checked as false.
  // if (fc_in_celltypes.length == 0) err += "You haven't selected any 'Cell-type/cluster' Please select specific cell-types/clusters from the list above.<br>";
  // if (fc_at_times.length     == 0) err += "You haven't selected any 'Time-point or condition'. Please select specific timepoints from the list above.<br>";
  if (fc_in_celltype_and_time.length == 0) err += "You haven't selected any Heatmap Columns. Please select specific 'Cell-types/clusters' and 'Time-point or condition' or 'Heatmap columns' from the check-box lists above.<br>";
  
  if (err !== "") {show_filter_heatmap_message(err,'red'); console.log(err); return false;}

  // This Any won't apply now I think:
  //if (fc_in_celltypes.length > 1 && fc_in_celltypes.indexOf('Any') != -1) err += "For '<i>Cell-type/cluster</i>' you have selected '<i>Any</i>' and specific cell-types.<br>Please select '<i>Any</i>' <u>OR</u> specific cell-type(s)/cluster(s).";
  //if (fc_at_times.length     > 1 && fc_at_times.indexOf('Any')     != -1) err += "For '<i>timepoint or condition</i>' you have selected '<i>Any</i>' and specific timepoints.<br>Please select '<i>Any</i>' <u>OR</u> specific timepoint(s)/condition(s).";
  //if (err !== "") {show_filter_heatmap_message(err,'red'); alert(err); return false;}


  //alert('fc_in_celltype='+fc_in_celltype);
  //console.log("show_heatmap_tbody(): min_cols=",min_cols);

  var show_pct12_values = has_pct12_columns && document.getElementById("show_pct12_values").checked,
      show_pvalues = has_pvalues_columns && document.getElementById("show_pvalues").checked,
      html = '';

  // col logfc[0] is the genename
  //var h = (1.0 - value) * 240; // To normalise +5 then divide by 10, as input range is -4 to + 5

  // "in general the border of the right cells will overwrite the border of their left siblings. Same goes for bottom cells overwriting the border of top "siblings" (not really siblings here, I know, but you get the picture ...)."

 //...."border-top: 1px solid black; border-left: 1px solid black;"



  // times = ["EARLY","MID","LATE"];
  // celltypes = ["Amacrine","Astrocyte","Bipolar","Cone","Endothelial","Horizontal","Microglia","Muller Glia","Pericyte","RGC","Rod","RPE"];

  //var_fc_absolute  =

  var fc_in_celltypes_Any = (fc_in_celltypes.indexOf('Any') > -1),
      fc_at_times_Any = (fc_at_times.indexOf('Any') > -1),
      // fc_not_all_Any = !(fc_amount_Any && fc_in_celltypes_Any && fc_at_times_Any), // Not used now as using check-boxes with Any option.
      fc_amount_float = fc_amount_Any ? 0.0 : parseFloat(fc_amount);
  
  var pv_less_than = document.getElementById('pvalue_less_than').value,
      pv_Any = (pv_less_than === 'Any'),
      pv_less_than_float = pv_Any ? 10 : parseFloat(pv_less_than); // Just assigning 10 here, but could be any value of 1 or more.
  
  // pre 20 Aug 2023: var show_all_pvalues_in_row = pv_Any || logpvs.length < 2 || document.getElementById("show_all_pvalues_in_row").checked;

  var show_all_foldchanges_in_row = fc_amount_Any || document.getElementById("show_all_foldchanges_in_row").checked, // Not used yet.
      show_all_pvalues_in_row = (pv_Any || document.getElementById("show_all_pvalues_in_row").checked) && logpvs !== null && logpvs.length > 1; 

  var k = []; // indexing positions into the logfc[] row arrays.
  // Math.trunc() is Javascript ES6, so using Math.floor(): 
  // (j % times.length) is same as (j - times.length*Math.floor(j/times.length))
  
  /* OLD:
  if (fc_not_all_Any) { // then build an array of the columns I need to test:
    for (var j = 0; j < celltypes.length*times.length; j++) {
      if (!fc_in_celltypes_Any && fc_in_celltypes.indexOf(celltypes[Math.floor(j/times.length)]) == -1) continue;
      if (!fc_at_times_Any && fc_at_times.indexOf(times[j % times.length]) == -1) continue; 

      k.push(j+1); // Need to use j+1, as the as the first column in the logfc array is the gene name.    
    }
  }
  */



  // from 20 Aug 2023 - changed to using this fc_in_celltype_and_time_checkboxes
  //if (false) { // If using fc_in_celltype_and_time
     for (var j = 0; j < fc_in_celltype_and_time.length; j++) { 
       k.push(Number(fc_in_celltype_and_time[j])); // is indexes of head1 array.
     }
  //}

  /* pre-20 Aug 2023:
  if (fc_not_all_Any) { // then build an array of the columns I need to test:
    k = fc_in_celltypes_and_times_to_head_index_array(fc_in_celltypes, fc_at_times); // 19 Aug 2023
    
    // 19 Aug 2023 don't need: fc_in_celltypes_Any  and fc_at_times_Any
    // for (var j = 1; j < head1.length; j++) { // Start at 1 as the as the first column in the headings and logfc arrays is the gene name
    //   if (!fc_in_celltypes_Any && fc_in_celltypes.indexOf(head1[j]) == -1) continue;
    //   if (!fc_at_times_Any && fc_at_times.indexOf(head2[j]) == -1) continue;
    //   k.push(j); // Not j+1
    // }
  }
  */

  console.log("k=",k);

  var kLength = k.length; // will be zero when fc_not_all_Any===false

  // var min_cols = parseInt(document.getElementById('min_num_fc_for_gene').value); // returned 0 to 9, with default 1 selected.
 
  var min_num_fc_cols = document.getElementById('min_num_fc_for_gene2').value,
      min_cols = 0; // OR is same as Any

//  if      (min_num_fc_cols === "none") {min_cols = 0;}
  if (min_num_fc_cols === "all")                      {min_cols = kLength;} // celltypes_select.value = times_select.value = "All"; disable=true;}
  else if (min_num_fc_cols.substring(0, 3) === "any") {min_cols = parseInt(min_num_fc_cols.substring(3));} // celltypes_select.value = times_select.value = "Any";}
  
  //else if (min_num_fc_cols.substring(0,11) === "selectedAny") {min_cols = parseInt(min_num_fc_cols.substring(11)); if (min_cols > kLength) alert("You have Any selected min_cols="+min_cols+" which is greater that selected columns kLength="+kLength);} // disable=true;}
  // {if (celltypes.value === "All" || celltypes.value === "Any") celltypes.selectedIndex = -1; if (times.value === "All" || times.value === "Any") times.selectedIndex = -1;}
  //else if (min_num_fc_cols === "selectedAll") {min_cols = kLength; fc_or_and = 'AND';} // 
  
  else {alert("Unexpected min_num_fc_cols="+min_num_fc_cols); return false;}
    
  if (!(fc_amount_Any && pv_Any) && min_cols > kLength) {err += "You have asked for Any "+min_cols+" columns, but that is more that the "+kLength+" 'Heatmap Columns' that you have selected.<br>Please either reduce the 'Any ... selected columns' selection, or select more 'Cell-types/clusters' and 'Time-point or condition' or 'Heatmap columns' from the check-box lists above.<br>"; show_filter_heatmap_message(err,'red'); return false;}
  
// ===

console.log("show_heatmap_tbody(): min_num_fc_cols="+min_num_fc_cols+"  min_cols="+min_cols+"  kLength="+kLength);

  var row_count = 0, i;

  if (logsort.length !== logfcs.length-1) {alert("logsort.length="+logsort.length+" !== logfcs.length-1="+(logfcs.length-1)); return false;} 

  // for (var i=1; i<logfcs.length; i++) { // for each row. Start at i=1 as i=0 is the column headings.
  // logsort starts at logfcs[1] so var k = 0....  
  for (var m=0; m < logsort.length; m++) { // for each row. Start at i=1 as i=0 is the column headings.
    // Using 'm' as k is used above and l is usewd below.
    var i = logsort[m][0],
        j,
        l,
        found = 0,
        logfc = logfcs[i],
        logpv = (logpvs!==null && logpvs.length > i) ? logpvs[i] : null; // optional pvalues row - not present in my single file format yet.
        
    /*
    if (min_cols>1) { // assume all genes have at least one fc
      var cnt = 0;
      for (j=1; j<logfc.length; j++) {
        if (logfc[j] !== null && logfc[j] != 0) cnt++;
      }
      if (cnt < min_cols) continue;
    }
    */
    //if (fc_not_all_Any) { // then test the appropriate columns:

    if (fc_amount_Any && pv_Any) {
      // Skip rows that are all null:
      for (j=1; j<logfc.length; j++) {
        if (logfc[j] !== null) {found++; break;} // && logfc[j] != 0) cnt++;
      }
      if (found === 0) continue;
    }
    else {
      for (var l=0; l<kLength; l++) { // for each column
        j=k[l];
      // is a ref faster ? eg. val = logfc[j];
        if (logfc[j] === null) continue;  // will allow: || logfc[j] === 0
        
        if (!fc_amount_Any) {
          if      (fc_more_than) {if (logfc[j] <  fc_amount_float) continue;} // so >= accepted
          else if (fc_less_than) {if (logfc[j] > -fc_amount_float) continue;} // so <= accepted
          else if (fc_abs_more_than) {if (Math.abs(logfc[j]) < fc_amount_float) continue;}
          else if (fc_abs_less_than) {if (Math.abs(logfc[j]) > fc_amount_float) continue;} // Must be fc_abs_less_than so don't need to test here.
          else {alert("ERROR: unexpected fc_more_than ...."); return false;}
        }
        
        if (!pv_Any && logpv !== null && (logpv[j] === null || logpv[j] > pv_less_than_float)) continue; // Added 18 Aug 2023.

        found++;
        if (found > min_cols) break; // as only need to find min_cols matches in the row when set to 'OR', otherwise need to test all kLength selected columns in the row.
        // if (fc_or_and === 'OR') break; // as only need to find one match in the row when set to 'OR', otherwise need to test all kLength selected columns in the row.
      } // end of for each column:  for (var l=0; l<kLength; l++) ....
      // if ((fc_or_and === 'OR' && found === 0) || fc_or_and === 'AND' && found < kLength) continue; // if (!found) continue;
      if (found < min_cols) continue;
    }
    
    
    /*
    else if (!pv_Any && logpv !== null) { // fc is Any, but pv isn't Any.
      var found = 0; // false;
      for (var l=0; l<kLength; l++) { // for each column
        j=k[l];

        if (logpv[j] === null || logpv[j] > pv_less_than_float) {continue;} // Added 18 Aug 2023.
        found++; // = true;

        if (found > min_cols) break; // as only need to find min_cols matches in the row when set to 'OR', otherwise need to test all kLength selected columns in the row.
        // if (fc_or_and === 'OR') break; // as only need to find one match in the row when set to 'OR', otherwise need to test all kLength selected columns in the row.
      } // end of for each column.
      if (found < min_cols) continue; // if (!found) continue;
      // if ((fc_or_and === 'OR' && found === 0) || fc_or_and === 'AND' && found < kLength) continue; // if (!found) continue;
    */
  
    /*
    // pre-18 Aug 2023: Filter on at least one pvalue in row less than the: pv_less_than_float. (Now checking the pvalue for the fold-change above.)
    if (!pv_Any && logpv !== null) {
      var found = false;
      for (j=1; j<logfc.length; j++) {
        if (logpv[j] !== null && logpv[j] <= pv_less_than_float) {found=true; break;}
      }
      if (!found) continue;
    }
    */




/*
    //if (fc_amount != 'Any' || fc_at_time != 'Any' || fc_in_celltype != 'Any') {
    if (fc_amount != 'Any' || fc_at_times.indexOf('Any')==-1 || fc_in_celltypes.indexOf('Any')==-1) {
      
      startAt=1, step=3;
      if      (fc_at_time == 'Any')   step = 1; // So tests each.
      else if (fc_at_time == 'EARLY') startAt = 1; // 0 is the gene name column.
      else if (fc_at_time == 'MID')   startAt = 2;
      else if (fc_at_time == 'LATE')  startAt = 3;
      else {alert("Unexpected fc_at_time="+fc_at_time); return;}
      
//      for (var j=startAt; j<logfc.length; j+=step) {

      var found=false
      for (var k=0; k<alength; k++) {
        j=a[k];

        if (fc_amount == 'Any') {
          if (logfc[j] != 0) {found=true; break;}
        } else {
          if (logfc[j] >= fc_amount_float || logfc[j] <= -fc_amount_float)) ) {found=true; break;}
        }
      
        if (  ( (fc_amount === 'Any' && logfc[j] != 0) || (fc_amount !== 'Any' && (logfc[j] >= fc_amount_float || logfc[j] <= -fc_amount_float)) )
            && (fc_in_celltypes.indexOf('Any') > -1 || fc_in_celltypes.indexOf(celltypes[Math.floor((j-1)/3)]) > -1 ) 
            
            
//            && (fc_in_celltype=='Any' || celltypes[Math.floor((j-1)/3)] == fc_in_celltype) 
           ) {found=true; break;}}
      // console.log(celltypes[Math.floor((j-1)/3)]); 
      // Eg. for Coarse: celltypes = ["Amacrine","Astrocyte","Bipolar","Cone","Endothelial","Horizontal","Microglia","Muller Glia","Pericyte","RGC","Rod","RPE"];
      
      if (!found) continue;
    } // end of: if (fc_at_time != 'Any') {
*/
    
    filtered_row_list.push(i); // List of rows used to draw the heatmap image later.
    
    var genename = logfc[0];
    // GeneCards is Human only: var buff = '<tr><td><a href="http://www.genecards.org/cgi-bin/carddisp.pl?'+genename+'" target="_blank">'+genename+'</a></td>';    

    var gene_link_td = '<a href="#" onclick="set_gene_link(this, \''+genename+'\');">'+genename+'</a>'; // target="_blank" 

    // Using the logfcs row as the checkbox id (not the 'genename' which might have an invalid characters for html ids.)
    var buff = '<tr id="r'+i+'"><td><input type="checkbox" id="c'+i+'" onchange="select_gene(this);"></td><td>'+gene_link_td+'</td>';
    // http://www.informatics.jax.org/marker/summary?nomen=Aamp

    // I changed so that, red is positive, blue is negative:
    // +3   : red    (hsl(  0, 100%, 50%))
    // >0   : yellow (hsl( 60, 100%, 50%))
    // 0    : green  (hsl(120, 100%, 50%))
    // <0   : cyan   (hsl(180, 100%, 50%))
    // -3   : blue   (hsl(240, 100%, 50%))

    // if (fc == null) ....
    //if (fc == 0) h = 120; // green.
    //else if (fc > 0) h = Math.max(0, 60 - 20*fc); // the 15 assues range 0 to +4, or 30 assumes range 0 to +2, 20 is range 0 to +3
    //else h = Math.min(240, 180 - 20*fc); // the 30 assumes range 0 to -2. // if (fc < 0)

    // could perhaps increase the 'L' to make the blue lighter , or change the alpha/transparency to make lighter. 

    // html += '<td style="background-color:hsl('+h+', 100%, 50%);"> &nbsp; '+fc+' &nbsp; </td>';
    //}

    for (j=1; j<logfc.length; j++) {

      var border = (j-1) % 3 == 0 ? ' border-left: 2px solid black;' : ''; 
      var fc = logfc[j];

// TO add: (!show_all_foldchanges_in_row

      if (fc === null || (!pv_Any && !show_all_pvalues_in_row && logpv[j] !== null && logpv[j] > pv_less_than_float)) { // show_all_pvalues_in_row is false if logpv===null or logpv.length<=1
        buff += '<td style="'+border+'"></td>';
      }
      else {
        var pvalue_html = (!show_pvalues || logpv === null || logpv[j] === null) ? '' : (logpv[j] <= 0.05) ? 'p=<b>' + logpv[j] + '</b>' : (logpv[j] <= 0.9) ?  'p='+logpv[j] : '<span font-size="75%">p='+logpv[j]+'</span>';

        var pct12_html  = (!show_pct12_values || pct1s[i]===null || pct1s[i][j]===null) ? '' : " pct1="+pct1s[i][j]+" pct2="+pct2s[i][j];

        var pvalue_pct12_html = (pvalue_html === '' && pct12_html === '') ? '' : ' &nbsp; <span style="font-size:80%;">' + pvalue_html + pct12_html + '</span>';

        if (fc === 0) {
          buff += '<td style="'+border+'font-size:60%;">0' + pvalue_pct12_html + '</td>';  // maybe put a small '0' here
        } 
        else {
          var h;
          if (fc === 0) h = 120; // green.
          if (fc > 0) h = Math.max(0, 60 - fc_hue_factor_red*fc); // fc_hue_factor_red 30 assumes range 0 to +2.
          else h = Math.min(240, 180 - fc_hue_factor_blue*fc);    // fc_hue_factor_blue 30 assumes range 0 to -2. // if (fc < 0)

          //var h = (5 - logfc[j])* 24;
          //if (h<0) h=0; // in case is below the -5 range.
          //else if (h>240) h=240; // in case is above the +5 range.
          // My hack to make near-zero values lighter:
          var l = Math.round(90 - 40*Math.min(1,Math.abs(fc))); // so will be 60% at 1, 80% near zero, 

          buff += '<td style="background-color:hsl('+h+', 100%, '+l+'%);'+border+'">'+fc + pvalue_pct12_html + '</td>';   // Must be same as above if (fc === 0) case.
          //console.log(buff);
        }
      }
    }
    html += (buff + '<td style="border-left: 2px solid black;">'+gene_link_td+'</td></tr>');
    row_count += 1;
  }     // end of for each row.

  document.getElementById('heatmap_tbody').innerHTML = html;

  show_filter_heatmap_message(row_count+" genes are listed in the heatmap below.");
  show_num_filtered_rows(row_count);

  show_display_options_message("");
  show_validate_input_data_parameters_message("");

  show_heatmap_title('Fold-change',head1.join(', ')); 

  disable_heatmap_with_column_names_and_types_button(false); // to allow redisplay of heatmap with updated column name or types.

  return true;
}




/* 
   https://stackoverflow.com/questions/12875486/what-is-the-algorithm-to-create-colors-for-a-heatmap      
   A general approach is to interpolate colors. You decided that

0: 0 0 255 (or any blue)
0.5: 0 255 0 (or any green)
1: 255 0 0 (or any red)
You simply do a linear interpolation of the RGB. Between 2 reference values (eg t between 0 and 0.5), the interpolated color C is like

C = (1 - t) * c0 + t * c1

OR:
def genColorMap(self):
    points = [(255,0,0), (255,255,0), (0,255,0), (0,255,255), (0,0,255)]
    cm = {}
    for i in range(0, 256):
        p0 = int(numpy.floor((i/256.0)/len(points)))
        p1 = int(numpy.ceil((i/256.0)/len(points)))
        rgb = map(lambda x: x[0]*max(0,(i-p0)) + x[1]*max(0,(i-p1)), zip(points[p0], points[p1]))
        cm[i] = QtGui.qRgb(rgb[0], rgb[1], rgb[2])
    return cm
OR:
  
  function heatMapColorforValue(value){
  var h = (1.0 - value) * 240
  return "hsl(" + h + ", 100%, 50%)";
}

0    : blue   (hsl(240, 100%, 50%))
0.25 : cyan   (hsl(180, 100%, 50%))
0.5  : green  (hsl(120, 100%, 50%))
0.75 : yellow (hsl(60, 100%, 50%))
1    : red    (hsl(0, 100%, 50%))

I could modify to do:
   >0 -> +2 cyan to blue
   0 = blank or green
   <0 -> -2 yellow to red

if ==0

else if (logfc[j]>0) {h = Math.min(240, 180 + 30*logfc[j];} // the 30 assumes range 0 to +2.
else {h = Math.max(0, 60 + 30*logfc[j];} // the 30 assumes range 0 to -2. // if (logfc[j]<0)

eg: Math.max(..., 0)
eg: Math.min(..., 240)

*/



/*
function pearson(a,b) {
  // It assumes that both variables follow a normal distribution, otherwise a rank correlation measure needs to be calculated instead - eg: kendallsTau() 
  //    https://thisancog.github.io/statistics.js/inc/correlation.html
  
  var x = logfcs[a];
  var y = logfcs[b];

  var n = x.length;
   
  //if (n == 0) return 0;

  var meanX = 0, meanY = 0;
  for (var i = 0; i < n; i++) {
    meanX += x[i] / n;
    meanY += y[i] / n;
  }
  //or: meanX = meanX/n; meanY = meanY/n;

  var num = 0, den1 = 0, den2 = 0;
  for (var i = 0; i < n; i++) {
    var dx = (x[i] - meanX);
    var dy = (y[i] - meanY);
    num  += dx * dy;
    den1 += dx * dx;
    den2 += dy * dy;
  }

  var den = Math.sqrt(den1) * Math.sqrt(den2);

  if (den == 0) return 0;

  return num / den;
}



///function pearson(a,b) {
  // It assumes that both variables follow a normal distribution, otherwise a rank correlation measure needs to be calculated instead - eg: kendallsTau() 
  //    https://thisancog.github.io/statistics.js/inc/correlation.html
  
  var x = logfcs[a];
  var n = x.length;

  var meanX = 0, num_fc = 0;
  for (var i = 0; i < n; i++) {
    if (x[i] == 0) continue; // **** or null in future!!!
    num_fc++; 
    meanX += x[i] / n;
  }
  //or: meanX = meanX/n;

  if (num_fc < 2) {alert("For Pearson correlation you need to select a gene with at least 2 fold-change values."); return false;}

  var denXX = 0;
  for (var i = 0; i < n; i++) {
    if (x[i] == 0) continue; // **** or null in future!!!
    var dx = (x[i] - meanX); // or could store in an array for reuse below:
    denXX += dx * dx;
  } 


  for each other gene .....{

    var y = logfcs[b];

    var meanY = 0, num_fc = 0;

    for (var i = 0; i < n; i++) {
      if (y[i] == 0) continue; // **** or null in future!!!
      num_fc++; 
      meanY += y[i] / n;
    }
    //or: meanY = meanY/n;
    
    // if (num_fc < 2) {hide this gene; continue;}

    var num = 0, denYY = 0, num_fc = 0;
    for (var i = 0; i < n; i++) {
      if (x[i] == 0 || y[i] == 0) continue; // **** *** or null in future!!!
      num_fc++;
      var dx = (x[i] - meanX);
      var dy = (y[i] - meanY);
      num  += dx * dy;
      denYY += dy * dy;
    }

    // if (num_fc < 2) {hide this gene; continue;}
    
    var den = Math.sqrt(denXX) * Math.sqrt(denYY);

    if (den == 0) {hide this gene; continue;} // then hide this table row.

    correlation = num / den;
    if (correlation < ....) // hide this table row.
    // else show row - if correlate with all - ????
    }

}



add copy selected genes to clipboard with separater ....
<label>Separate genes in the copied list with a:<select id="">
<option value="newline">New-line</option>
<option value="comma">Comma</option>
<option value="commaspace">Comma and Space</option>
<option value="semicolon">Semi-colon</option>
<option value="tab">Tab</option>
<option value="space">Space</option>
</select>
</label>

switch
"newline" div = "\n";
"comma" div = ","
"commaspace" div = ", "
"semicolon" div=";"
"tab" div="\t"
"space" div=" "
invalid 

  join(div);
 
 
*/
 

/* Maybe email David re diabetes - re mitochondria: https://youtu.be/0mD-wupqvQE?t=2603  */

function set_filtering_progress(msg) {
  var elem = document.getElementById('genename_filtering_progress');
  if (elem) elem.innerHTML = msg;
}

var timer2 = null;
function filter_genes_by_name() {
  set_filtering_progress(" <i>Working...</i>");

  var filter_text = document.getElementById('filter_genes_input_text').value.trim().toUpperCase(); // or: toLowerCase();
  var tbody = document.getElementById('heatmap_tbody');
  var num_rows = tbody.rows.length;

  // Using this setTimeout so that the above message is displayed, before running the following. Works in Chrome, but doesn't work in Firefox.
  // The setTimeout() method calls a function after a number of milliseconds.
  timer2 = setTimeout(function() {
    var i;
    if (filter_text == "") { // clear the hidden for any hidden cells:
      for (var i=0; i<num_rows; i++) tbody.rows[i].style.display = '';
    }
    else {
      for (var i=0; i<num_rows; i++){
        var row = tbody.rows[i];
        
        var irow = Number(row.id.substring(1)), // The row has id="r'+i" where i is the row in the logfcs array.
            genename = logfcs[irow][0];
            
        row.style.display = (genename.toUpperCase().indexOf(filter_text) == -1) ? 'none' : '';
      }
  
  //To loop through the table cells in the row:
  // var cellLength = row.cells.length;
  //for (var y=0; y<cellLength; y+=1){
  //  var cell = row.cells[y];
    //do something with every cell here
  //}
    }
    set_filtering_progress(""); 
    timer2 = null;
  }, 10); // end of the setTimeout(

}




/*  FROM: String API Help: https://string-db.org/help/api/
Please be considerate and wait one second between each call, so that our server won't get overloaded.
Although STRING understands a variety of identifiers and does its best to disambiguate your input it is recommeded to map your identifier first (see: mapping). Querying the API with a disambiguated identifier (for example 9606.ENSP00000269305 for human TP53) will guarantee much faster server response.
Another way to guarantee faster server response is to specify from which species your proteins come from (see 'species' parameter). In fact API will reject queries for networks larger than 10 proteins without the specified organism.
When developing your tool use default STRING address (https://string-db.org), but when your code is ready, you should link to a specific STRING version (for example "https://version-11-5.string-db.org"), which will ensure that for the same query you will always get the same API response, even after STRING or API gets updated. To see the current STRING version and its URL prefix click here
STRING understands both GET and POST requests. GET requests, although simpler to use, have a character limit, therefore it is recommended to use POST whenever possible.
When calling our API from your website or tools please identify yourself using the caller_identity parameter.


Mapping identifiers
You can call our STRING API with common gene names, various synonyms or even UniProt identifiers and accession numbers. However, STRING may not always understand them which may lead to errors or inconsistencies. Before using other API methods it is always advantageous to map your identifiers to the ones STRING uses. In addition, STRING will resolve its own identifiers faster, therefore your tool/website will see a speed benefit if you use them. For each input protein STRING places the best matching identifier in the first row, so the first line will usually be the correct one.
- see the example Python code.
*/


//https://string-db.org/api/[output-format]/get_link?identifiers=[your_identifiers]&[optional_parameters]


var selected_gene_list = [], filtered_row_list = []; 

var stringdb_caller_identity = 'qub.ac.uk'; // Temporary.  // *** Also set in: <input hidden id="form_stringdb_caller_identity" name="" value="qub.ac.uk">


function stringdb(embedded_or_in_newtab) {
  //var gene_list_uppercase = [];
  //for (var i=0; i<selected_gene_list.length; i++) gene_list_uppercase.push(selected_gene_list.toUpperCase());
  console.log("stringdb()");
  
  
   // STRING understands both GET and POST requests. GET requests, although simpler to use, have a character limit, therefore it is recommended to use POST whenever possible.
   //  var url = 'https://string-db.org/api/tsv-no-header/get_link?identifiers='+ encodeURIComponent(selected_gene_list.slice(0,300).join('\r')) + '&network_flavor='+network_flavor + '&show_query_node_labels=1' + '&required_score='+required_score + '&additional_network_nodes='+additional_network_nodes + '&caller_identity='+stringdb_caller_identity;
   // I'll change this to POST in future.

   // "Reason: CORS header ‘Access-Control-Allow-Origin’ missing - Explains the Cross-Origin Resource Sharing(CORS) error message to allow cross-origin requests and shows how to resolve it for Apache and Nginx web servers."
   //  https://html5.tutorials24x7.com/blog/reason-cors-header-access-control-allow-origin-missing


  

  //var species = '10090'; // Initially assume Mouse selected.
  //if (document.getElementById('stringdb_species_human').checked) species = '9606';  // Human
  //else if (!document.getElementById('stringdb_species_mouse').checked) {show_loading_message("ERROR: stringdb: Unexpected species selected", 'red'); return false;}
  // http://www.uniprot.org/taxonomy

  var msg = "";
  
  if (taxid === "") {msg = "NOTE: stringdb: Species not selected"; show_loading_message(msg, 'red'); show_stringdb_message(msg,'red'); alert(msg); location.href="#gene_symbol_type"; return false;} // scrolling to gene_symbol_type as if scroll to #organism_species it's hidden by the floating table head row.
  
  var gene_symbol_type = document.getElementById('gene_symbol_type').value; // Not used here for stringdb
  
  if (selected_gene_list.length === 0) {msg = "NOTE: stringdb: You need to select genes, using the checkboxes at left of the heatmap table below"; show_loading_message(msg, 'red'); show_stringdb_message(msg,'red'); alert(msg); return false;} // location.href="#organism_species"; table...
  
  var required_score = document.getElementById('stringdb_required_score').value;
  //alert('stringdb_required_score: '+required_score);
  
  // limit = Maximum number of nodes to return, e.g 10
  // required_score = Threshold of significance to include a interaction, a number between 0 and 1000
  // additional_network_nodes = Number of additional nodes in network (ordered by score), e.g. 10
  // network_flavor = The style of edges in the network. evidence for colored multilines. Confidence for singled lines where hue correspond to confidence score. (actions for stitch only)
  // network_flavor	the style of edges in the network: evidence, confidence (default), actions
  
  var additional_network_nodes = document.getElementById('stringdb_additional_network_nodes').value;
  var network_flavor = document.getElementById('stringdb_network_flavor').value; 

  console.log("stringdb(): starting getSTRING()");

  if (embedded_or_in_newtab === 'embedded') {
     show_stringdb_message("Fetching StringDB image....",'blue');
     // Just using the first 300 identifiers:
     var result = getSTRING('https://string-db.org', {'species':taxid, 'identifiers':selected_gene_list.slice(0,2000), 'network_flavor':network_flavor, 'show_query_node_labels':'1', 'required_score':required_score, 'additional_network_nodes':additional_network_nodes, 'caller_identity':stringdb_caller_identity} );
     //console.log("stringdb result=",result); result is undefined.

    enable_stringdb_buttons(false); // false means not disabled.

  } else if (embedded_or_in_newtab === 'in_newtab') {

     // See: https://string-db.org/cgi/help.pl?subpage=api%23linking-to-the-network-on-string-webpage

     show_stringdb_message("Fetching StringDB link to new webpage....",'blue');

     // NOTE: No ? or & at start of this:
     var stringdb_options = 'species='+encodeURIComponent(taxid) + '&network_flavor='+network_flavor + '&show_query_node_labels=1' + '&required_score='+required_score + '&additional_network_nodes='+additional_network_nodes + '&caller_identity='+encodeURIComponent(stringdb_caller_identity);

     // STRING understands both GET and POST requests. GET requests, although simpler to use, have a character limit, therefore it is recommended to use POST whenever possible.
     // https://string-db.org/cgi/help.pl?subpage=api%23linking-to-the-network-on-string-webpage
     var stringdb_getlink_url = 'https://string-db.org/api/tsv-no-header/get_link'; // or: "https://version-11-5.string-db.org/api"


     // identifiers : required parameter for multiple items, e.g. DRD1_HUMAN%0dDRD2_HUMAN
     // "%0d" is carriage return: \r
     // whereas "%0a" is newline: \n
     // https://en.wikipedia.org/wiki/Newline
     
     // if (url.length > 2028) {url = url.substring(0,2048);} - but I should really trim genelist rather than just cutting string.

     // https://stackoverflow.com/questions/247483/http-get-request-in-javascript
   //var useGET = true;
   var useGET = false; // to use POST. Works okay with my 200 gene subset, but gives a CORS error with the full 2000 genes.

   if (useGET) {
     var xhr = new XMLHttpRequest();
     try {
        // Just the first 300 here: - does start with & here:
        var stringdb_identifiers = '&identifiers='+ encodeURIComponent(selected_gene_list.slice(0,300).join('\r'));
        var url = stringdb_getlink_url + '?' + stringdb_options + stringdb_identifiers;       
        xhr.open( "GET", url, false ); // false for synchronous request
        // xhr.setRequestHeader(); // To overcome the same origin restriction. must be after open() and before send() 
        // xhr.setRequestHeader('Content-Type', 'text/plain');
        xhr.send( null );
        alert(xhr.responseText);
        enable_stringdb_buttons(false); // false means they're not disabled.
        var url = xhr.responseText;
        show_stringdb_message('get: Retrieved the StringDB link okay.<br>If your browser doesn\'t automatically open String in a new tab, then click this link: <a href="'+url+'" target="_blank">'+url+'</a>','green');

//alert(url);

//////        window.open(url, '_blank'); // .focus(); // open may be blocked by popup blocker.
        document.getElementById("stringdb_in_newtab_anchor_link").href = url;

        // http_request.withCredentials = true;
     } catch(err) {
        msg = "get: Request for StringDB link failed: '"+err.message+"'\nThis is probably due to blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.";
        show_stringdb_message(msg.substr(0,200),'red');
        alert(msg);
        enable_stringdb_buttons(false); // false means they're not disabled.
        //return false;
     }
      // Currently getting error about:
      //     "Access to XMLHttpRequest at .... from origin 'null' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.

  } else { // So use POST as useGET is false
  

// https://string-db.org/cgi/input.pl?input_page_active_form=organisms

     // Or better to use an async request:     
     // synchronous requests are discouraged and will generate a warning along the lines of:
     // Note: Starting with Gecko 30.0 (Firefox 30.0 / Thunderbird 30.0 / SeaMonkey 2.27), synchronous requests on the main thread have been deprecated due to the negative effects to the user experience.
     // You should make an asynchronous request and handle the response inside an event handler.
     // function httpGetAsync(theUrl, callback) {
     //    var xmlHttp = new XMLHttpRequest();
     //    xmlHttp.onreadystatechange = function() { 
     //    if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
     //       callback(xmlHttp.responseText);
     //    }
     //    xmlHttp.open("GET", theUrl, true); // true for asynchronous 
     //    xmlHttp.send(null);
     // }

     // For gProfiler is:  var url = 'https://biit.cs.ut.ee/gprofiler/gost?organism='+gprofiler_id+'&query=' + encodeURIComponent(selected_gene_list.join("%0A")); 
     // '%0A' will be the URL-encoding of a newline. eg: https://biit.cs.ut.ee/gprofiler/gost?organism=mmusculus&query=VEGFA%0AVEGFB

    
     // POST isn't limited to first 300 here:
     var stringdb_identifiers = '&identifiers='+ encodeURIComponent(selected_gene_list.slice(0,1000).join('\r'));

     // I'll change this to POST in future.

//    escape() will not encode: @*/+
//    encodeURI() will not encode: ~!@#$&*()=:/,;?+'
//    encodeURIComponent() will not encode: ~!*()'


// https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send

     //var useAsync = true;
     var useAsync = false;
     var xhr = new XMLHttpRequest();
     try {
        xhr.open("POST", stringdb_getlink_url, useAsync); // true means async.

        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded"); // Send the proper header information along with the request.
        // For JSON data use: xhr.setRequestHeader('Content-Type', 'application/json');
        
        // For sync:
        if (!useAsync)
         xhr.onload = function() {
          var url = this.responseText;
          document.getElementById("stringdb_in_newtab_anchor_link").href = url;
          //alert("onload(): "+url);
          show_stringdb_message('post onload(): Retrieved the StringDB link okay.<br>If your browser doesn\'t automatically open String in a new tab, then click this liink: <a href="'+url+'" target="_blank">'+url+'</a>','green');
          };

        // Async:  'onreadystatechange' should not be used with synchronous requests and must not be used from native code.
        if (useAsync)
         xhr.onreadystatechange = function() { // Call a function when the state changes.
          if (xhr.readyState === XMLHttpRequest.DONE) {  // DONE is 4
            // In local files, status is 0 upon success in Mozilla Firefox so could test: const status = xhr.status;   if (status === 0 || (status >= 200 && status < 400)) {
            if (xhr.status === 200) {
              // Request finished successfully. Do processing here.
              var url = xhr.responseText;
              console.log(url);
              alert("POST response="+url);

              enable_stringdb_buttons(false); // false means they're not disabled.
              show_stringdb_message('post onreadystatechange(): Retrieved the StringDB link okay.<br>If your browser doesn\'t automatically open String in a new tab, then click this liink: <a href="'+url+'" target="_blank">'+url+'</a>','green');

              //document.getElementById("form_stringdb").action = url;
              //document.getElementById("stringdb_in_newtab_anchor_link").href = url;
//              document.getElementById("form_stringdb_to").value = url;  // As using async then too late to set the href for the anchor.
              
              window.open(url, '_blank'); // .focus();  // Chrome give Popup blocked message in address bar.
              
            } else {
              console.log("status:",xhr.status, "  responseText:",xhr.responseText);
        
        //var msg = "Request for StringDB link failed: '"+err.message+"'\nThis is probably due to blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.";
        //show_stringdb_message(msg.substr(0,200),'red');
        //alert(msg);
              enable_stringdb_buttons(false); // false means they're not disabled.

              alert("status: "+xhr.status +"  responseText: "+xhr.responseText);
            }
          }
        }; // end of: xhr.onreadystatechange = function() {....
     
        xhr.send( stringdb_options + stringdb_identifiers ); // eg: "foo=bar&lorem=ipsum");

        // xhr.send(new Int8Array());
        // xhr.send(document);

     } catch(err) {
        msg = "POST Request for StringDB link failed: '"+err.message+"'\nThis is probably due to blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.";
        show_stringdb_message(msg.substr(0,200),'red');
        alert(msg);
        enable_stringdb_buttons(false); // false means they're not disabled.
        //return false;
     }
} // end of if (useGET) {...} else {...
/*
========
// or can use FormData: https://developer.mozilla.org/en-US/docs/Web/API/FormData 
// https://devsheet.com/code-snippet/xhr-post-request-with-form-data-javascript/
var data = new FormData();
data.append('username', 'username');
data.append('email', 'email');

var xhr = new XMLHttpRequest();
xhr.open('POST', 'api_url', true);
xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
xhr.onload = function () {
    // YOU WILL FIND RESPONSE HERE
    console.log(this.responseText);
};
xhr.send(data);
*/





  } else alert("stringdb(): Unexpected param value: "+embedded_or_in_newtab);

  enable_stringdb_buttons(false);
  // Don't disable the enable_stringdb_species_radio_group();
}


function gene_symbol_type_is_gene_or_protein(propercase) {
  var gene_symbol_type = document.getElementById('gene_symbol_type').value,
      gene_or_protein = ['ENSEMBL_PROTEIN_ID', 'REFSEQ_PROTEIN', 'UNIPROT_ID'].indexOf(gene_symbol_type) >= 0 ? 'protein' : 'gene'; 

  if (propercase) gene_or_protein = gene_or_protein.charAt(0).toUpperCase() + gene_or_protein.substr(1); // Make first lettre of gene or Protein a capital.
  return gene_or_protein;
}


function gene_symbol_type_changed() {
  var gene_or_protein = gene_symbol_type_is_gene_or_protein(true), // true for proper case: Gene or Protein.
      genename_or_protein_heading = document.getElementById('genename_or_protein_heading');

  // BUT when reading HIVE format this heatmap isn't displayed until later and this heading will already have been set when saving the single HIVE format file. 
  // so genename_or_protein_heading, logfcs, and head1 are all undefined or null. 

  if (genename_or_protein_heading) genename_or_protein_heading.innerHTML = gene_or_protein; // The top left Gene' heading in the Heatmap table. 
   
  if (logfcs && logfcs.length > 0 && logfcs[0].length > 0) logfcs[0][0] = gene_or_protein;
  if (head1 && head1.length > 0) head1[0] = gene_or_protein;
}



// DAVID Bioinformatics Resources - Laboratory of Human Retrovirology and Immunoinformatics (LHRI)
//   https://david.ncifcrf.gov/content.jsp?file=DAVID_API.html
// https://david.ncifcrf.gov/content.jsp?file=documentation.html#LargeList


function DAVID() {

  var gene_symbol_type = document.getElementById('gene_symbol_type').value, // Not used here for DAVID.
      david_tool_name  = document.getElementById('david_tool_name').value;

}

/*
For "tool" tag:
<label for="david_tool_name">DAVID Tool name:</label>
<select id ="david_tool_name"">
<option value="gene2gene">Gene Functional Classification</option>
<option value="term2term">Funtional Annotation Clustering</option>
<option value="summary">Functional Annotation Summary</option>
<option value="chartReport">Functional Annotation Chart</option>
<option value="annotationReport">Functional Annotation Table</option>
<option value="list">Show Gene List Names in Batch</option>
<option value="geneReport">Gene Report</option>
<option value="geneReportFull">Gene Full Report</option>
</select>
*/


/* DAVID  For "type" tag:
Valid Values
 AFFYMETRIX_3PRIME_IVT_ID
 AFFYMETRIX_EXON_GENE_ID
 AFFYMETRIX_SNP_ID
 AGILENT_CHIP_ID
 AGILENT_ID
 AGILENT_OLIGO_ID
 ENSEMBL_GENE_ID
 ENSEMBL_TRANSCRIPT_ID
 ENTREZ_GENE_ID
 FLYBASE_GENE_ID
 FLYBASE_TRANSCRIPT_ID
 GENBANK_ACCESSION
 GENPEPT_ACCESSION
 GENOMIC_GI_ACCESSION
 PROTEIN_GI_ACCESSION
 ILLUMINA_ID
 IPI_ID
 MGI_ID
 GENE_SYMBOL  <-- now is OFFICIAL_GENE_SYMBOL ?
 PFAM_ID
 PIR_ACCESSION
 PIR_ID
 PIR_NREF_ID
 REFSEQ_GENOMIC
 REFSEQ_MRNA
 REFSEQ_PROTEIN
 REFSEQ_RNA
 RGD_ID
 SGD_ID
 TAIR_ID
 UCSC_GENE_ID
 UNIGENE
 UNIPROT_ACCESSION
 UNIPROT_ID
 UNIREF100_ID
 WORMBASE_GENE_ID
 WORMPEP_ID
 ZFIN_ID
 */



function elem(id) {
  return document.getElementById(id);
}


function swap_classes(elem, class1, class2) {
  // Returns:  1 if change to class2, 
  //      or: -1 if change to class1
  //      or:  0 if elem has neither class1 nor class2

  var result = 0;

  if (! elem ) {alert("swap_classes() elem not defined."); return 0;} 

  // element.classList needs:  Chrome 22, Edge 16, Firefox 3.6, Safari 7, etc: https://developer.mozilla.org/en-US/docs/Web/API/Element/classList#browser_compatibility 
  // For older browsers fallback to using elem.className:  https://codereview.stackexchange.com/questions/235353/classlist-fallback-ie-older-browsers

  if ('classList' in elem) { // or: if (classList' in Element.prototype) ...
    // Use elem.classList:
    if (elem.classList.contains(class1)) {
      elem.classList.remove(class1);
      elem.classList.add(class2);
      result = 1;
    } else if (elem.classList.contains(class2)) {
      elem.classList.remove(class2);
      elem.classList.add(class1);
      result = -1;
    }
  }
  else {
    // Use elem.className:

    // Previously: alert("You need at least:\nChrome version 22\nor Edge 16\nor Firefox 3.6\n or Safari 7\netc\nhttps://developer.mozilla.org/en-US/docs/Web/API/Element/classList#browser_compatibility"); return;}

     var list = elem.className.split(/\s/),
         index = list.indexOf(class1);
     
     if (index >= 0) {
       list[index] = class2;
       elem.className = list.join(" ");
       result = 1;
     }
     else {
        index = list.indexOf(class2);
        if (index >= 0) {
          list[index] = class1;
          elem.className = list.join(" ");
          result = -1;
        }
     }
  } // end of: if ('classList' in elem.prototype) ...
  
  if (result === 0) alert("ERROR: swap_classes() elem_id: "+elem.id+" is missing: "+class1+" and "+class2);

  return result;
}



function show_hide_table_row(name, show) {
  // To show or hide the stringdb, gprofiler, etc tables.
  // var td = document.getElementById(name+'_table_row'),

  var table = document.getElementById(name+'_table'),
      button = document.getElementById('show_hide_'+name+'_table_button');

  if (typeof show !== 'undefined' && ( (show && button.innerHTML === "Hide") || (!show && button.innerHTML === "Show") )) return; // As no change needed.
   
  var result = swap_classes(table, "tool_table_hide_td", "tool_table_show_td"); // returns 1 if change to tool_table_show_td, or -1 if change to tool_table_hide_td

  if (result !== 0) button.innerHTML = result > 0 ? "Hide" : "Show";
 
/* 
  if (!('classList' in table.prototype)) {
    // alert("You need at least:\nChrome version 22\nor Edge 16\nor Firefox 3.6\n or Safari 7\netc\nhttps://developer.mozilla.org/en-US/docs/Web/API/Element/classList#browser_compatibility"); return;}
    // element.classList needs:  Chrome 22, Edge 16, Firefox 3.6, Safari 7, etc: https://developer.mozilla.org/en-US/docs/Web/API/Element/classList#browser_compatibility 
    // For older browsers could fallback to using: className:  https://codereview.stackexchange.com/questions/235353/classlist-fallback-ie-older-browsers
     var classList = table.className.split(/\s/),
          index = classList.indexOf("tool_table_hide_td");
     
     if (index >= 0) {
       classList[index] = "tool_table_show_td";
       button.innerHTML = "Hide";
     }
     else {
        index = classList.indexOf("tool_table_show_td");
        if (index >= 0) {
          classList[index] = "tool_table_hide_td";
          button.innerHTML = "Show";
        }
        else {alert("ERROR: show_hide_table_row() table "+table.id+" is missing tool_table_hide_td or tool_table_show_td"); return;}
     }
     table.className = classList.join(" ");
  }

  // else using table.classList:
  if (table.classList.contains("tool_table_hide_td")) {
    table.classList.remove("tool_table_hide_td");
    table.classList.add("tool_table_show_td");
    // td.style.display = '';
    button.innerHTML = "Hide";
  } else if (table.classList.contains("tool_table_show_td")) {
    table.classList.remove("tool_table_show_td");
    table.classList.add("tool_table_hide_td");
    // td.style.display = 'none';
    button.innerHTML = "Show";
  }
  else {alert("ERROR: show_hide_table_row() table "+table.id+" is missing tool_table_hide_td or tool_table_show_td"); return;}
  // or use:  ....toggle("tool_table_hide_td") ....toggle("tool_table_show_td")
*/

}


function show_hide_select_column_checkboxes() {
  document.getElementById("heatmap_image_select_columns_span").style.display = (document.getElementById("heatmap_images_rows_select").value === "selectedcolumns") ? '' : 'none';
}


//function enable_stringdb_buttons(disabled=false) { // default param value only in Javascript version ES 6
function enable_stringdb_buttons(disabled) {
//alert("enable_stringdb_buttons() "+disabled);

  var button_class = (selected_gene_list.length===0 || taxid==="" || disabled) ? "" : "big_red"; // blue or red.
 
  document.getElementById('stringdb_embedded_button').class = document.getElementById('stringdb_in_newtab_button').class = button_class;

//  document.getElementById('stringdb_embedded_button').style.backgroundColor = document.getElementById('stringdb_in_newtab_button').style.backgroundColor = bgcolor;


// could change class from red to blue ???
  //if (selected_gene_list.length===0 || taxid==="" || disabled) {
    //document.getElementById('stringdb_embedded_button').setAttribute("disabled", "disabled");
    //document.getElementById('stringdb_in_newtab_button').setAttribute("disabled", "disabled");
    // document.getElementById('form_stringdb_in_newtab_submit_button').setAttribute("disabled", "disabled");
  //} else {
    //document.getElementById('stringdb_embedded_button').removeAttribute("disabled");
    //document.getElementById('stringdb_in_newtab_button').removeAttribute("disabled");
    // document.getElementById('form_stringdb_in_newtab_submit_button').removeAttribute("disabled");
  //} 

}


function enable_copy_genelist_buttons(disabled) {
  if (selected_gene_list.length==0 || disabled) {
     document.getElementById('copy_genelist_button').setAttribute("disabled", "disabled");
     document.getElementById('copy_genelist_button_for_david').setAttribute("disabled", "disabled");
  }
  else {
     document.getElementById('copy_genelist_button').removeAttribute("disabled");
     document.getElementById('copy_genelist_button_for_david').removeAttribute("disabled");
  }
}

function enable_gprofiler_button(disabled) {
// alert("enable_gprofiler_button");
  if (selected_gene_list.length===0 || taxid === "" || disabled) document.getElementById('submit_gprofiler_button').setAttribute("disabled", "disabled");
  else document.getElementById('submit_gprofiler_button').removeAttribute("disabled");
}


function enable_david_button(disabled) {
// alert("enable_david_button");
  if (selected_gene_list.length===0 || taxid === "" || disabled) document.getElementById('submit_david_button').setAttribute("disabled", "disabled");
  else document.getElementById('submit_david_button').removeAttribute("disabled");
}


function set_stringdb_and_gprofiler_species_text(stringdb_organism_text) {
   document.getElementById('stringdb_species_text').innerHTML = stringdb_organism_text;
   document.getElementById('gprofiler_organism_text').innerHTML = stringdb_organism_text;
}



function enable_stringdb_species_radio_group() {
  if (selected_gene_list.length==0) {
    //document.getElementById('stringdb_species_mouse').setAttribute("disabled", "disabled");
    //document.getElementById('stringdb_species_human').setAttribute("disabled", "disabled");
    document.getElementById('stringdb_required_score').setAttribute("disabled", "disabled");
    document.getElementById('stringdb_additional_network_nodes').setAttribute("disabled", "disabled");   
    document.getElementById('stringdb_network_flavor').setAttribute("disabled", "disabled");    
  } else {
    //document.getElementById('stringdb_species_mouse').removeAttribute("disabled");
    //document.getElementById('stringdb_species_human').removeAttribute("disabled");
    document.getElementById('stringdb_required_score').removeAttribute("disabled");
    document.getElementById('stringdb_additional_network_nodes').removeAttribute("disabled");    
    document.getElementById('stringdb_network_flavor').removeAttribute("disabled");    
  }
}


function show_num_filtered_rows(row_count) {
  document.getElementById("sjb_tab4_label").innerHTML = '<span style="font-size: 80%">(4)</span> Filter rows:'+row_count;
}


function show_selected_genes() {
  var num = selected_gene_list.length;
  document.getElementById('sjb_tab5_label').innerHTML = '<span style="font-size: 80%">(5)</span> Selected genes:' + num;
  document.getElementById('num_selected_genes').innerHTML = num;
  document.getElementById('stringdb_num_selected_genes').innerHTML = num;
  document.getElementById('gprofiler_num_selected_genes').innerHTML = num;
  document.getElementById('david_num_selected_genes').innerHTML = num;
  document.getElementById('selected_genes').innerHTML = selected_gene_list.join(', ');
}

function remove_stringdb_image() {
  document.getElementById('stringEmbedded').innerHTML = "";
}

function show_genes_list_and_enable_stringdb_options() {  
  show_selected_genes();
  enable_stringdb_buttons(false);
  enable_gprofiler_button();
  enable_david_button();
  enable_copy_genelist_buttons();
  
  enable_stringdb_species_radio_group();
}

function select_gene(checkbox) {  
  var irow = Number(checkbox.id.substring(1)), // The checkbox has id="c'+i" where i is the row in the logfcs array.
      genename = logfcs[irow][0];
      
  if (checkbox.checked) selected_gene_list.push(genename);
  else {
    var pos = selected_gene_list.indexOf(genename);
    if (pos==-1) {show_loading_message('ERROR: select_gene() gene='+genename+' not in list: '+selected_gene_list.join(', '), 'red');}
    else selected_gene_list.splice(pos, 1); // removed the elem without leaving an undefined that delete(pos) would. See: https://www.w3schools.com/js/js_array_methods.asp 
  }
  show_genes_list_and_enable_stringdb_options();
}



var timer3 = null;
function select_genes(all_or_none) {
  // Called by the All or None buttons.
  set_filtering_progress(" <i>Working...</i>");


  // Using this setTimeout so that the above message is displayed, before running the following. Works in Chrome, but doesn't work in Firefox.
  // NOTE: document.getElementById('cbox').checked = false; to change the checked property; NOT .removeAttribute("checked");
  // As onclick="select_gene(this);" is used for the checkbox, then directly changing the checked property below shouldn't call select_gene
  // The setTimeout() method calls a function after a number of milliseconds.

//alert("selected_gene_list.length="+selected_gene_list.length);

  if (selected_gene_list.length > 0 && selected_gene_list.length < document.getElementById('heatmap_tbody').rows.length && !confirm('Clear the existing selected gene list?\n\n(These '+selected_gene_list.length+' genes are currently selected: '+selected_gene_list.splice(0,50).join(', ')+'...)')) {return;}

  timer3 = setTimeout(function() {
    
    // Empty selected list:
    selected_gene_list = [];

    if (all_or_none == 'none') { // clear the selected genes:
      // for (var i=0; i<selected_gene_list.length; i++) document.getElementById('c'+selected_gene_list[i]).checked = false;
      console.log("NONE clicked...");
      
      for (var i=1; i<logfcs.length; i++) {
         var cb = document.getElementById('c'+i); // 'c' + row in the logfcs array.
         if (cb) cb.checked = false;
      }

    } else if (all_or_none == 'all') {
      console.log("ALL clicked...");

/*
//        for (var i=0; i<selected_gene_list.length; i++) document.getElementById('c'+selected_gene_list[i]).checked = false;
         for (var i=1; i<logfcs.length; i++) { // starts at 1 as the first row is header.
            var cb = document.getElementById('c'+i);
            if (cb) cb.checked = false;
         }
        selected_gene_list = [];
      }
*/
//      alert("ALL clicked...");

      for (var i=1; i < logfcs.length; i++) {
         var tr = document.getElementById('r'+i);
         if (tr && tr.style.display !== 'none') {
            var cb = document.getElementById('c'+i); // 'c' + row in the logfcs array.
            cb.checked = true; // Not testing for 'if (cb) ...' as cb should exist if tr exists.
            selected_gene_list.push(logfcs[i][0]);
         }
      }


     /*
     Old method: 
      var tbody = document.getElementById('heatmap_tbody');
      var num_rows = tbody.rows.length;
      for (var i=0; i<num_rows; i++) {
        var row = tbody.rows[i];
        if (row.style.display == 'none') continue;

        var irow = Number(row.id.substring(1)), // The row has id="r'+i" where i is the row in the logfcs array.
            genename = logfcs[irow][0];

        if (selected_gene_list.indexOf(genename) !== -1) {
           if (document.getElementById('c'+irow).checked === false) {alert("ERROR: genename="+genename+" is in the selected_gene_list, but it's checkbox isn't checked."); return false;}
           continue; // This gene is already selected manually.
        }           
        // if (selected_gene_list.length >= 300) break; // As Stringdb won't use more

        document.getElementById('c'+irow).checked = true;

        selected_gene_list.push(genename);
      } // end of for(var i=...) loop
    */ 
    
    }
    else {alert("ERROR: select_genes(): all_or_none param is invalid: "+all_or_none); return false;}

  //To loop through the table cells in the row:
  // var cellLength = row.cells.length;
  //for (var y=0; y<cellLength; y+=1){
  //  var cell = row.cells[y];
    //do something with every cell here
  //}
    show_genes_list_and_enable_stringdb_options();
    set_filtering_progress(""); 
    timer3 = null;
  }, 10); // end of the setTimeout(

}

function get_selected_gene_row_numbers() {
  var selected_gene_rows = [];

  for (var i=1; i<logfcs.length; i++) { // correctly starst at i=1, not 0 as first row is headings.
    var cb = document.getElementById('c'+i);
    if (cb && cb.checked) selected_gene_rows.push(i);
    }
    
  return selected_gene_rows;
}


function show_read_input_data_message(msg,color,append) {
  // Eg: To show the loading table message.
  
  console.log("A: show_read_input_data_message()", msg, color);
  
  var elem = document.getElementById('read_input_data_message');

  if (append) elem.innerHTML += msg;
  else elem.innerHTML = msg;

  if (msg=="") elem.style.display = 'none'; // To hide the loading table message.
  else {
    if (elem.style.display === 'none') elem.style.display = '';
    if (color) elem.style.color = color;
  }
  
  console.log("B: show_read_input_data_message()", msg, color);

  // if do this within a timeout then should show the message instead of waiting until processing has finished.
}




function show_loading_message(msg,color,append) {
  // Eg: To show the loading table message.
  
  console.log("show_loading_message()", msg, color);
  
  var elem = document.getElementById('loading_heatmap_message');

  if (append) elem.innerHTML += msg;
  else elem.innerHTML = msg;

  if (msg=="") elem.style.display = 'none'; // To hide the loading table message.
  else {
    if (elem.style.display === 'none') elem.style.display = '';
    if (color) elem.style.color = color;
  }
  
  console.log("show_loading_message()", msg, color);

  // if do this within a timeout then should show the message instead of waiting until processing has finished.
}


function show_reading_and_loading_messages(msg,color,append) {
  // Show message on both tabs 1 and 2:
  show_read_input_data_message(msg,color,append);
  show_loading_message(msg,color,append);
}



function show_stringdb_message(msg,color) {
  // Eg: To show the loading table message.
  
  console.log("show_stringdb_message()", msg, color);
  
  var elem = document.getElementById('stringdb_message');
  elem.innerHTML = msg;
  if (msg=="") elem.style.display = 'none'; // To hide the loading table message.
  else {
    if (elem.style.display === 'none') elem.style.display = '';
    if (color) elem.style.color = color;
  }  
  console.log("show_stringdb_message()", msg, color);

  // if do this within a timeout then should show the message instead of waiting until processing has finished.
}



var timer4 = null;
function show_read_input_data_message_now(msg,color) {
  // Show show message immediately when the script is busy loading data.
  // setTimeout(show_loading_message, 0, msg,color); // no brackets after show_loading_message

  // Using this setTimeout so that the above message is displayed, before running the following. Works in Chrome, but doesn't work in Firefox.  
  // The setTimeout() method calls a function after a number of milliseconds.
  timer4 = setTimeout(function() {
    show_read_input_data_message(msg,color);
    timer4 = null;
  }, 10); // end of the setTimeout(
}


var timer5 = null;
function show_loading_message_now(msg,color) {
  // Show show message immediately when the script is busy loading data.
  // setTimeout(show_loading_message, 0, msg,color); // no brackets after show_loading_message

  // Using this setTimeout so that the above message is displayed, before running the following. Works in Chrome, but doesn't work in Firefox.  
  // The setTimeout() method calls a function after a number of milliseconds.
  timer5 = setTimeout(function() {
    show_loading_message(msg,color);
    timer5 = null;
  }, 10); // end of the setTimeout(
}



function start_loading_files(e) {
  var filename = document.getElementById("file_to_read").files[0].name;
  // Jan 2023: show_loading_message("Reading heatmap from file '"+filename+"'. (May take 10+ seconds) ...", 'green'); // Show show message even when busy
  //  - using "+delim_name+" as the column separator
  // BUT the 'show_loading_message' won't update the browser display which script is busy, unless use setTimeout(): https://stackoverflow.com/questions/1257924/page-not-updating-during-busy-javascript-code
}

function show_loading_progress(e) {
  if (e.lengthComputable) {
    //var filename = document.getElementById("file_to_read").files[0].name;
    //console.log("show_loading_progress()",e.loaded, e.total);
    // When downloading a resource using HTTP, this only counts the body of the HTTP message, and doesn't include headers and other overhead.
    //show_loading_message("Reading heatmap from file '"+filename+": " +e.loaded+ " of " +e.total+ " ...", 'green'); // Show show message even when busy
  }
}
 
 
function end_loading_files(e) {
  // Is called even if load fails.
  console.log("end_loading_files()",e.loaded, e.total);
}




function valid_file_content(data) {
  if (data.trim() === "")        {show_read_input_data_message("This file is empty. Please select another file.",'red'); return false;}
  if (data.indexOf('"') > -1)    {show_read_input_data_message("The file contains quotes (\") so need to use the Vanillaes/csv parser.",'red'); return false;}
  if (data.indexOf('\\,') > -1)  {show_read_input_data_message("The file contains escaped commas (eg: \\,) so need to use the Vanillaes/csv parser.",'red'); return false;}
  if (data.indexOf('\\\t') > -1) {show_read_input_data_message("The file contains escaped tabs (eg: \\tabcharacter) so need to use the Vanillaes/csv parser.",'red'); return false;}
  // maybe test for \newline ??

  return true;
}


function get_data_deliminator(line) {
  var delim = ',', delim_name = 'comma'; // could optionally use other characters for the delimiter
  if (line.indexOf('\t') > -1) {
    delim = '\t'; delim_name = 'tab-character';
  } else {
    var num_comma     = line.split(',') - 1;  // Number of commas in header line.
    // var num_tab    = line.split('\t') - 1; // Number of tabs in header line.
    var num_semicolon = line.split(';') - 1;  // Number of semi-colons in header line.
    // var num_space     = line.split(' ') - 1;  // Number of spaces in header line.
    if (num_semicolon > num_comma) {delim=';'; delim_name = 'semi-colon';}
  }
  return [delim, delim_name];
}



function initialise_global_data(headings) {
  // Code below changes the global variables, so removes the existing data:
  // so headings parm is array: ['Gene'] or ['Protein']

  num_cols = 0; // or 1? // num_cols is global variable.
  logfcs=[headings]; logpvs=[headings];
  pct1s=[headings];  pct2s=[headings];

  logsort = null; // For optional sorting of the heatmap.
  
  has_pct12_columns = has_pvalues_columns = false;
    
  fc_amounts = ['0.3', '0.5', '1', '1.5', '2', '2.5', '3', '4', '5'];
  times=[]; celltypes=[]; // empty the global arrays

  head1 = [headings[0]]; // The "Gene" or "Genename" column.
  head2 = [""];

  gene_dict = {}; // short for: ... = new Object(); used when reading multiple files.

  show_num_filtered_rows(0);
}


function set_fc_min_max_and_num_fc_in_cols() {
  // Initialise to MAX_VALUE (or can use: fc_min = Number.POSITIVE_INFINITY; fc_max = Number.NEGATIVE_INFINITY;)
  fc_min = Number.MAX_VALUE;
  fc_max = - Number.MAX_VALUE; 

  num_fc_in_cols = [null]; // number of non-zero fold-changes in each column. Set the zero index value to null as that is the Genename column.
  
  var num_cols = logfcs[1].length;

console.log("set_fc_min_max_and_num_fc_in_cols():  num_cols="+num_cols);  

  for (var i = 1; i < logfcs.length; i++) {
    num_fc_in_cols.push(0); // initialise the fold-change count for each column to zero.
    for (var j = 1; j < num_cols; j++) {
       var val = logfcs[i][j];
//console.log(i,j," val=",val);
       if (val === null) continue;
       if (val < fc_min) fc_min = val;
       if (val > fc_max) fc_max = val;
       if (val != 0) num_fc_in_cols[j]++;
    }
  }
console.log("set_fc_min_max_and_num_fc_in_cols():  fc_min="+fc_min+"  fc_max="+fc_max);      
}


function set_celltypes_and_times(head1,head2) {
console.log(head1,head2);
  for (var i=1; i<head1.length; i++) { // start at i=1 as first is the 'Gene' col
     if (celltypes.indexOf(head1[i]) === -1) celltypes.push(head1[i]); // top row of headings.
  }
  
  for (var i=1; i<head2.length; i++)
     if (times.indexOf(head2[i]) === -1) times.push(head2[i]); // second row of headings, ie. sub-headings.     
}


// Example file from Sara's email:
// "","p_val","avg_log2FC","pct.1","pct.2","p_val_adj"
// "CXCL8",5.2476816314673e-100,-3.16033832258014,0.055,0.686,1.23661617645527e-95
// "CCL4",1.89608153548613e-80,-1.6759541988392,0.072,0.635,4.46811613837307e-76
// "CCL3",8.0617792193165e-76,-2.39341945476018,0.032,0.556,1.89975827303193e-71
// "IL1B",1.08369197998738e-71,-2.54180493284885,0.015,0.496,2.55372015084026e-67



// ** Available fast csv reading libraries: 
// PapaParse is faster as can use worker thread, etc: https://github.com/mholt/PapaParse
// and CSV: https://github.com/vanillaes/csv 


/*
Reading CSV files that have quoted text, containing the deliminator:

// Aug 2022:
Joining - not so efficient as then need to remove the quotes at start and end too:

iCurrent = 
val=c[iCurrent];

iNext = ...

val=c[iCurrent];

startQuote = (charAt(0) === '"');

for (iNext = iCurrent; i< ....; i++)

  endQuote = (charAt(val.length-1) == '"')

if (startQuote && !endQuote) {
  iNext ++;
} // Join with next - could have more than one 

else if (!startQuote && endQuote) {
  error: 
}


==========================================================================================

Character by character walk:

after searching a subset of rows ....

for (i=... to ....)

  lastWasQuote=false; ???
  
  c = charAt(i);
  
  switch (c) {
    case sep: ',' or ';' or '\t'

    case '"':
      if (inQuote) {inQuote=false; lastWasQuote=true}
      else { ?? val[] = substr(.....) }

    case '\n': ....

    case '\r': just ignore .....
    default: val += c; 
  }

  if (c == '"') {}
  else if (c == inQuote) {
  
  }
  
  
  read header and first three rows then ask which is the correct column to use ....
  and confirm the deliminator if any question .... - like Excel import csv does.
==========================================================================================
*/

/*
Copied from my python script:


From: https://gpdb.docs.pivotal.io/6-4/admin_guide/load/topics/g-escaping-in-csv-formatted-files.html
"Escaping in CSV Formatted Files: By default, the escape character is a " (double quote) for CSV-formatted files. If you want to use a different escape character, use the ESCAPE clause of COPY, CREATE EXTERNAL TABLE or gpload to declare a different escape character. In cases where your selected escape character is present in your data, you can use it to escape itself."
"Note: In CSV mode, all characters are significant. A quoted value surrounded by white space, or any characters other than DELIMITER, includes those characters. This can cause errors if you import data from a system that pads CSV lines with white space to some fixed width. In this case, preprocess the CSV file to remove the trailing white space before importing the data into Greenplum Database.

RFC-4180, paragraph "If double-quotes are used to enclose fields, then a double-quote appearing inside a field must be escaped by preceding it with another double quote."

InPHP: "Note: Usually an enclosure character is escaped inside a field by doubling it; however, the escape character can be used as an alternative. So for the default parameter values "" and \" have the same meaning. Other than allowing to escape the enclosure character the escape character has no special meaning; it isn't even meant to escape itself."
https://www.php.net/manual/en/function.fgetcsv.php

Note:
The locale settings are taken into account by this function. If LC_CTYPE is e.g. en_US.UTF-8, strings in one-byte encodings may be read wrongly by this function.
https://www.php.net/manual/en/function.str-getcsv.php


According to RFC 4180 fields may contain CRLF which will cause any line reader to break the CSV file. Here is an updated version that parses CSV string:
https://stackoverflow.com/questions/8493195/how-can-i-parse-a-csv-string-with-javascript-which-contains-comma-in-data

// So in the following code: l is current letter, p is previous letter, r is index array or rows??, s means not inside quotes, i is the column in the 'row' array.
'use strict';
function csvToArray(text) {
    let p = '', row = [''], ret = [row], i = 0, r = 0, s = !0, l;
    for (l of text) {
        if ('"' === l) {
            if (s && l === p) row[i] += l; // so is an escaped double-quote ie: ""
            s = !s;  // switch from inside quotes
        }
        else if (',' === l && s) l = row[++i] = '';  // start next column
        else if ('\n' === l && s) { 
            if ('\r' === p) row[i] = row[i].slice(0, -1); // to remove the carriage-return character
            row = ret[++r] = [l = '']; i = 0;
        }
        else row[i] += l; // append this letter
        p = l;
    }
    return ret; // I assume 'ret' containts reference to row rather than a copy of row.
};

let test = '"one","two with escaped """" double quotes""","three, with, commas",four with no quotes,"five with CRLF\r\n"\r\n"2nd line one","two with escaped """" double quotes""","three, with, commas",four with no quotes,"five with CRLF\r\n"';
console.log(csvToArray(test));


===
Alternatively:
function csv2arr(str: string) {
    let line = ["",];
    const ret = [line,];
    let quote = false;

    for (let i = 0; i < str.length; i++) {
        const cur = str[i];
        const next = str[i + 1];

        if (!quote) {
            const cellIsEmpty = line[line.length - 1].length === 0;
            if (cur === '"' && cellIsEmpty) quote = true;
            else if (cur === ",") line.push("");
            else if (cur === "\r" && next === "\n") { line = ["",]; ret.push(line); i++; }
            else if (cur === "\n" || cur === "\r") { line = ["",]; ret.push(line); }
            else line[line.length - 1] += cur;
        } else {
            if (cur === '"' && next === '"') { line[line.length - 1] += cur; i++; }
            else if (cur === '"') quote = false;
            else line[line.length - 1] += cur;
        }
    }
    return ret;
}
// This should be top answer imho. I tested with a large dataset and this function perfoms about twice as fast compared to the current top answer by @ridgerunner. Plus it returns a 2D array and it doesn't rely on regex which makes it much easier to debug and less finicky about data input. – 
// what about supporting a CSV where the first row are the names of the columns?

====
//So Here's a non-regex solution:

function csvRowToArray(row, delimiter = ',', quoteChar = '"'){
    let nStart = 0, nEnd = 0, a=[], nRowLen=row.length, bQuotedValue;
    while (nStart <= nRowLen) {
        bQuotedValue = (row.charAt(nStart) === quoteChar);
        if (bQuotedValue) {
            nStart++;
            nEnd = row.indexOf(quoteChar + delimiter, nStart)
        } else {
            nEnd = row.indexOf(delimiter, nStart)
        }
        if (nEnd < 0) nEnd = nRowLen;
        a.push(row.substring(nStart,nEnd));
        nStart = nEnd + delimiter.length + (bQuotedValue ? 1 : 0)
    }
    return a;
}
// How it works:
// (1) Pass in the csv string in row.
// (2) While the start position of the next value is within the row, do the following:
//        If this value has been quoted, set nEnd to the closing quote.
//        Else if value has NOT been quoted, set nEnd to the next delimiter.
//        Add the value to an array.
//        Set nStart to nEnd plus the length of the delimeter.
// Sometimes it's good to write your own small function, rather than use a library. Your own code is going to perform well and use only a small footprint. In addition, you can easily tweak it to suit your own needs.
============
*/


var test = '"one","two with escaped """" double quotes""","three, with, commas",four with no quotes,"five with CRLF\r\n"\r\n"2nd line one","two with escaped """" double quotes""","three, with, commas",four with no quotes,"five with CRLF\r\n"';


//uncomment Sep 2022:
//From: https://stackoverflow.com/questions/8493195/how-can-i-parse-a-csv-string-with-javascript-which-contains-comma-in-data

//function csvToArray(text) {
function csvToArray(text, delim) {
    var p = '', row = [''], ret = [row], i = 0, r = 0, s = !0, l; // was 'let p =... but that needs ES6
    for (l of text) {
        if ('"' === l) {
            if (s && l === p) row[i] += l;
            s = !s;
        }
//      else if (',' === l && s) l = row[++i] = '';
        else if (delim === l && s) l = row[++i] = '';
        else if ('\n' === l && s) {
            if ('\r' === p) row[i] = row[i].slice(0, -1);
            row = ret[++r] = [l = '']; i = 0;
        }
        else row[i] += l;
        p = l;
    }
    return ret;
}

//console.log("csvToArray:\n",csvToArray(test));


/*
=====
'use strict';

function csvToArray(text) {
    var p = '', row = [''], ret = [row], i = 0, r = 0, s = !0, l;  // was 'let p =... but that needs ES6
    for (l of text) {
        if ('"' === l) {
            if (s && l === p) row[i] += l;
            s = !s;
        } else if (';' === l && s) l = row[++i] = '';
        else if ('\n' === l && s) {
            if ('\r' === p) row[i] = row[i].slice(0, -1);
            row = ret[++r] = [l = '']; i = 0;
        } else row[i] += l;
        p = l;
    }
    return ret;
};

let test = '"one";"two with escaped """" double quotes""";"three; with; commas";four with no quotes;"five with CRLF\r\n"\r\n"2nd line one";"two with escaped """" double quotes""";"three, with; commas and semicolons";four with no quotes;"five with CRLF\r\n"';

console.log(csvToArray(test));
// ================
*/


//uncomment Sep 2022:

// function csv2arr(str: string) {
//function csv2arr(str) {
function csv2arr(str, delim) {
    let line = ["",];
    const ret = [line,];
    let quote = false;

    for (let i = 0; i < str.length; i++) {
        const cur = str[i];
        const next = str[i + 1];

        if (!quote) {
            const cellIsEmpty = line[line.length - 1].length === 0;
            if (cur === '"' && cellIsEmpty) quote = true;
//            else if (cur === ",") line.push("");
            else if (cur === delim) line.push("");
            else if (cur === "\r" && next === "\n") { line = ["",]; ret.push(line); i++; }
            else if (cur === "\n" || cur === "\r") { line = ["",]; ret.push(line); }
            else line[line.length - 1] += cur;
        } else {
            if (cur === '"' && next === '"') { line[line.length - 1] += cur; i++; }
            else if (cur === '"') quote = false;
            else line[line.length - 1] += cur;
        }
    }
    return ret;
}

//console.log("csv2arr:\n",csv2arr(test, ','));


// ================
//uncomment Sep 2022:
// From: https://stackoverflow.com/questions/8493195/how-can-i-parse-a-csv-string-with-javascript-which-contains-comma-in-data

function csvRowToArray(row, delimiter = ',', quoteChar = '"'){
    let nStart = 0, nEnd = 0, a=[], nRowLen=row.length, bQuotedValue;
    while (nStart <= nRowLen) {
        bQuotedValue = (row.charAt(nStart) === quoteChar);
        if (bQuotedValue) {
            nStart++;
            nEnd = row.indexOf(quoteChar + delimiter, nStart);
        } else {
            nEnd = row.indexOf(delimiter, nStart);
        }
        if (nEnd < 0) nEnd = nRowLen;
        a.push(row.substring(nStart,nEnd));
        nStart = nEnd + delimiter.length + (bQuotedValue ? 1 : 0);
    }
    return a;
}

// How it works:
// 1. Pass in the csv string in row.
// 2. While the start position of the next value is within the row, do the following:
//    - If this value has been quoted, set nEnd to the closing quote.
//    - Else if value has NOT been quoted, set nEnd to the next delimiter.
//    - Add the value to an array.
//    - Set nStart to nEnd plus the length of the delimeter.

// Sometimes it's good to write your own small function, rather than use a library. Your own code is going to perform well and use only a small footprint. In addition, you can easily tweak it to suit your own needs.
// ==============


function set_heatmap_image_select_columns_checkboxes() { // param was 'headings', but using global head1, head2 now.
    // For selecting columns to plot downloadable heatmap image:
    var checkbox_html = "";
    if (head1.length !== head2.length) {alert("set_heatmap_image_select_columns_checkboxes(): head1.length !== head2.length"); return false;}
    for (var i=1; i<head1.length; i++) {
       var val = head1[i]+':'+head2[i];
       checkbox_html += '<input type="checkbox" id="'+i+'" name="headmap_image_select_columns" value="'+val+'">';
    }
    document.getElementById("heatmap_image_select_columns_span").innerHTML = checkbox_html;
}


function parse_single_file(evt, thefilename) {
    console.log("parse_single_file(): ",evt);
    
    var filename = document.getElementById("file_to_read").files[0].name;

    // This doesn't get get updated, even using setTimeout(..,0) inside show_read_input_data_message_now(..)
    // show_read_input_data_message_now("Reading heatmap from file '"+filename+"' - using "+delim_name+" as the column separator. (May take 10+ seconds) ...", 'green'); // Show show message even when busy

    // var data = e.target.result;

    return parse_single_file_data(evt.target.result, thefilename);
}



//var tab_instructions = 'You can use the above \'<span style="color: black;">(3) Display options\', \'(4) Filter rows\', \'(5) Selected genes</span>\', to browse this heatmap,<br> and the \'<span style="color: black;">(6) g:Profiler\', \'(7) STRING\' or \'(8) DAVID</span>\' tabs to send your selected genes to those servers,<br>and \'<span style="color: black;">(9) Heatmap image</span>\' tab to download the heatmap as an png or jpg image.';
var tab_instructions = "You can use the above '<b>(3) Display options</b>\, '<b>(4) Filter rows</b>', '<b>(5) Selected genes</b>', to browse this heatmap,<br> and the '<b>(6) g:Profiler</b>', '<b>(7) STRING</b>' or '<b>(8) DAVID</b>' tabs to send your selected genes to those servers,<br>and '<b>(9) Heatmap image</b>' tab to download the heatmap as an png or jpg image,<br>or '<b>(10) UpSet/Vein</b>' to view an UpSet/Vein-diagram-type table, and '<b>(11) Help/Feedback</b>' for help links and sending feedback.";



function parse_single_file_data(data, thefilename) {

    if (data.substr(0,5) !== 'HIVE:') {
       return parse_single_non_hive_file_data(data, thefilename);
       // return parse_multiple_file_data(data, thefilename); // As this is only one file parse_single_file_data
    }

    // Test if selected only one diff gene expression file:
    // if (data.indexOf('avg_log2FC') !== -1 || data.indexOf('avg_logFC')  !== -1 || data.indexOf('p_val_adj')  !== -1 || data.indexOf('p_val') !== -1 ) 

    var lines = data.split(/\r\n|\n/); // windows or linux newlines.
    if (lines.length == 0) {show_read_input_data_message("The file '"+thefilename+"' doesn't contain any lines of data.",'red'); return false;}
    if (lines.length <= 3) {show_read_input_data_message("The file '"+thefilename+"' contains only one line of data, perhaps the lines need to be separated with new-line characters?",'red'); return false;}
        
    if (!valid_file_content(data)) {show_read_input_data_message("This is NOT a valid 'HIVE:' format FILE", 'red', true); return false;} // test if file contains double-quoites or escaped commas

    var delim_info = get_data_deliminator(lines[0]); // check the first line for deliminator - for my HIVE format it will be a tab.
    var delim = delim_info[0], delim_name = delim_info[1];


//console.log("Loading message");

//alert("Pausing");

    // lines[0] = lines[0].substr(5); // To remove the starting 'HIVE:' which we've tested for above.

    var hive_parms = lines[0].split(delim); // lines[0] is hive params: HIVE:    Gene_symbol    species/organism.

    if (hive_parms[0] !== 'HIVE:') {alert("ERROR: Expected HIVE formatted input file to start with 'HIVE:'"); return;}

    // Set the gene symbol select:
    document.getElementById('gene_symbol_type').value = hive_parms[1]; // gene/protein symbol.
    gene_symbol_type_changed();

    // Set the species/organism selection, or OTHER:
    set_organism_species_selected(hive_parms[2]); // organism/species. - could be form select list or OTHER.

    var headings = lines[1].split(delim); // lines[1] is the column headings)
    
    if (headings.length < 2) {show_read_input_data_message("You need at least two columns in your file - eg. gene_name,value1,value2", 'red'); return false;}
    
    if (['gene','genename','gene_name','protein'].indexOf(headings[0].toLowerCase()) == -1 && !confirm("Expected the first column in the first line to be 'Gene' or 'Genename' or 'Gene_name' or 'Protein'. Continue?") ) return false;

    console.log("parse_single_file(): A");

    initialise_global_data(headings); // To empty the global arrays: head1, head2, logfcs, logpvs.

    num_cols = headings.length; // num_cols is global variable.
  
    console.log("parse_single_file(): B1");

    for (var i=1; i<num_cols; i++) {
       var c = headings[i].split(':'); // Using a limit 2 would exclude any more any extra ':' are just included in c[1]
       head1.push(c[0]);
       head2.push(c.length > 2 ? c.slice(1).join(':') : c.length > 1 ? c[1] : ""); // so using slice and join to include any extra ':', also Javascript will have c.length = 1 if string has nothing after the ':', eg: 'Retina:'
    }
console.log("parse_single_file_data(): head1=",head1);
console.log("parse_single_file_data(): head2=",head2);

    
    console.log("parse_single_file(): B2");
    
    // Number() is stricter than parseFloat(): https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/parseFloat
    // Set by initialise_global_data(): fc_min = Number.MAX_VALUE; fc_max = - Number.MAX_VALUE; // set to max value, or use: fc_min = Number.POSITIVE_INFINITY; fc_max = Number.NEGATIVE_INFINITY;



// April 2023: Look at line 1 to get number of cols. :::
   // then. if (file_has_pvalues) pv .....
   //if (file_has_pct12) .....  

// Global:

   // Already checked above for if (lines.length <= 2)  return. and (headings.length < 2)

    has_pvalues_columns = has_pct12_columns = false;

    var f, c = lines[2].split(delim); // lines[2] is the first line of actual values (as [0] is hive params, and [1] is the column headings)
    for (var j=1; j<c.length; j++) {
       f = c[j].trim().split(':');
       if (f.length > 1) {
          has_pvalues_columns = true;       
          if (f.length > 3) has_pct12_columns = true;
       }
    }

    // *** In JS: "Objects and arrays are pushed as a pointer to the original object. Built-in primitive types like numbers or booleans are pushed as a copy."
    // So need to create new Array(num_cols)'s for each line of the input data.
    var fc_row, pv_row, pct1_row, pct2_row;

    for (var i = 2; i < lines.length; i++) { // lines[2] is the first line of actual values (as [0] is hive params, and [1] is the column headings)
       if (lines[i].trim() == "") continue; // skip empty lines, eg. the final line is often empty.
       // if (lines[i].charAt(0) == "#") continue; // optionally ignore comment lines, that start with '#'?

       c = lines[i].split(delim);
       if (c.length != num_cols) {show_reading_and_loading_messages("At line "+(i+1)+" in the csv file, the number of columns is "+c.length+", but there are "+num_cols+" headings in the first line:\n"+lines[i], 'red'); return false;}
       
       fc_row = new Array(num_cols); fc_row[0] = c[0].replace(/</,'&lt;').replace(/>/,'&gt;'); // c[0] is the gene_name. Remove any html tag start or end characters from the gene name.
       // Leave this gene column undefined in the pvalue and pct arrays to reduce memory usage. In future I'll put gene into a separate array:
       if (has_pvalues_columns) {pv_row = new Array(num_cols);} // pv_row[0] = c[0];}
       if (has_pct12_columns) {  
         pct1_row = new Array(num_cols); // pct1_row[0] = c[0];
         pct2_row = new Array(num_cols); // pct2_row[0] = c[0];
       }

       for (var j=1; j<c.length; j++) {
         c[j] = c[j].trim();

         if (c[j] === "") {
            fc_row[j] = null; // So missing values are set to null, not zero. Or coul;d just leave as undefined.
            if (has_pvalues_columns) pv_row[j] = null;
            if (has_pct12_columns) {pct1_row[j] = pct2_row[j] = null;}
         }
         else {
            f = c[j].split(':'); // So can optionally have foldchange:pvalue:pct1:pct2
            // if (f[0] === "") {fc_row[j] = pv_row[j] = pct1_row[j] = pct2_row[j] = null;} // So missing values are set to null, not zero.
            fc_row[j] = Number(f[0]);
            if (isNaN(fc_row[j])) {show_reading_and_loading_messages("ERROR: invalid number: '"+f[0]+"' in "+c[j]+" in line "+(i+1)+ " column "+(j+1)+": " +lines[i], 'red'); return false;}
            // console.log("f",i,j,f);

            if (has_pvalues_columns) pv_row[j] = f[1]==="" ? null : Number(f[1]);
            
            if (has_pct12_columns) {  
               pct1_row[j] = f[2]==="" ? null : Number(f[2]);
               pct2_row[j] = f[3]==="" ? null : Number(f[3]);
            }
           // f[0] = f[0].trim();
//           var val = Number(c[j]); // Number(value) has stricter parsing (than parseFloat(value)), as converts to NaN for arguments with invalid characters anywhere.
//           c[j] = val;
           }
       }
//console.log("fc_row:",i,fc_row);       
       logfcs.push(fc_row); // alternatively could first initialise the rows array to the number of (lines.length - 1), then at the end delete any excess lines due to empty lines.

       if (has_pvalues_columns) logpvs.push(pv_row); // p-values and pct1/2 added now to my single-file format.
       
       if (has_pct12_columns) {    
         pct1s.push(pct1_row);
         pct2s.push(pct2_row);
       }

    } // end of: for (var i = 1; i < lines.length; i++) { ...


console.log("logfcs.length="+logfcs.length);
console.log("logpvs.length="+logpvs.length);

//for (var i=0; i< logfcs.length; i++) console.log("logfcs:",logfcs[i]);
//for (var i=0; i< logpvs.length; i++) console.log("logpvs:",logpvs[i]);

//alert("parse_single_file_data(): A");
  console.log("parse_single_file(): D");

  set_fc_min_max_and_num_fc_in_cols(); // Needs to before show_heatmap()
  
  set_celltypes_and_times(head1,head2);

  set_heatmap_image_select_columns_checkboxes(); // was headings, but using global head1,head2 now.

  
//alert("parse_single_file_data(): B");
  show_heatmap_scale(); // between fc_min and fc_max.
//alert("parse_single_file_data(): C");
  set_filter_menu_options(); // the fc_amount between fc_min and fc_max
  sort_data(null);
  
console.log("parse_single_file_data(): D");

  var thefilename_formatted = "'<i>"+thefilename+"</i>'";
  if (thefilename.indexOf('https://') > -1 || thefilename.indexOf('http://') > -1 || thefilename.indexOf('ftp://') > -1 ) {
     try {
       var url = new URL(thefilename);
       thefilename_formatted = "'<i>" + url.pathname.substring(url.pathname.lastIndexOf('/')+1) + "</i>' from: '<i>"+url.origin+"</i>'";
     } catch (err) {
       console.log("Invalid URL format: "+thefilename+" : "+err);
     }
  }

  show_heatmap();

  enable_sjb_tab(2, 3, true); // where tab 2 = 'Select ids/species/columns' tab, and 3 = 'Display options' tab - this Display options tab is shown now for HIVE file.
  enable_sjb_tab(4, 10, false); // To disable the rest of the tabs, as may be opening another set of files after previously loading files.

//  set_select_ids_species_columns_tab_color('red'); // don't set tab to red for the HIVE data file as HIVE contains the column details.

  show_reading_and_loading_messages("File: "+thefilename_formatted+" read successfully,<br>and <b>Heatmap is shown further below</b>.<br><br>Use the '<b><span style=\"color: white; background-color:red;\">(2) Select ids/species/columns</span></b>' tab (above) to check or select: (a) Gene/Protein identifier type, and (b) Species/Organism.<br><br>"+tab_instructions, 'green');

  // document.getElementById("unknown_column_types_tbody").innerHTML = buff;
  
  // show is: names_div_types_div or names_types_div or none
  
  show_select_column_names_and_types_div('none');
  
  show_input_data_parameters_table(true); // although show_headmap() is inside a timer.


console.log("parse_single_file_data(): E");
  // show_heatmap_show_image_size();
  }




 

// === 24 July 2023  => Start of edited:


function show_data_still_to_non_hive_parse_single_file_headings_to_user(filename, headings) {
  // Column types - find best for each one:
  
  var buff = "";
  
  for (var i=0; i< headings.length; i++) {

    var name = headings[i].trim(),
        name_split  = name.split('-'), // using a limit of 2 would ignore any third part.
        name_split1 = name_split[0].replace('_',' ').trim(),
        name_split2 = (name_split.length >1 ? (name_split.slice(1).join('-').replace('_',' ')) : "").trim(), // empty for now. BUT can be the part after - as "Items after the limit are excluded."
        input_main_name = '<input type="text" id="heading_main_name_' +(i+1)+ '" value="'+ name_split1 +'">',
        input_sub_name  = '<input type="text" id="heading_sub_name_'  +(i+1)+ '" value="'+ name_split2 +'">',
        name_lc = name.toLowerCase(),
        type = 'none';

    // Using lowercase:
    if      (name_lc.indexOf('gene') > -1 || name_lc.indexOf('protein') > -1 || name_lc.indexOf('name') > -1 || name_lc.indexOf('id') > -1) type = 'id';

    else if (name_lc.indexOf('log2fc') > -1 || name_lc.indexOf('logfc') > -1) type = 'fc';

    else if (name_lc.indexOf('p_val_adj') > -1 || name_lc.indexOf('p_val') > -1 || name_lc.indexOf('p_value') > -1 || name_lc.indexOf('pv') > -1 || name_lc.indexOf('fdr') > -1) type = 'pv';

    else if ( 'pct.1' === name_lc) type = 'pct1'; // pct.1 : The percentage of cells where the feature is detected in the first group
    else if ( 'pct.2' === name_lc) type = 'pct2'; // pct.2 : The percentage of cells where the feature is detected in the second group
    else type = 'none';

    var select_type = '<select id="heading_type_' +(i+1)+ '" onchange="disable_input_main_name_and_sub_name(this,'+(i)+')"> '+
                      '<option value="none"' +(type==='none' ? ' selected' : '')+ '>Don\'t use this column</option> '+
                      '<option value="id"'   +(type==='id'   ? ' selected' : '')+ '>Gene/Protein ID</option> '+
                      '<option value="fc"'   +(type==='fc'   ? ' selected' : '')+ '>Fold-change</option> '+
                      '<option value="pv"'   +(type==='pv'   ? ' selected' : '')+ '>P-value/FDR/q-value</option> ' +
                      '<option value="pct1"' +(type==='pct1' ? ' selected' : '')+ '>pct.1: percentage of cells where feature is detected in the first group</option> ' +
                      '<option value="pct2"' +(type==='pct2' ? ' selected' : '')+ '>pct.2: percentage of cells where feature is detected in the second group</option> ' +
                      '</select>'; //  <option value="other">Other</option> 

    input_main_name = input_main_name.replace(':LogFC','').replace(':FDR','').replace(': LogFC','').replace(': FDR',''); // replace is for the Diurnal_duplicates_removed.txt test file.

    if (type === 'id') {input_main_name = input_main_name.replace('<input','<input disabled'); input_sub_name = input_sub_name.replace('<input','<input disabled');} // As gene id applies to all columns.
    buff += '<tr id="unknown_column_names_and_types_tr_'+(i+1)+'" draggable="true" ondragstart="dragstart()" ondragover="dragover()" ondragend="dragend()" ondrop="drop()">' +
                '<td style="text-align:left;"> ('+(i+1)+')&nbsp; '+(name === '' ? '<i>[No Heading for this column]</i>' : '<b>'+name+'</b>')+'</td>' +
                '<td>'+input_main_name+'</td>' +
                '<td>'+input_sub_name+'</td> ' +
                '<td>'+select_type+'</td>' +
            '</tr>';
  }

// Needs: <tr >  <td>......</td> </tr>

  document.getElementById("unknown_column_types_tbody").innerHTML = "";
  document.getElementById("unknown_filenames_tbody").innerHTML = ""; // as only one input file.

  document.getElementById("unknown_column_names_and_types_tbody").innerHTML = buff;  // table has style: user-select: none; -webkit-user-select: none; // Safari   maybe:  -ms-user-select: none; /* IE 10+ and Edge */


// column_column_names_and_types_message

  // show is: names_div_types_div or names_types_div or none
  
  show_select_column_names_and_types_div('names_types_div');

  show_input_data_parameters_table(true);
}


function disable_input_main_name_and_sub_name(this_select, i) {
  document.getElementById("heading_main_name_"+(i+1)).disabled = (this_select.value === 'id'); 
  document.getElementById("heading_sub_name_" +(i+1)).disabled = (this_select.value === 'id');
}




function parse_single_non_hive_file_data(data, thefilename) {
  // called by: parse_single_file_data(...)
  

//  console.log("parse_multiple_files() event=",evt);
//  var data = evt.target.result;

  // Get the columns names from the filename:
  //var match = filename_regex.exec(thefilename); // whereas filename_regex.test(..) just returns true/false
  
  // if (match === null && !confirm("This file '"+filename+"' doesn't end with .csv, .tsv or .txt.\nAre you sure you have selected the correct file?\nFilename: '"+filename+"'\n(Press 'Yes' to continue, or 'No' to select another file.)") ) return false;
  
  //var thefilename_without_extn = (match === null) ? thefilename : match[1];

  // var filename_parts = thefilename_without_extn.split('-'); // using a limit of 2 would ignore any third part.

  //var head1_name = filename_parts[0],
  //    head2_name = filename_parts.length >1 ? filename_parts.slice(1).join('-') : ""; // empty for now. BUT can be the part after - as "Items after the limit are excluded."

  filenames_array.push(thefilename);

  // Get the data in the file:  

  // Format eg: DGEA-Results/uninfectedvsvirus1.csv
  //   "","p_val","avg_log2FC","pct.1","pct.2","p_val_adj"
  //   "MT-ATP6",2.49340207491595e-257,0.491379025422126,0.999,0.979,5.87570198953944e-253
  //   "MT-ND1",1.84459695034627e-171,0.478291215931857,0.986,0.931,4.34679271349099e-167


  // if (!valid_file_content(data)) return false;

  /*
  var lines = data.split(/\r\n|\n/); // windows or linux newlines.
  if (lines.length == 0) {show_loading_message("The file doesn't contain any lines of data.",'red'); return false;}
  if (lines.length == 1) {show_loading_message("The file contains only one line of data, perhaps the lines need to be separated with new-line characters?",'red'); return false;}
  */
  
  // var delim, delim_name;

  // var delim = '\t'; // Just use tab or comma for now.
  // alert(data.substr(0,500));

  var delim_info = get_data_deliminator(data.substr(0,500));
  var delim = delim_info[0], delim_name = delim_info[1];
  // alert("delim is: "+delim+" "+delim_name+ " for file: "+thefilename);
 
  //var arr = csvToArray(data, delim);
  var arr = csv2arr(data, delim); // returns A single empty row if no data: [["",],]
  if (arr.length === 0 || (arr.length === 1 && arr[0].length<2)) {show_reading_and_loading_messages("ERROR: parse_single_non_hive_file_data(): File is empty: "+thefilename, 'red'); return false;} 

  var headings = arr[0]; // should be:

  j_gene_id = 0; // global.

  // Test if selected only one diff gene expression file:
  // if (data.indexOf('avg_log2FC') !== -1 || data.indexOf('avg_logFC')  !== -1 || data.indexOf('p_val_adj')  !== -1 || data.indexOf('p_val') !== -1 ) 

  var err = "";

  // Test if this guess is working okay:

  if (arr.length > 1 && arr[1].length >= 1) {
     var gene_id = arr[1][j_gene_id];
     guess_identifier_type_and_species(gene_id);  // BUT THIS ASSUMES COLUMN 0 is GENE or PROTEIN.
  }


  if (err !== "") {
     show_reading_and_loading_messages(err, 'red', true);
     num_files_with_unknown_headings += 1;

     // If read all files, then ask user to identify unknown headings:

     // if (num_files_with_unknown_headings > 0 && (num_files_read + num_files_with_unknown_headings === num_files)) 

//     return false;
  }


  // initialise_data_still_to_parse(); // clear file_data_arrays, etc to [] - is already called in read_files() or read_from_url()

  add_to_file_data_still_to_parse(arr, headings);
  // Store the file data and column names to parse later after user tells us which columns to use: 
  // file_data_arrays.push(arr);
  // file_heading_arrays.push(headings);


// April 2023: Not needed here now:
//  var j_pct1 = headings.indexOf('pct.1');  // pct.1 : The percentage of cells where the feature is detected in the first group
//  var j_pct2 = headings.indexOf('pct.2');  // pct.2 : The percentage of cells where the feature is detected in the second group


// Apr 2023: if (num_files_read === num_files && num_files_with_unknown_headings === 0) .... so has finished reading files.
// So can directly call: parse_multiple_files_after_column_headings_assigned

  num_files_read ++; // Global - should only be 1 here.
  
  // if (num_files_read !== num_files) {alert("parse_multiple_files(): num_files_read !== num_files"); } // num_files_read (and similar to num_cols + 1) is global is number of files.

  show_data_still_to_non_hive_parse_single_file_headings_to_user(thefilename, headings);

  enable_sjb_tab(2, 2, true); // the 'Select ids/species/columns' tab
  // enable_sjb_tab(3, 3, false); // the 'Display options' tab. - for non-HIVE files, not showing Display options until after user sets column names & types and heatmap.  
  enable_sjb_tab(3, 10, false); // To disable the rest of the tabs, as may be opening another set of files after previously loading files.

  show_read_input_data_message('<br>&nbsp;<br>File read successfully.<br>&nbsp;<br>Now <b>click the \'<span style="color: white; background-color:red;">(2) Select ids/species/columns</span>\' tab</b> above.', 'green', true);

  set_select_ids_species_columns_tab_color('red');
}



function set_select_ids_species_columns_tab_color(colour) {
  document.getElementById("sjb_tab2_label").style.backgroundColor = colour;
}



var jfc_cols = [], jpv_cols = [], jpct1_cols = [], jpct2_cols = [];
function validate_single_non_hive_file_input_data_parameters() {

  var msg = "", last_main_name = "", last_sub_name = "", // same_name_as_previous_column = false,
      jfc_dict = {}, jpv_dict = {}, jpct1_dict = {}, jpct2_dict = {},
      names = [], // Local and different from headings array.
      rows = document.getElementById("unknown_column_names_and_types_tbody").rows;

  jfc_cols = []; jpv_cols = []; jpct1_cols = []; jpct2_cols = []; j_gene_id = -1;


      //jfc = -1, jpv = -1, jpct1 = -1, jpct2 = -1,
  
  // Reset these global dictionaries:
  
//alert("file_heading_arrays="+file_heading_arrays);

  var headings = file_heading_arrays[0];
  if (rows.length !== headings.length){ alert("ERROR: rows.length !== headings.length");} // headings isn't used below, just using the rwo ordering now.

  //  for (var i=0; i < headings.length; i++ ) {

  // Using the row ordering now, as user can reorder the rows by dragging them:
  // <tr id="unknown_column_names_and_types_tr_'+(i+1)" ...
  var tr_id_prefix_len = "unknown_column_names_and_types_tr_".length;
  for (var r = 0; r < rows.length; r++) {
     var row = rows[r],
         i = Number(row.id.substring(tr_id_prefix_len)) - 1; // Need -1 as starts ids are (i+1)
    
     var main_name = document.getElementById("heading_main_name_" +(i+1)).value.trim(),
         sub_name  = document.getElementById("heading_sub_name_"  +(i+1)).value.trim(),
         type      = document.getElementById("heading_type_"      +(i+1)).value;

     if (main_name.indexOf(':') > -1) {msg = "Column main name must not contain a colon (':'), but column ("+(i+1)+") does: '" + main_name+"'"; alert(msg); return false;} // or I could convert colon to comma, etc.
   
     if      (type === 'select') {msg = "Please select a column type for column ("+(i+1)+")"; alert(msg); return false;}
     
     else if (type === 'none') continue;

     else if (type === 'id') {
        if (j_gene_id !== -1) {msg = "You have selected two columns: (" + (j_gene_id+1) + ") and (" +(i+1)+ ") for 'Gene/Protein ID'. Please just select one column."; alert(msg); return false;}
        j_gene_id = i;
     }

     else {

        if (main_name == "") {
          if (last_main_name === "") {msg = "You need to set the column name for column ("+(i+1)+")"; alert(msg); return false;}
          main_name = last_main_name;
          if (sub_name == "") {
             sub_name = last_sub_name;
             document.getElementById("heading_sub_name_"  +(i+1)).value = sub_name;
          }
          // else {msg = "You need to set the main-column name for column ("+(i+1)+")"; alert(msg); return false;} // OR could assume this main name is same as previous column, ie:  
          // same_name_as_previous_column = true;
          document.getElementById("heading_main_name_" +(i+1)).value = main_name;
        }

        else if (main_name.toLowerCase() === last_main_name.toLowerCase() && sub_name.toLowerCase() === last_sub_name.toLowerCase()) { // Same sample as previous column:
          console.log("validate_single_non_hive_file_input_data_parameters(): column ("+(i+1)+") is same as the previous column.");
          // same_name_as_previous_column = true;
        }

        else {  // Not same sample as previous column, so reset column indexes:
          // same_name_as_previous_column = false; 
          // if (last_main_name)
          // Update the last name/subname:
          last_main_name = main_name;
          last_sub_name  = sub_name;
          // but columns don't need to be in order - ie. could have the 4 fold changes, then the four p-values.
          // jfc = jpv = jpct1 = jpct2 = -1; // but don't reset jid
        }
        var key = main_name.toLowerCase() + ':' + sub_name.toLowerCase(); // better to maybe use a different symbol than ':' or check for this symbol
        if (names.indexOf(key) === -1) {names.push(key); head1.push(main_name); head2.push(sub_name);}
        
        if      (type === 'fc')   {if (key in jfc_dict)   {msg = "At column ("+(i+1)+"): 'Fold-change' already selected at column ("+(jfc_dict[key]+1)+") for this sample";}                       jfc_dict[key]   = i;}
        else if (type === 'pv')   {if (key in jpv_dict)   {msg = "At column ("+(i+1)+"): 'P-value/FDR/q-value' already selected at column ("+(jpv_dict[key]+1)+") for this sample";}               jpv_dict[key]   = i;}
        else if (type === 'pct1') {if (key in jpct1_dict) {msg = "At column ("+(i+1)+"): 'pct.1: percentage of cells ....' already selected at column ("+(jpct1_dict[key]+1)+") for this sample";} jpct1_dict[key] = i;}
        else if (type === 'pct2') {if (key in jpct2_dict) {msg = "At column ("+(i+1)+"): 'pct.2: percentage of cells ....' already selected at column ("+(jpct2_dict[key]+1)+") for this sample";} jpct2_dict[key] = i;}
        else {msg = "Unexpected column type="+type + " for column ("+(i+1)+")";}
        if (msg !== "") {alert(msg); return false;}
     }

  } // end of: for (var i=0; i < file_heading_arrays.length; i++ ) ...

  // Check all columns have same set of column types
  // has_pct12_columns = false, has_pvalues_columns = false; Are initialised to false already in initialise_global_data()
  if (names.length === 0) {msg = "Please enter columns names, as column names.length === 0"; alert(msg); return false;}
  var key = names[0];

  if (!(key in jfc_dict)) {msg = "Please select a 'Fold-change' for "+head1[0] + " : " + head2[0]; alert(msg); return false;}

  var key_in_jpv_dict   = (key in jpv_dict),
      key_in_jpct1_dict = (key in jpct1_dict),
      key_in_jpct2_dict = (key in jpct2_dict);

  if (key_in_jpct1_dict !== key_in_jpct2_dict) {msg += "For column (1): pct.1: != pct.2\n";}

  for (var j=1; j<names.length; j++) {
    var key = names[j];
    if (!(key in jfc_dict)) msg += "You need to set 'Fold-change'\n"+head1[j] + " : " + head2[j] + " Please select that, or check spelling of name and main name as consistent.\n";
    if ((key in jpv_dict)   !== key_in_jpv_dict)   msg += " 'P-value/FDR/q-value' selected for "+head1[j] + " : " + head2[j] + " doesn't match first column: " +head1[0] + " : " + head2[0] + "\n";
    if ((key in jpct1_dict) !== key_in_jpct1_dict) msg += " 'pct.1: percentage of cells ....' selected for "+head1[j] + " : " + head2[j] + " doesn't match that for first column: " +head1[0] + " : " + head2[0] + "\n";
    if ((key in jpct2_dict) !== key_in_jpct2_dict) msg += " 'pct.2: percentage of cells ....' selected for "+head1[j] + " : " + head2[j] + " doesn't match that for first column: " +head1[0] + " : " + head2[0] + "\n";
  }

  if (msg !== "") {alert(msg); return false;}

  for (var j=0; j<names.length; j++) { // Thius names does NOT contain the gene id column,.
    var key = names[j];
    jfc_cols.push( jfc_dict[key] );
    if (key_in_jpv_dict)   jpv_cols.push( jpv_dict[key] );
    if (key_in_jpct1_dict) jpct1_cols.push( jpct1_dict[key] );
    if (key_in_jpct2_dict) jpct2_cols.push( jpct2_dict[key] );
  }

  has_pvalues_columns = key_in_jpv_dict;
  has_pct12_columns   = key_in_jpct1_dict && key_in_jpct2_dict;

console.log(jpv_dict, jpv_cols);
  return true;
}



function parse_single_non_hive_file_after_column_headings_assigned() {

//  file_data_arrays.push(arr);
//  file_heading_arrays.push(headings);

  show_reading_and_loading_messages("Checking column names and types, and drawing the heatmap ...\n", 'blue');

  initialise_global_data([gene_symbol_type_is_gene_or_protein(true)]); // so parm is ['Gene'] or ['Protein']
  
  if (!validate_single_non_hive_file_input_data_parameters()) return false; // validate_single_non_hive_file_input_data_parameters() gives error message and alert box.

  if (j_gene_id === -1) {alert("Gene/Protein column is NOT assigned."); return false;}
  // if (j_fc === -1) {alert("Fold-change column is NOT assigned"); return false;}


  if (num_files_read !== 1 || num_files !== 1) {alert("parse_single_non_hive_file_after_column_headings_assigned(): num_files_read(="+num_files_read+") + num_files_with_unknown_headings(="+num_files_with_unknown_headings+")  !== num_files="+num_files); return false;} // num_files_read (and similar to num_cols + 1) is global is number of files.

  // Don't really need these for the single non hive file:
  if (num_files !== file_data_arrays.length) {alert("num_files !== file_data_arrays.length"); return false;}
  if (file_data_arrays.length !== file_heading_arrays.length) {alert("file_data_arrays.length !== file_heading_arrays.length"); return false;}
  
  // Just initialises logfc,logpvs,etc to [['Gene',],] or [['Protein',]]  
  // num_cols is global is number of the current file being read.


/*
// The above initialise_global_data([gene_symbol_type_is_gene_or_protein(true)]); does:
function initialise_global_data(headings) {
  // Code below changes the global variables, so removes the existing data:

  num_cols = 0; // or 1? // num_cols is global variable.
  logfcs=[headings]; logpvs=[headings];
  pct1s=[headings];  pct2s=[headings];
  
  has_pct12_columns = has_pvalues_columns = false;
    
  fc_amounts = ['0.3', '0.5', '1.0', '1.5', '2.0', '2.5', '3.0'];
  times=[]; celltypes=[]; // empty the global arrays

  head1 = [headings[0]]; // The "Gene" or "Genename" column.
  head2 = [""];

  gene_dict = {}; // short for: ... = new Object(); used when reading multiple files.

} 
*/



//alert("parse_multiple_files_after_column_headings_assigned(): head1="+head1);

  // num_files_read = 0; // global var is reset to zero here.

 // var col_num = 0; // for reading multiple files into the array columns.
  


  // jheadings is different from file_heading_arrays
  for (var j=1; j < head1.length; j++) { // j correctly starts at 1 here as logfcs[0][0] is already set to Gene, and head1[0] is already set to Gene by the above initialise_global_data(...)
    logfcs[0].push(head1[j] + (head2[j] === "" ? "" : ':'+head2[j])); // To match the format for single my file data, so we can easily write data in my single-file format.
  }
    // var key = head1[j] + ':' + head2[j];


  // col_num++;  // incremented here so is ifile+1. col_num is global, and set to zero by initialise_global_data above. Is correctly incremented here before logfcs[0].push(head1[col_num] as head1[col_num] is 'Gene' which is already in 

  // BUT logfcs[0][0] is already set to 'Gene' and head1[0] is also 'Gene' so will get logfcs[0]= ['Gene','Gene', ..], so need to use ifile+1 ie:  logfcs[0].push(head1[ifile+1]

  var lines = file_data_arrays[0],
     thefilename = filenames_array[0];

  // returns A single empty row if no data: [["",],]


    // *** In JS: "Objects and arrays are pushed as a pointer to the original object. Built-in primitive types like numbers or booleans are pushed as a copy."
    // So need to create new Array(num_cols)'s for each line of the input data.

  var num_cols_in_file = lines[0].length,
      num_cols = head1.length,
      num_fc_cols = jfc_cols.length,
      fc_row, pv_row, pct1_row, pct2_row;

if (num_fc_cols !== num_cols-1) alert("num_fc_cols="+num_fc_cols+" !== num_cols-1="+(num_cols-1));

  for (var i = 1; i < lines.length; i++) { // arr[1] is the first line of actual values (as arr[0] is the column headings)
       // if (lines[i].trim() == "") continue; // skip empty lines, eg. the final line is often empty.
       // if (lines[i].charAt(0) == "#") continue; // optionally ignore comment lines, that start with '#'?

       var c = lines[i]; // is already split into an array. .split(delim);
       if (c.length != num_cols_in_file) {
         if (c.length === 1 && c[0].trim() === "") continue; // As is an empty line - can happen at end of the input file, eg: file: Diurnal_duplicates_removed.txt.
         show_reading_and_loading_messages("At line "+(i+1)+" in the input file, the number of columns is "+c.length+", but there are "+num_cols_in_file+" headings in the first line:\n"+c, 'red');
         return false;
       }
       
       fc_row = new Array(num_cols); fc_row[0] = c[j_gene_id].replace(/</,'&lt;').replace(/>/,'&gt;'); // c[0] is the gene_name. Remove any html tag start or end characters from the gene name.
       // Leave this gene column undefined in the pvalue and pct arrays to reduce memory usage. In future I'll put gene into a separate array:
       if (has_pvalues_columns) {pv_row = new Array(num_cols);} // pv_row[0] = fc_row[0];}
       if (has_pct12_columns) {  
         pct1_row = new Array(num_cols); // pct1_row[0] = fc_row[0];
         pct2_row = new Array(num_cols); // pct2_row[0] = fc_row[0];
       }

       for (var j=0; j<num_fc_cols; j++) {

     // console.log(j,"jfc_cols=",jfc_cols,"  jfc=",jfc, c, "  c[jfc]=",c[jfc]);
//alert("j="+j);
         var jfc = jfc_cols[j], 
             fc = c[jfc].trim();
         
         if (fc === "") {
            fc_row[j+1] = null; // So missing values are set to null, not zero. Or coul;d just leave as undefined.
            if (has_pvalues_columns) pv_row[j+1] = null;
            if (has_pct12_columns) {pct1_row[j+1] = pct2_row[j+1] = null;}
         }
         else {
            // f = c[j].split(':'); // So can optionally have foldchange:pvalue:pct1:pct2
            // if (f[0] === "") {fc_row[j] = pv_row[j] = pct1_row[j] = pct2_row[j] = null;} // So missing values are set to null, not zero.
            fc_row[j+1] = Number(fc); // The j+1 is becuase the first col is gene name.
            if (isNaN(fc_row[j+1])) {show_reading_and_loading_messages("ERROR: invalid number: '"+fc+"' in line "+(i+1)+ " column "+(jfc+1)+": " +lines[i], 'red'); return false;}
            // console.log("f",i,j,f);
//console.log("j=",j,"  jpv_cols[j]=",jpv_cols[j], "c=",c);
            if (has_pvalues_columns) {var jpv = jpv_cols[j]; pv_row[j+1] = c[jpv]==="" ? null : Number(c[jpv]);}
         
            if (has_pct12_columns) {
               var jpct1 = jpct1_cols[j]; pct1_row[j+1] = c[jpct1]==="" ? null : Number(c[jpct1]);
               var jpct2 = jpct2_cols[j]; pct2_row[j+1] = c[jpct2]==="" ? null : Number(c[jpct2]);
            }
           // f[0] = f[0].trim();
//           var val = Number(c[j]); // Number(value) has stricter parsing (than parseFloat(value)), as converts to NaN for arguments with invalid characters anywhere.
//           c[j] = val;
         }
       }
//console.log("fc_row:",i,fc_row);       

//       console.log("fc_row",i,fc_row);

       logfcs.push(fc_row); // alternatively could first initialise the rows array to the number of (lines.length - 1), then at the end delete any excess lines due to empty lines.

       if (has_pvalues_columns) logpvs.push(pv_row); // p-values and pct1/2 added now to my single-file format.
       
       if (has_pct12_columns) {    
         pct1s.push(pct1_row);
         pct2s.push(pct2_row);
       }

    } // end of: for (var i = 1; i < lines.length; i++) ...


  set_fc_min_max_and_num_fc_in_cols(); // Needs to before show_heatmap()
  
  set_celltypes_and_times(head1,head2);

  set_heatmap_image_select_columns_checkboxes(); // was headings, but using the global head1,head2 arrays now.

  show_heatmap_scale(); // between fc_min and fc_max.
  set_filter_menu_options(); // the fc_amount between fc_min and fc_max
  sort_data(null);

  show_heatmap();
  
  show_hide_download_single_data_file_link(true); // I show this later if read multiple DGE files.

  show_reading_and_loading_messages(tab_instructions, 'green');
 
    // draw_heatmap_show_image_size();
//  }
//  else if (col_num > num_files) {alert("ERROR: parse_multiple_files(): col_num="+col_num+" > num_files="+num_files); return false;}
//  else {alert("ERROR: num_files_read(="+num_files_read+") !== num_files(="+num_files+")"); return false;} // This shouldn't happen.


  return true; // for success.
}


// === 24 July 2023  => first End of edited.


// === 24 July 2023  => End of edited.





var file_data_arrays, filenames_array, file_heading_arrays, unknown_column_types_array, unknown_column_types_file_indexes, unknown_column_types_column_indexes;

function initialise_data_still_to_parse() {
  console.log("initialise_data_still_to_parse()");
  file_data_arrays = [];
  filenames_array = [];
  file_heading_arrays = [];
  unknown_column_types_array = [];
  unknown_column_types_file_indexes = [];
  unknown_column_types_column_indexes = []; 
}

//   filenames_array.push(filename); - read-add this later.
function add_to_file_data_still_to_parse(arr, headings) {
  // Store the file data and column names to parse later after user tells us which columns to use: 
  file_data_arrays.push(arr);
  file_heading_arrays.push(headings);
  var file_index = file_data_arrays.length - 1;

  for (var i=0; i<headings.length; i++) {
    var pos = unknown_column_types_array.indexOf(headings[i]);
    if (pos === -1) {
      unknown_column_types_array.push( headings[i] ); // the column heading text
      unknown_column_types_column_indexes.push( [i] ); // index of this column in heading array.
      unknown_column_types_file_indexes.push( [file_index] ); // index of the file containing this heading.
    }
    else {
      unknown_column_types_column_indexes.push( i ); // index of this column in heading array.
      unknown_column_types_file_indexes[pos].push( file_index ); // index of the file containing this heading.
    }
  }
  console.log("unknown_column_types_array:",unknown_column_types_array, "  unknown_column_types_file_indexes",unknown_column_types_file_indexes, "  unknown_column_types_column_indexes:",unknown_column_types_column_indexes);
}


function array_unique_items(arr) {
  var unique = [];
  for (var i=0; i<arr.length; i++)
    if (unique.indexOf(arr[i]) === -1) 
      unique.push(arr[i])

  // or EJ6: return arr.filter( function (value, index, array) {return array.indexOf(value) === index;} ); // returning true to filter keeps the item in the resulting array.
  
  return unique;
}


function array_increment_items_and_join(arr, sep, use_brackets) {
  var arr2 = [];
  if (use_brackets)
    for (var i=0; i<arr.length; i++) arr2.push( '(' + (arr[i]+1) + ')' );
  else   
    for (var i=0; i<arr.length; i++) arr2.push( arr[i]+1 );
    
  return arr2.join(sep);
}


function array_contents_differ(a,b) {
  if (a.length !== b.length) return true;
  var as=sort(a), bs=sort(b);
  for (var i=0; i<as.length; i++) 
     if (as[i] !== bs[i]) return true;

  return false;
}
/*  
  var unique_file_heading_array_indexes = [0];
  
  for (var i=1; i<file_heading_arrays.length; i++) { // start at i=1 as 0 will always be unique as is the first.

    for (var j=0; j<unique_file_heading_array_indexes.length; j++) { // start at j=0
      if (array_contents_differ( file_heading_arrays[i], file_heading_arrays[unique_file_heading_array_indexes[j]] ) 
        unique_file_heading_array_indexes.push(j);
    }
  }
*/


function show_data_still_to_parse_headings_to_user_for_multiple_files() {
  // Column types - find best for each one:
  var types = [];
  

  for (var i=0; i<unknown_column_types_array.length; i++) {

    var name = unknown_column_types_array[i].toLowerCase(),
        type;

    // Using lowercase, as name is sert to lowercase above:
    if      (['', 'gene_id', 'protein_id', 'genesymbol', 'id', 'row.names'].indexOf(name) > -1) type = 'id';
    else if (['avg_log2fc', 'avg_logfc', 'log2fc', 'logfc', 'log2foldchange'].indexOf(name) > -1) type = 'fc';
    else if (['p_val_adj', 'p_val', 'p_value', 'pvalue', 'fdr'].indexOf(name) > -1) {
      type = 'pv';
      // BUT give preference to using 'p_val_adj' instead of the unadjusted 'p_val'
      if (name==='p_val_adj' && types.indexOf('pv') > -1) types[types.indexOf('pv')] = 'none'; 
    }
    else if ( 'pct.1' === name) type = 'pct1'; // pct.1 : The percentage of cells where the feature is detected in the first group
    else if ( 'pct.2' === name) type = 'pct2'; // pct.2 : The percentage of cells where the feature is detected in the second group
    else type = 'none';
    types.push(type);
  }


  // if (j_gene_id < 0) j_gene_id = 0; // global set to 0.

  // Test if selected only one diff gene expression file:
  // if (data.indexOf('avg_log2FC') !== -1 || data.indexOf('avg_logFC')  !== -1 || data.indexOf('p_val_adj')  !== -1 || data.indexOf('p_val') !== -1 ) 


//  if (j_fc < 0) warn = "Warning: Neither 'avg_log2FC' [average log2-fold-change], nor 'avg_logFC' [average log-fold-change] columns were found in the file headings of '"+thefilename+"'.<br>";
//  else if (j_fc === 0) warn += "Warning: parse_multiple_files(): Expected Gene or Protein as the first column heading of file: '"+thefilename+"', but found column heading is: "+headings[j_fc]+"<br>";

//  if (j_pvalue < 0) warn += "Warning: p-value/FDR/q-value column 'p_val_adj' or 'p_val' or 'p_value' NOT found in the file headings of file: '"+thefilename+"'";
//  else if (j_pvalue === 0) warn += "Warning: parse_multiple_files(): Expected Gene or Protein as the first column heading of file: '"+thefilename+"', but found column heading is: "+headings[j_pvalue];


  // Test if this guess is working okay:
  // if (num_files_read===0 && arr.length > 1 && arr[1].length >= 1) {
  //   var gene_id = arr[1][j_gene_id];
  //   guess_identifier_type_and_species(gene_id);  // BUT THIS ASSUMES COLUMN 0 is GENE or PROTEIN.
  // }


  var buff = "";
  for (var i=0; i<unknown_column_types_array.length; i++) {

    var name = unknown_column_types_array[i],
        type = types[i],
        in_files,
        in_cols = array_increment_items_and_join( array_unique_items(unknown_column_types_column_indexes[i]), ',', false);

    if (unknown_column_types_file_indexes[i].length !== filenames_array.length) { // so column only occurs in some of the input files, not all. 
       in_files = array_increment_items_and_join( unknown_column_types_file_indexes[i], ',' , true); // don't need to do unique as the file indexes will be unique. true adds () arround each integer.
    }
    else in_files = "All";

    var select_type = '<select id="heading_type_' +(i+1)+ '" data-in_files="'+in_files+'" data-in_cols="'+in_cols+'" data-name="'+name+'"> '+
                      '<option value="none"' +(type==='none' ? ' selected' : '')+ '>Don\'t use this column</option> '+
                      '<option value="id"'   +(type==='id'   ? ' selected' : '')+ '>Gene/Protein ID</option> '+
                      '<option value="fc"'   +(type==='fc'   ? ' selected' : '')+ '>Fold-change</option> '+
                      '<option value="pv"'   +(type==='pv'   ? ' selected' : '')+ '>P-value/FDR/q-value</option> ' +
                      '<option value="pct1"' +(type==='pct1' ? ' selected' : '')+ '>pct.1: percentage of cells where feature is detected in the first group</option> ' +
                      '<option value="pct2"' +(type==='pct2' ? ' selected' : '')+ '>pct.2: percentage of cells where feature is detected in the second group</option> ' +
                      '</select>'; //  <option value="other">Other</option> 
    
    if (in_files !== "") in_files = " in files: " + in_files;
    buff += '<tr><td> '+(in_cols + in_files)+' </td>' +
                '<td style="text-align:left;">' +(name === '' ? '<i>[No Heading for this column]</i>' : '<b>'+name+'</b>')+ '</td>' +
                '<td>'+select_type+'</td></tr>';
                
                // <span id="heading_type_name_'+(i+1)+'">' +name+ '</span> - using data-name instead now.
  }
  document.getElementById("unknown_column_types_tbody").innerHTML = buff;



  // File names-> Column name & sub-name:
  buff = "";
  for (var i=0; i<filenames_array.length; i++) {
    //    var unknown_column_types_array[i].split('_')

    // Get the columns names from the filename:

    var filename = filenames_array[i].trim();

    var match = filename_regex.exec(filename); // whereas filename_regex.test(..) just returns true/false
    // if (match === null && !confirm("This file '"+filename+"' doesn't end with .csv, .tsv or .txt.\nAre you sure you have selected the correct file?\nFilename: '"+filename+"'\n(Press 'Yes' to continue, or 'No' to select another file.)") ) return false;
    var thefilename_without_extn = (match === null) ? filename : match[1];

    var filename_parts = thefilename_without_extn.split('-'); // using a limit of 2 would ignore any third part.

    var head1_name = filename_parts[0].replace('_',' '),
        head2_name = filename_parts.length >1 ? (filename_parts.slice(1).join('-').replace('_',' ')) : ""; // empty for now. BUT can be the part after - as "Items after the limit are excluded."
    
    var input_main_name = '<input type="text" id="heading_main_name_' +(i+1)+ '" value="'+ head1_name +'" size="30">',
        input_sub_name  = '<input type="text" id="heading_sub_name_'  +(i+1)+ '" value="'+ head2_name +'" size="30">';

    buff += '<tr id="unknown_filenames_tr_'+(i+1)+'" draggable="true" ondragstart="dragstart()" ondragover="dragover()" ondragend="dragend()" ondrop="drop()">' +    
                '<td style="text-align:left;"> ('+(i+1)+')&nbsp; <b>'+filenames_array[i].trim()+'</b></td>' +
                '<td>'+input_main_name+'</td><td>'+input_sub_name+'</td></tr>';
  }
  document.getElementById("unknown_filenames_tbody").innerHTML = buff;  // table has style: user-select: none; -webkit-user-select: none; // Safari   maybe:  -ms-user-select: none; /* IE 10+ and Edge */

  document.getElementById("unknown_column_names_and_types_tbody").innerHTML = "";

  // show is: names_div_and_types_div or names_types_div or none
  
  show_select_column_names_and_types_div('names_div_and_types_div');

  show_input_data_parameters_table(true);
  
  //alert("2 num_files_read="+num_files_read);
}




function show_select_column_names_and_types_div(show) {
  // show is: names_div_types_div or names_types_div or none
  if ( ['names_div_and_types_div','names_types_div','none'].indexOf(show) === -1 ) {alert("show_select_column_names_and_types_div(): Unexpected show="+show); return;}
  document.getElementById("select_column_names_div").style.display = show==='names_div_and_types_div' ? '' : 'none';
  document.getElementById("select_column_types_div").style.display = show==='names_div_and_types_div' ? '' : 'none';
  document.getElementById("select_column_names_and_types_div").style.display = show==='names_types_div' ? '' : 'none';
  document.getElementById("show_heatmap_with_column_names_and_types_button").style.display = show!=='none' ? '' : 'none';
}


function show_input_data_parameters_table(show) {
  document.getElementById("input_data_parameters_table").style.display = show ? '' : 'none';  
}



function validate_input_data_parameters_for_multiple_files() {

  var err1 = ""
  if (taxid === "") err1 = "Select the Organism/Species using the drop-down menu above.";

  document.getElementById("organism_species_message").innerHTML = err1; 
  
  // File names-> Column name & sub-name:
  var err2 = "", names =[];

  // head1 and head2 are global arrays, and are already initialised to ["Gene",], ["Gene",]. (or "Protein")

  j_gene_id = j_fc = j_pvalue = j_pct1 = j_pct2 = -1; // Global. Set to -1, as 0 is first column.
  

  var rows = document.getElementById("unknown_filenames_tbody").rows; // not .rows()

  if (rows.length !== filenames_array.length){ alert("ERROR: rows.length !== filenames_array.length");} // headings isn't used below, just using the rwo ordering now.


  // for (var i=0; i<filenames_array.length; i++) {
    // //   var unknown_column_types_array[i].split('_')

  var tr_id_prefix_len = "unknown_filenames_tr_".length; // AS: <tr id="unknown_filenames_tr_'+(i+1)+'" ....
  // Using the row ordering now, as user can reorder the rows by dragging them:
  for (var r = 0; r < rows.length; r++) {

    // There shouldn't be any duplicates...
    var row = rows[r],
        i = Number(row.id.substring(tr_id_prefix_len)) - 1, // Need -1 as starts ids are (i+1)
        filename = filenames_array[i],
        main_name = document.getElementById('heading_main_name_' +(i+1) ).value.trim(),
        sub_name  = document.getElementById('heading_sub_name_'  +(i+1) ).value.trim();

    if (main_name === "") {err2 += "Main name is EMPTY for file: " +filename+ "<br>"; continue;}
    
    var name = main_name + ':' + sub_name;

    var j = names.indexOf(name);
    if (j >= 0) {err2 += name + " for file: " +filename+  " is also assigned to file: " +filenames_array[j]+"<br>"; continue;}

    names.push(name);
    head1.push(main_name);
    head2.push(sub_name);
  }
  document.getElementById("column_names_message").innerHTML = err2;
 
//alert("4 num_files_read="+num_files_read);

  var err3 = "", types = [];

  for (i=0; i<unknown_column_types_array.length; i++) {
    var type_elem = document.getElementById('heading_type_'+(i+1)),
        type      = type_elem.value,
        type_text = type_elem.options[type_elem.selectedIndex].text,
        name      = type_elem.getAttribute('data-name'),
        in_files  = type_elem.getAttribute('data-in_files'),
        in_cols   = type_elem.getAttribute('data-in_cols'),    
        col_index = i;

    if (in_cols.indexOf(',') > -1) {err3 += "'" +name+ "' occurs in more than one column index: "+in_cols+"<br>"; continue;}
    col_index = Number(in_cols) - 1;

    // Set the global column number variables:
    if (type !== "none" && types.indexOf(type) >= 0 && in_files === "All") {err3 += "'" +type_text + "' type is used twice. You can only assign it to one column.<br>"; continue;}
    // 'none' can be used for several columns.

    if      (type === 'id')   {if (j_gene_id !== -1 &&  j_gene_id !== col_index) {err3 += "Gene/Protein ID has two different column indexes.<br>"; continue;} else {j_gene_id = col_index;}}
    else if (type === 'fc')   {if (j_fc      !== -1 &&  j_fc      !== col_index) {err3 += "Fold-change has two different column indexes.<br>";     continue;} else {j_fc      = col_index;}}
    else if (type === 'pv')   {if (j_pvalue  !== -1 &&  j_pvalue  !== col_index) {err3 += "P-value has two different column indexes.<br>";         continue;} else {j_pvalue  = col_index;}}
    else if (type === 'pct1') {if (j_pct1    !== -1 &&  j_pct1    !== col_index) {err3 += "pct.1 has two different column indexes.<br>";           continue;} else {j_pct1    = col_index;}}
    else if (type === 'pct2') {if (j_pct2    !== -1 &&  j_pct2    !== col_index) {err3 += "pct.2 has two different column indexes.<br>";           continue;} else {j_pct2    = col_index;}}
    else if (type !== 'none') {err3 += "Unexpected column type='"+type+"'<br>"; continue;}
    
    types.push(type);
  }

  if (j_gene_id === -1) err3 += "You need to set one column to type: 'Gene/Protein ID'<br>";
  if (j_fc === -1)      err3 += "You need to set one column to type: 'Fold-change'<br>";

  document.getElementById("column_types_message").innerHTML = err3; 

  
  if (err1!=="" || err2!=="" && err3!=="") {
     show_validate_input_data_parameters_message("Please correct the data input parameters, as explained above.",'red');
     alert( "Please correct the data input parameters, as explained in red text, for:" +(err1==="" ? "" : "\n  (b) Organism/Species.") + (err2==="" ? "" : "\n  (c) Column names.") + (err3==="" ? "" : "\n  (d) Column types.") );
     
     if (err1 !== "")  document.getElementById("organism_species_anchor").scrollIntoView(); // using this anchor as otherwise the select is hidden behind the table headder
     return false;
     }

  show_validate_input_data_parameters_message("Creating/Updating the heatmap below....", 'green');

  show_reading_and_loading_messages(tab_instructions, 'green');

  return true; 
}




function parse_multiple_files(evt,thefilename) {
  // console.log("parse_multiple_files() event=",evt);
  // var data = evt.target.result;
  parse_multiple_file_data(evt.target.result, thefilename);
}


function parse_multiple_file_data(data, thefilename) {
//  console.log("parse_multiple_files() event=",evt);
//  var data = evt.target.result;

  // Get the columns names from the filename:
  var match = filename_regex.exec(thefilename); // whereas filename_regex.test(..) just returns true/false
  // if (match === null && !confirm("This file '"+filename+"' doesn't end with .csv, .tsv or .txt.\nAre you sure you have selected the correct file?\nFilename: '"+filename+"'\n(Press 'Yes' to continue, or 'No' to select another file.)") ) return false;
  var thefilename_without_extn = (match === null) ? thefilename : match[1];

  var filename_parts = thefilename_without_extn.split('-'); // using a limit of 2 would ignore any third part.

  //var head1_name = filename_parts[0],
  //    head2_name = filename_parts.length >1 ? filename_parts.slice(1).join('-') : ""; // empty for now. BUT can be the part after - as "Items after the limit are excluded."

  filenames_array.push(thefilename);

  // Get the data in the file:  

  // Format eg: DGEA-Results/uninfectedvsvirus1.csv
  //   "","p_val","avg_log2FC","pct.1","pct.2","p_val_adj"
  //   "MT-ATP6",2.49340207491595e-257,0.491379025422126,0.999,0.979,5.87570198953944e-253
  //   "MT-ND1",1.84459695034627e-171,0.478291215931857,0.986,0.931,4.34679271349099e-167


  // if (!valid_file_content(data)) return false;

  /*
  var lines = data.split(/\r\n|\n/); // windows or linux newlines.
  if (lines.length == 0) {show_loading_message("The file doesn't contain any lines of data.",'red'); return false;}
  if (lines.length == 1) {show_loading_message("The file contains only one line of data, perhaps the lines need to be separated with new-line characters?",'red'); return false;}
  */
  
  // var delim, delim_name;

  // var delim = '\t'; // Just use tab or comma for now.
  // alert(data.substr(0,500));

  var delim_info = get_data_deliminator(data.substr(0,500));
  var delim = delim_info[0], delim_name = delim_info[1];
  // alert("delim is: "+delim+" "+delim_name+ " for file: "+thefilename);
 
  //var lines = csvToArray(data, delim);
  var lines = csv2arr(data, delim); // returns A single empty row if no data: [["",],]
  if (lines.length === 0 || (lines.length === 1 && lines[0].length<2)) {show_reading_and_loading_messages("ERROR: parse_multiple_files(): File is empty: "+thefilename, 'red'); return false;} 

  var headings = lines[0]; // headings should be:   ["","p_val","avg_log2FC","pct.1","pct.2","p_val_adj"]
  var headings_lc = new Array(headings.length);
  for (var j=0; j<headings.length; j++) headings_lc[j] = headings[j].toLowerCase();
  
  // alert(headings_lc); // eg: row.names,log2foldchange,pvalue
  
  j_gene_id = -1; // global set to -1




/*
  The following is moved into: show_data_still_to_parse_headings_to_user_for_multiple_files()
  
  if (j_gene_id < 0) j_gene_id = headings_lc.indexOf('genesymbol');
  if (j_gene_id < 0) j_gene_id = headings_lc.indexOf('genename');
  if (j_gene_id < 0) j_gene_id = headings_lc.indexOf('proteinname');
  if (j_gene_id < 0) j_gene_id = headings_lc.indexOf('id');
  if (j_gene_id < 0) j_gene_id = 0; // global set to 0.

  // Test if selected only one diff gene expression file:
  // if (data.indexOf('avg_log2FC') !== -1 || data.indexOf('avg_logFC')  !== -1 || data.indexOf('p_val_adj')  !== -1 || data.indexOf('p_val') !== -1 ) 

  var warn="", err = "";

  Doing this test in 
  // These 'j_fc', etc are gobal now.
  j_fc = headings_lc.indexOf('avg_log2fc'); // avg_log2FC check for alternative names for this column.
  if (j_fc < 0) j_fc = headings_lc.indexOf('avg_logfc'); // avg_logFC
  if (j_fc < 0) j_fc = headings_lc.indexOf('logfc'); // avg_logFC
  if (j_fc < 0) j_fc = headings_lc.indexOf('log2fc'); // avg_logFC
  if (j_fc < 0) j_fc = headings_lc.indexOf('log2foldchange');
  if (j_fc < 0) warn = "Warning: Neither 'avg_log2FC' [average log2-fold-change], nor 'avg_logFC' [average log-fold-change] columns were found in the file headings of '"+thefilename+"'.<br>";
  else if (j_fc === 0) warn += "Warning: parse_multiple_files(): Expected Gene or Protein as the first column heading of file: '"+thefilename+"', but found column heading is: "+headings[j_fc]+"<br>";

  var j_pvalue = headings.indexOf('p_val_adj');
  if (j_pvalue < 0) j_pvalue = headings_lc.indexOf('p_val');
  if (j_pvalue < 0) j_pvalue = headings_lc.indexOf('p_value');
  if (j_pvalue < 0) j_pvalue = headings_lc.indexOf('pvalue');
  if (j_pvalue < 0) warn += "Warning: p-value/FDR/q-value column 'p_val_adj' or 'p_val' or 'p_value' NOT found in the file headings of file: '"+thefilename+"'";
  else if (j_pvalue === 0) warn += "Warning: parse_multiple_files(): Expected Gene or Protein as the first column heading of file: '"+thefilename+"', but found column heading is: "+headings[j_pvalue];

*/
  // Test if this guess is working okay:
  if (num_files_read===0 && lines.length > 1 && lines[1].length >= 1) {
     var gene_id = lines[1][0];  // BUT THIS ASSUMES COLUMN 0 is GENE or PROTEIN.
     guess_identifier_type_and_species(gene_id); 
  }

//alert("j_gene_id="+j_gene_id+"  j_fc="+j_fc+"  j_pvalue="+j_pvalue);



/*
  if (warn !== "" || err !== "") {

     show_reading_and_loading_messages(warn + "<br>" + err, 'red');
     num_files_with_unknown_headings += 1;

     // If read all files, then ask user to identify unknown headings:

     // if (num_files_with_unknown_headings > 0 && (num_files_read + num_files_with_unknown_headings === num_files)) 
 //     return false;
  }
*/



  add_to_file_data_still_to_parse(lines, headings);

// April 2023: Not needed here now:
//  var j_pct1 = headings.indexOf('pct.1');  // pct.1 : The percentage of cells where the feature is detected in the first group
//  var j_pct2 = headings.indexOf('pct.2');  // pct.2 : The percentage of cells where the feature is detected in the second group


// Apr 2023: if (num_files_read === num_files && num_files_with_unknown_headings === 0) .... so has finished reading files.
// So can directly call: parse_multiple_files_after_column_headings_assigned

  num_files_read ++; // Global.
  
  // if (num_files_read !== num_files) {alert("parse_multiple_files(): num_files_read !== num_files"); } // num_files_read (and similar to num_cols + 1) is global is number of files.

  if (num_files_read === num_files) {
     show_data_still_to_parse_headings_to_user_for_multiple_files();
     enable_sjb_tab(2, 2, true); // the 'Select ids/species/columns' tab
     // enable_sjb_tab(3, 3, false); // the 'Display options' tab. - for non-HIVE files, not showing Display options until after user sets column names & types and heatmap.  
     enable_sjb_tab(3, 10, false); // To disable the rest of the tabs, as may be opening another set of files after previously loading files.

     show_read_input_data_message('<br>&nbsp;<br>Files read successfully.<br>&nbsp;<br>Now <b>click the \'<span style="color: white; background-color:red;">(2) Select ids/species/columns</span>\' tab</b> above.', 'green', true);
     set_select_ids_species_columns_tab_color('red');

     //alert("num_files_read="+num_files_read);
  }
}


function parse_multiple_files_after_column_headings_assigned() {

//  file_data_arrays.push(arr);
//  file_heading_arrays.push(headings);

  initialise_global_data([gene_symbol_type_is_gene_or_protein(true)]); // so parm is ['Gene'] or ['Protein']
  
  if (!validate_input_data_parameters_for_multiple_files()) return false; // validate_input_data_parameters_for_multiple_files() gives error message and alert box.

  if (j_gene_id === -1) {alert("Gene/Protein column is NOT assigned."); return false;}
  if (j_fc === -1) {alert("Fold-change column is NOT assigned"); return false;}

//alert("5 num_files_read="+num_files_read);

  if ( (num_files_read + num_files_with_unknown_headings) !== num_files) {alert("parse_multiple_files_after_column_headings_assigned(): num_files_read(="+num_files_read+") + num_files_with_unknown_headings(="+num_files_with_unknown_headings+")  !== num_files="+num_files); return false;} // num_files_read (and similar to num_cols + 1) is global is number of files.

  if (num_files !== file_data_arrays.length) {alert("num_files !== file_data_arrays.length"); return false;}
  if (file_data_arrays.length !== file_heading_arrays.length) {alert("file_data_arrays.length !== file_heading_arrays.length"); return false;}
  

  // Just initialises logfc,logpvs,etc to [['Gene',],] or [['Protein',]]  
  // num_cols is global is number of the current file being read.



/*
// The above initialise_global_data([gene_symbol_type_is_gene_or_protein(true)]); does:
function initialise_global_data(headings) {
  // Code below changes the global variables, so removes the existing data:

  num_cols = 0; // or 1? // num_cols is global variable.
  logfcs=[headings]; logpvs=[headings];
  pct1s=[headings];  pct2s=[headings];
  
  has_pct12_columns = has_pvalues_columns = false;
    
  fc_amounts = ['0.3', '0.5', '1.0', '1.5', '2.0', '2.5', '3.0'];
  times=[]; celltypes=[]; // empty the global arrays

  head1 = [headings[0]]; // The "Gene" or "Genename" column.
  head2 = [""];

  gene_dict = {}; // short for: ... = new Object(); used when reading multiple files.

} 
*/

//alert("parse_multiple_files_after_column_headings_assigned(): head1="+head1);

 // num_files_read = 0; // global var is reset to zero here.
 var num_files_parsed = 0;  // better to use this local variable instead of num_files_read

 var col_num = 0; // for reading multiple files into the array columns.


 for (var ifile=0; ifile < file_data_arrays.length; ifile++ ) {
  
  var arr = file_data_arrays[ifile],
     thefilename = filenames_array[ifile];
  // returns A single empty row if no data: [["",],]

  col_num++;  // incremented here so is ifile+1. col_num is global, and set to zero by initialise_global_data above. Is correctly incremented here before logfcs[0].push(head1[col_num] as head1[col_num] is 'Gene' which is already in 

  logfcs[0].push(head1[col_num] + (head2[col_num] === "" ? "" : ':'+head2[col_num])); // To match the format for single my file data, so we can easily write data in my single-file format.
  // BUT logfcs[0][0] is already set to 'Gene' and head1[0] is also 'Gene' so will get logfcs[0]= ['Gene','Gene', ..], so need to use ifile+1 ie:  logfcs[0].push(head1[ifile+1]


  // The j_gene j_pvalue are set in 'validate_input_data_parameters_for_multiple_files()'
  has_pvalues_columns = j_pvalue >= 0;
  // alert("has_pvalues_columns="+has_pvalues_columns);
  has_pct12_columns = (j_pct1 >= 0 && j_pct2 >= 0); // Needs to be after initialise_global_data(..) which sets this to false.
 
  // Start at row 1 of array, as 0 is the header row:
  for (var i=1; i<arr.length; i++) {
    if (arr[i].length < 2 && arr[i][0]==='') {console.log("arr["+i+"] is EMPTY for file "+thefilename+" at line "+(i+1)+" : '"+arr[i]+"'"); continue;} // at end of some files.
    
    var gene = arr[i][j_gene_id]; // There seems to be a blank line at end so skip this:
    if (gene.trim() === "") {alert("gene is EMPTY for file "+thefilename+" at line "+(i+1)+" : '"+arr[i]+"'"); continue;}

    var fc = Number(arr[i][j_fc]), pvalue;
    if (isNaN(fc)) {show_reading_and_loading_messages("ERROR: invalid 'avg_log2FC' number: col_num="+col_num+" :"+arr[i][j_fc]+" in line "+(i+1)+ " column "+(j_fc+1)+": '" +arr[i]+"'", 'red'); return false;}
    fc = Math.round(100*fc)/100; // round to 2 decimal places.

    if (has_pvalues_columns) {
      pvalue = Number(arr[i][j_pvalue]);
      if (isNaN(pvalue)) {show_reading_and_loading_messages("ERROR: invalid pvalue number: col_num="+col_num+" :"+arr[i][j_pvalue]+" in line "+(i+1)+ " column "+(j_pvalue+1)+": '" +arr[i]+"'", 'red'); return false;}
      // pvalue = (pvalue > 0.001) ? Math.round(10000*pvalue)/10000 : (pvalue > 0.000001) ? Math.round(10000000*pvalue)/10000000 : pvalue; // really want significant places.
      pvalue = Number(pvalue.toPrecision(3)); // toPrecision() converts to string
    }
     
    // or: parseFloat(number.toPrecision(precision))
    // or: Number( my_number.toPrecision(3) )

    // Find the row for this gene in the logfcs array (and logpvs array):
    var i_row;
    if (col_num === 1 || !(gene in gene_dict) ) {
       logfcs.push([gene]);
       logpvs.push([gene]);
       // alert("logpvs.push(["+gene+"]);");
       if (has_pct12_columns) {pct1s.push([gene]); pct2s.push([gene]);} // alert("pct1s.push(["+gene+"])");}

// old: row = logfcs[];
       i_row = logfcs.length-1; // The index of the row.
       gene_dict[gene] = i_row;    // if (col_num>1) also add: new Array(col_num-1).fill(null);
    }
    else i_row = gene_dict[gene];
    
    var fc_row = logfcs[i_row],
        pv_row = logpvs[i_row];
    
    // Append the fc value to the row: 
    if (fc_row.length > col_num) {var msg = "ERROR: Gene '"+gene+"' occurs more than once in file: "+thefilename; show_reading_and_loading_messages(msg,'red'); alert(msg); return false;}    
    while (fc_row.length < col_num) {fc_row.push(null); pv_row.push(null);} // To fill any empty columns.
    if (fc_row.length !== col_num) {alert("fc_row.length !== col_num"); return false;}
    fc_row.push(fc); // logfcs.
    if (has_pvalues_columns) pv_row.push(pvalue);

    if (has_pct12_columns) {
      var pct1_row = pct1s[i_row],
          pct2_row = pct2s[i_row];
      while (pct1_row.length < col_num) {pct1_row.push(null); pct2_row.push(null);} // To fill any empty columns.
      pct1_row.push(arr[i][j_pct1]); // Not converting to a number as we're not doing any filtering on these numbers.
      pct2_row.push(arr[i][j_pct2]);
    }
    
    //   console.log("gene_dict[gene="+gene+"]=",gene_dict[gene]);
    //  else {
    //  var msg="ERROR: parse_multiple_files(): At col_num="+col_num+", the Gene '"+gene+"' is MISSING from previous file(s)/column(s)"; show_loading_message(msg,'red'); alert(msg); return false;
    //  }
 
        
  }
  // Note: This 'in' works for an Object. But beware using the 'in' operator on Array to find data instead of keys:
  //    ("true" in ["true", "false"]) gives false (Because the keys of the above Array are actually 0 and 1)

  num_files_parsed ++;  



 } // end of:  for (var i=0; i < file_data_arrays.length; i++ ) {



 
 if (num_files_parsed === num_files) {  // num_files_parsed is local var in this function. // num_files_read (and similar to num_cols + 1) is global is number of files.
    if (num_files_parsed !== num_files_read) {alert("num_files_parsed="+num_files_parsed+" !== num_files_read="+num_files_read);}

    for (var i=1; i<logfcs.length; i++) { // To append any values missing from end of rows:
       var fc_row = logfcs[i],
           pv_row = logpvs[i];
       while (fc_row.length <= col_num) {fc_row.push(null); pv_row.push(null);} // To fill any empty columns at end of the rows.
    
       if (has_pct12_columns) {
         var pct1_row = pct1s[i],
             pct2_row = pct2s[i];
         while (pct1_row.length <= col_num) {pct1_row.push(null); pct2_row.push(null);}
       }
    }

    if (num_files_parsed !== col_num ) {alert("num_files_parsed !== col_num");}
    num_cols = num_files_parsed + 1;  // +1 as first col is genename

    set_fc_min_max_and_num_fc_in_cols(); // Needs to before show_heatmap()
    set_celltypes_and_times(head1,head2);


    set_heatmap_image_select_columns_checkboxes(); // was headings, but using the global head1,head2 arrays now.

    show_heatmap_scale(); // between fc_min and fc_max.

    set_filter_menu_options(); // the fc_amount between fc_min and fc_max
    sort_data(null);
  
/*
???
  enable_sjb_tab(2, 3, true); // where tab 2 = 'Select ids/species/columns' tab, and 3 = 'Display options' tab - this Display options tab is shown now for HIVE file.
  enable_sjb_tab(4, 10, false); // To disable the rest of the tabs, as may be opening another set of files after previously loading files.
*/
  
console.log("parse_multiple_files_after_column_headings_assigned():","showing heatmap...");

    show_heatmap();
    show_hide_download_single_data_file_link(true); // I show this later if read multiple DGE files.

console.log("parse_multiple_files_after_column_headings_assigned():","finished");
    // draw_heatmap_show_image_size();
  }
  else if (col_num > num_files) {alert("ERROR: parse_multiple_files(): col_num="+col_num+" > num_files="+num_files); return false;}
  else {alert("ERROR: num_files_parsed(="+num_files_parsed+") !== num_files(="+num_files+")"); return false;} // This shouldn't happen.


  return true; // for success.
}


function enable_read_from_url_button(this_url_input) {
   document.getElementById("read_from_url_button").disabled = this_url_input.value.trim() === '';
}




function url_to_read_clicked(this_button) {
  var url_to_read = document.getElementById("url_to_read").value.trim(),
      url,
      msg = "";

  show_reading_and_loading_messages(""); // to clear messages.
  show_validate_input_data_parameters_message("");

  if (url_to_read.indexOf('www.') === 0) url_to_read = 'https://'+url_to_read; // or 'http://' BUT www.dropbox fails if just use http:// need https:// Alternatively could first try http:// and if that fails then try https://

  // alert("url_to_read: "+url_to_read);

  if (url_to_read.indexOf('http://')===-1 && url_to_read.indexOf('https://')===-1 && url_to_read.indexOf('ftp://')===-1 && url_to_read.indexOf('ftps://')===-1) {
     msg = "The URL must start with 'http://' or 'https://' and if your web-browser supports 'ftp://' or 'ftps://'"; 
     show_read_input_data_message(msg,'red');
     alert(msg);
     return;
  }

  // Test if this URL has valid format:
  try {
    url = new URL(url_to_read);
  } catch (err) {
    msg = "Invalid URL format: "+url_to_read+" : "+err;
    show_read_input_data_message(msg,'red');
    alert(msg);
    return;
  }

  url_to_read = convert_share_link_to_download_link(url_to_read); // or pass the 'url' instead of this string.
  show_read_input_data_message("Reading from URL: "+url_to_read+" ....", 'blue');

  var url_to_share = window.location.href;

  // or replace the 'url=' link:
  if (url_to_share.indexOf('?url=')===-1 && url_to_share.indexOf('&url=')===-1) url_to_share += (url_to_share.indexOf('?') === -1 ? '?' : '&') + 'url=' + encodeURIComponent(url_to_read);

  var url_to_share_and_copy_button = '<span id="url_to_share_link_to_copy">'+url_to_share+'</span><br><button onclick="copy_url_to_share_link(this);"><b>Optionally</b> copy this link to your Win/Mac clipboard - if you wish to paste this link into email or document</button><span id="url_to_share_link_to_copy_progress" style="color:green;"></span>';

  document.getElementById("url_to_share_message").innerHTML = "URL with 'url=' parameter url-encoded so you can easily share with your team:<br>"+ url_to_share_and_copy_button;


  show_heatmap_title('',''); 

  initialise_data_still_to_parse(); // If files have unknown headings.

  show_read_input_data_message("Reading file from web url (May take 5+ seconds) ...", 'green', false); // Should show message even when busy

  read_data_from_url(url_to_read); // <-- This is async so need to read the data within that function.
}


// Is global filename_regex now var regex = /^([a-zA-Z0-9\s_\\.\-:]+)(.csv|.tsv|.txt)$/i; // i=case-insensitive. Or:  regex=RegExp('.....','i')
var filename_regex = /([a-zA-Z0-9\s_.\-:\(\)]+)(.csv|.tsv|.txt)$/i; // i=case-insensitive. Or:  regex=RegExp('.....','i')
  // when download file again it will contain: (1)
  // not including "\\" as filename_to_read on my Mac is: C:\fakepath\retina_dge_coarse_clusters_first_200_genes.csv C:\fakepath\retina_dge_coarse_clusters_first_200_genes.csv


function file_to_read_clicked(this_elem) {
  this_elem.value = ''; // To clear the files  selected. Otherwise if I try to reload the same files as last time the oninput (which calls read_files()) isn't fired in Chrome at least.
  // alert("file_to_read_clicked().....");
}



// If file has commas within quoted text, or escaped commas, then use the vanillaes/csv parser: https://github.com/vanillaes/csv/blob/main/index.js
function read_files(this_elem) {

  // alert("read_files().....");
  show_reading_and_loading_messages(""); // to clear messages.
  show_validate_input_data_parameters_message("");

  show_tool_tables(false);
  show_hide_download_single_data_file_link(false); // I show this later if read multiple DGE files.
  
  if (typeof (FileReader) === "undefined") {show_reading_and_loading_messages("Sorry: This web-browser doesn't support HTML5, so cannot read the data file. Please use a more recent browser version, eg: Chrome 6+, Edge 12+, Firefox 3.6+, IE 10+, Opera 11+, Safari 6+, Vivaldi, or Brave, etc.", 'red'); return false;}
  // For older webrowsers that don't support this RileReader (File System Access API), could use:
  //        browser-fs-access:  https://github.com/GoogleChromeLabs/browser-fs-access
  //    OR: native-file-system-adapter:  https://github.com/jimmywarting/native-file-system-adapter/
  // The FileReader.readAsText is supported by all recent browser versions (from Chrome 6, IE 10, Safari 6, etc): https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsText

  var file_to_read = document.getElementById("file_to_read"); // or:  = this_elem; is also used at end of this function to start reading in the file.

  var filename_to_read = file_to_read.value.trim();

  num_files_read = 0;
  num_files_with_unknown_headings = 0;

  num_files = file_to_read.files.length; // num_files is global.

  if (filename_to_read == "" || num_files == 0) {show_read_input_data_message("No file was selected. Please select at least one file.",'red'); return false;}
  // else if (file_to_read.files.length >1) {read_multiple_files(file_to_read); return;}   // should only happen if specify 'multiple' in the input element 

  // {alert("More than one file was selected"); return;}
  // {show_loading_message("More than one file was selected",'red'); return false;} // should only happen if specify 'multiple' in the input element 

  show_heatmap_title('','');

  clear_vein_diagram(); // clear the vein/upset table.

  initialise_data_still_to_parse(); // If files have unknown headings.

  show_read_input_data_message("Reading file(s) (May take 10+ seconds) ...", 'green', false); // Should show message even when busy

  var filenames_for_title = "";
  for (var i=0; i<num_files; i++) { 
     var currentfile = file_to_read.files[i],
         filename = currentfile.name,
         filesize = currentfile.size, // The size of the file in bytes.
         file_lastmodified = currentfile.lastModified; // A number specifying the date and time at which the file was last modified, in milliseconds since the UNIX epoch (January 1, 1970 at midnight).

     console.log(i+": filename_to_read="+filename_to_read+"\nfilename="+filename+"\nfilesize="+filesize+" bytes\nfile_lastmodified="+file_lastmodified);

     if (filesize > 10*1024*1024) {show_reading_and_loading_messages("This file '"+filename+"' too large - as is larger than 10 MBytes.", 'red'); return false;}
    
     var match = filename_regex.exec(filename); // whereas filename_regex.test(..) just returns true/false
    // filename_to_read (fromfile_to_read.value): "If multiple files are selected, the string represents the first selected file. JavaScript can access the other files through the input's files property.
    // If no file is yet selected, the string is "" (empty).
    // The string is prefixed with C:\fakepath\, to prevent malicious software from guessing the user's file structure."

    if (match === null && !confirm("This file '"+filename+"' doesn't end with .csv, .tsv or .txt.\nAre you sure you have selected the correct file?\nFilename: '"+filename+"'\n(Press 'Yes' to continue, or 'No' to select another file.)") ) return false;
    console.log("match=",match[0],match[1]);
    
    if (filenames_for_title !== '') filenames_for_title += ", ";
    filenames_for_title += (match === null) ? filename : match[1];
    
    var reader = new FileReader();

    // Not used from June 2022: var file_to_read_input_button = document.getElementById("file_upload_button");

    // As need to access the 'reader.error' then keeping this within this 'read_files()' function
    reader.onerror = function (evt) {var msg="ERROR: An error occurred while reading file:\n" + reader.error.message; show_reading_and_loading_messages(msg, 'red'); alert(msg); /*file_to_read_input_button.disabled = false;*/ return;}; // needs semi-colon here as starts with:  read.onerror = function (e) {...

    reader.onabort = function (evt) {var msg="ERROR: Aborted reading of the file:\n" + reader.error.message; show_reading_and_loading_messages(msg, 'red'); alert(msg); /*file_to_read_input_button.disabled = false;*/ return;}; // needs semi-colon here as starts with:  read.onabort = function (e) {...

    reader.onloadstart = start_loading_files;
    reader.onprogress  = show_loading_progress;
    reader.onloadend   = end_loading_files; 
  
    // if (num_files===1) reader.onload = parse_single_file; // This should pass the event param to parse_single_file function.
    // BUT will also pass the filename to the parse_single_file, so can call parse_multiple_files ?
    if (num_files===1) {
       reader.onload = (function(thefilename) {
          return function(evt){
             return parse_single_file(evt,thefilename);
          };
       })(filename);    
    } else {
       reader.onload = (function(thefilename) { // from: https://stackoverflow.com/questions/16937223/pass-a-parameter-to-filereader-onload-event
          //var fileName = theFile.name;
          return function(evt){
             console.log(thefilename);
             console.log(evt.target.result.substring(0,200));
             return parse_multiple_files(evt,thefilename);
          };
       })(filename);
    }


/*
// Also can use: https://stackoverflow.com/questions/44331850/how-to-show-filereader-load-progress-or-loading-icon

reader.onloadstart = function(event) {
    ShowLoadingBar();
};
reader.onprogress = function(event) {
    if (event.lengthComputable) {
        if (LoadingBarVisible)
            ShowLoadingBar();
        AddProgress();
    }
};
reader.onloadend = function(event) {
    LoadingBarComplete();
};

// Also reader.onabort = ....

*/
    
    console.log("Reading: "+currentfile);
    
    // var filename = document.getElementById("file_to_read").files[0].name;
    // The 'true' below should append filename to list
//    show_loading_message("<br>Reading heatmap from file '"+currentfile.name+"'. (May take 10+ seconds) ...", 'green', true); // Show show message even when busy

    show_reading_and_loading_messages("<br> &nbsp; &nbsp; &nbsp; &nbsp; "+currentfile.name, 'green', true); // true=append. Should show message even when busy

    // Calling inside setTimeout so that the browser will update. See: https://stackoverflow.com/questions/8493195/how-can-i-parse-a-csv-string-with-javascript-which-contains-comma-in-data
    // The setTimeout() method calls a function after a number of milliseconds.
    setTimeout(reader.readAsText(currentfile), 20); // maybe this changes any \r\n to \n ? A second optional 'encoding' parmeter defaults to UTF-8 
    // "JavaScript automatically reads and strips any BOM [byte order mark, which indicates the file's Unicode encoding, eg: "utf-8-sig"] from files read as text with FileReader.readAsText(). 
    // This is true for current versions of Firefox, Chrome and Edge. UTF-8 characters will be correctly decode, whether or not a BOM is found. 
    // Whereas if the file is read with FileReader.readAsBinaryString() the BOM is retained and UTF-8 characters are not decoded."

    // reader.readAsDataURL(currentfile);

  } // end of:  for (var i=0; i<file_to_read.files.length; i++) { ...


  document.getElementById("open_multiple_files_message").style.display = 'none';

  // Not used from June 2022: file_to_read_input_button.disabled = true;
}
    


function convert_share_link_to_download_link(url) {

  // CORS: server needs to set: Access-Control-Allow-Origin: *
  // DropBox does, but OneDrive doesn't. Not tested with Google drive yet 

  // Try to convert share/copy links to download links: 
  
  // Could add Box.com, although direct file links to Box need a paid account.
  
  if (url.indexOf('dropbox.com') > -1 || url.indexOf('dropboxusercontent.com') > -1) {
    url = url.replace('www.dropbox.com','dl.dropboxusercontent.com'); // Convert to a dropbox download link.
    if      (url.indexOf('?dl=') > -1) url = url.replace('?dl=0','?dl=1');
    else if (url.indexOf('&dl=') > -1) url = url.replace('&dl=0','&dl=1');     
    else if (url.indexOf('&amp;dl=') > -1) url = url.replace('&amp;dl=0','&dl=1');
    else url += (url.indexOf('?') === -1  ? '?' : '&') + 'dl=1';
    url += '&raw=1';
    console.log("dropbox download link: "+url);
  }

  //else if (url.indexOf('dropboxusercontent.com') > -1) {
  //  if      (url.indexOf('?dl=') > -1) url = url.replace('?dl=0','?dl=1');
  //  else if (url.indexOf('&dl=') > -1) url = url.replace('&dl=0','&dl=1');
  //  else if (url.indexOf('&amp;dl=') > -1) url = url.replace('&amp;dl=0','&dl=1');
  //  else url += (url.indexOf('?') === -1  ? '?' : '&') + 'dl=1';
  //  url += '&raw=1';
  // }

  else if (url.indexOf('github.com') > -1) {
    // From:              https://github.com/QUB-Simpson-lab/HIVE_browser/blob/main/HIVE_data_21July2023_first50genes.tsv
    // To: https://raw.githubusercontent.com/QUB-Simpson-lab/HIVE_browser/main/HIVE_data_21July2023_first50genes.tsv
    url = url.replace('github.com','raw.githubusercontent.com').replace('/blob/','/'); // Convert to raw.githubusercontent.com link.
  }

  else if (url.indexOf('sharepoint.com') > -1) {
     if (url.indexOf('download=1') === -1) {url += (url.indexOf('?')===-1 ? '?' : '&') + 'download=1';}  // Convert OneDrive 'copy link' to download link: https://www.sharepointdiary.com/2020/05/sharepoint-online-link-to-document-download-instead-of-open.html
    console.log("onedrive sharepoint download link: "+url);
  }
  
  else if (url.indexOf('drive.google.com') > -1) {
    var match = url.match(/drive.google.com\/(file|spreadsheets|document)\/d\/([a-zA-Z0-9_\-]+)\//); // FileId is base64 encoded 42 characters. So just ignore the ending view?usp=sharing/
    if (match !== null) {
       var fileType = match[1], fileId = match[2];
       if (fileType !== 'file') alert("Warning: Expected a type 'file' for the google doc, but got: "+fileType);
       if (fileId.length !== 42) alert("Warning: google drive fileId should be 42 charcters, but got: "+fileId.length+" characters: "+fileId);
       url = 'https://drive.google.com/uc?export=download&id=' + fileId; // Google Drive 'share' link: https://drive.google.com/file/d/1Q......Zc4yaXF/view?usp=sharing to download link: https://drive.google.com/uc?export=download&id=1Q7.....aXF
    }
    console.log("google-drive download link: "+url);
  }
  
  else {
    console.log("Unrecognised download link, so not trying to convert the link format: "+url);
  }

  return url;
}







// https://learn.microsoft.com/en-us/onedrive/developer/rest-api/concepts/working-with-cors?view=odsp-graph-online

function read_data_from_url(url) {

  if (!isOnLine()) alert("Your webbrowser doesn't seem to have a connection to the internet, but will try downloading this file anyway.");

  var xhr = new XMLHttpRequest();
  xhr.open('GET', url, true); // true for async.
  
  // xhr.responseType = 'blob'; // BUT: "Failed to read 'responseText' property from 'XMLHttpRequest': The value is only accessible if the object's 'responseType' is '' or 'text' (was 'blob').
  // so will just use the default response type and convert to blob is needed.
  
  xhr.timeout = 30000; // time in milliseconds - the default value is 0, which means there is no timeout.
  
  xhr.onload = function(evt) {
     // var data = xhr.response;
     var contentType = xhr.getResponseHeader('Content-Type');
     //alert("onload(): contentType="+contentType);
     //       if (contentType.indexOf("text") !== 1) { blob ?
     //           return request.responseText;
     //       }   
     
     // eg: text/csv; charset=utf-8
     if (contentType.indexOf('text/tab-separated-values') === -1 && contentType.indexOf('text/csv') === -1 && contentType.indexOf('text/plain') === -1) {
       var msg = "<b>ERROR: Fetch from Web URL returned an unexpected contant type: "+ contentType +" (should be 'text/tab-separated-values' (.tsv files) or 'text/csv' (.csv files) or 'text/plain' (or .txt files) : status=" +xhr.status+" : "+xhr.responseText + "</b>";
       show_read_input_data_message(msg,'red');
       alert(msg);
       return;
     }

     // if (data === null) return; // As failed to read the data from the web address.

//console.log("xhr:",xhr);
console.log("xhr.responseText:",xhr.responseText);

     // could parse the url to extract the filename: 
     // https://www.dropbox.com/scl/fi/oo7n9a9.......h/HIVE_data_19July2023.tsv?rlkey=b1zt8.........2u&dl=0
     var thefilename = url; // just use the url for now:
     parse_single_file_data(xhr.responseText, thefilename);
  };


  xhr.onerror  = function(evt) { var msg = "<b>ERROR: Fetch from Web URL was FAILED : status=" +xhr.status+" : "+xhr.responseText + "</b>"; console.log("onerror:",xhr); show_read_input_data_message(msg,'red'); alert(msg); }; // xhr.responseText
  // BUT: "Failed to read 'responseText' property from 'XMLHttpRequest': The value is only accessible if the object's 'responseType' is '' or 'text' (was 'blob').
  xhr.onabort  = function(evt) { var msg = "<b>ERROR: Fetch from Web URL was Aborted : status="+xhr.status+" : "+xhr.responseText + "</b>"; show_read_input_data_message(msg,'red'); alert(msg); }; // + xhr.responseText
  xhr.ontimeout = function(evt) { var msg = "<b>ERROR: Fetch from Web URL Timed-Out : status=" +xhr.status+" : "+xhr.responseText + "</b>" ; show_read_input_data_message(msg,'red'); alert(msg); }; // + xhr.responseText

  // xhr.onprogress = function(evt) { var msg = .....; }

  // xhr.progress = function() { .... }
  // The above 'onerror' doesn't give the reason for the error, so using onreadystatechange event here:
  xhr.onreadystatechange = function() { // Call a function when the state changes.
    console.log("onreadystatechange",this.readyState);
    if (this.readyState === XMLHttpRequest.DONE) {  // DONE is 4
       // In local files, status is 0 upon success in Mozilla Firefox so could test: const status = xhr.status;   if (status === 0 || (status >= 200 && status < 400)) {
       // Informational responses (100 – 199)
       // Successful responses (200 – 299)
       // Redirection messages (300 – 399)
       // Client error responses (400 – 499)
       // Server error responses (500 – 599)
console.log("onreadystatechange: XMLHttpRequest.DONE  status="+this.status);

       if (this.status === 200) {
           console.log("onreadystatechange: status=200 : OK");

          // Request finished successfully. Do processing here.

          // var url = xhr.responseText;

//              console.log(url);
//              alert("POST response="+url);
       }
       else if (this.status === 204) {
          console.log("onreadystatechange 204 : No Content");
       }
       else {
// List of https://en.wikipedia.org/wiki/List_of_HTTP_status_codes

// if (status === 0 || (status >= 200 && status < 400)) { // The request has been completed successfully ... console.log(xhr.responseText);
           alert("ERROR: Request returned status-code="+this.status+" : " + this.statusText+ " : "+this.responseText);

   // 400 = Bad Request: The request cannot be fulfilled due to bad syntax.
// 403 = Forbidden: The request was a valid request, but the server is refusing to respond to it.
// 404 = Not Found: The requested page could not be found but may be available again in the future.
// 408 = Request Timeout: The server timed out waiting for the request.
// etc.
       }
    }
  }; // end of: xhr.onreadystatechange = function() .....

/*
    var reader = new FileReader();
    reader.readAsDataURL(xhr.response);
    reader.onload =  function(e){
        console.log('DataURL:', e.target.result);
    };

onload = function() {    

  };
  */
  
  try {
    xhr.send();
  } catch (err) {
    msg = "ERROR: Request to web-address failed for: "+url_to_read+" : "+err;
    show_read_input_data_message(msg,'red');
    alert(msg);
    return false;
  }

  
    
  /*
  OR use fetch() with a async or promise:
  
  async function read_data_from_url(url) {
  let response = await fetch(url);
  let data = await response.blob();

  let metadata = {
    type: ' txt ....image/jpeg'
  };
  // Optionally convert blob to a file: let file = new File([data], "test.jpg", metadata);
  // ... do something with the file or return it
  */
}

  
  
    
/*
// Normalise between -4 to +5 (as is:  min= -3.839   max= 4.581 ) or: -5 to +5 

function heatMapColorforValue(value){
  var h = (1.0 - value) * 240
  return "hsl(" + h + ", 100%, 50%)";
}

HSL is:
  Hue is a degree on the color wheel from 0 to 360. 0 is red, 120 is green, 240 is blue.
  Saturation is a percentage value; 0% means a shade of gray and 100% is the full color.
  Lightness is also a percentage; 0% is black, 100% is white.

//This algorithm is based on the 5 color heatmap,
//In this algorithm, the colors corresponding with values are
 0    : blue   (hsl(240, 100%, 50%))
 0.25 : cyan   (hsl(180, 100%, 50%))
 0.5  : green  (hsl(120, 100%, 50%))
 0.75 : yellow (hsl(60, 100%, 50%))
 1    : red    (hsl(0, 100%, 50%))

// from: https://stackoverflow.com/questions/12875486/what-is-the-algorithm-to-create-colors-for-a-heatmap
//       http://www.andrewnoske.com/wiki/Code_-_heatmaps_and_color_gradients

['Amacrine_EARLY', 'Amacrine_MID', 'Amacrine_LATE', 
'Astrocyte_EARLY', 'Astrocyte_MID', 'Astrocyte_LATE', 
'"Bipolar_EARLY', '"Bipolar_MID', '"Bipolar_LATE', 
'Cone_EARLY', 'Cone_MID', 'Cone_LATE', 
'Endothelial_EARLY', 'Endothelial_MID', 'Endothelial_LATE', 
'Horizontal_EARLY', 'Horizontal_MID', 'Horizontal_LATE', 
'Microglia_EARLY', 'Microglia_MID', 'Microglia_LATE', 
'Muller Glia_EARLY', 'Muller Glia_MID', 'Muller Glia_LATE', 
'Pericyte_EARLY', 'Pericyte_MID', 'Pericyte_LATE', 
'RGC_EARLY', 'RGC_MID', 'RGC_LATE', 
'Rod_EARLY', 'Rod_MID', 'Rod_LATE', 
'RPE_EARLY', 'RPE_MID', 'RPE_LATE']

1110004F10Rik [
0, 0.475325809560861, 0, 
0, 0, 0, 
0, 0, 0, 
0, 0, 0, 
0, 0, 0, 
0, 0, 0, 
0, 0, 0, 
0, 0, 0, 
0, 0, 0, 
0, 0, 0, 
0, 0, 0, 
0, 0, 0]

*/


function enable_upload_button() {
  document.getElementById("file_upload_button").disabled = document.getElementById("file_to_read").value.trim()==="";
}



function old_copy_string_to_clipboard(str, msg_span, msg_success, msg_failure) {
  // From: https://techoverflow.net/2018/03/30/copying-strings-to-the-clipboard-using-pure-javascript/
  // See newer browser copy methods: https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Interact_with_the_clipboard

  // This is SYNCRONOUS so will return result
  var el = document.createElement('textarea');  // Create new element
  el.style = {position: 'absolute', left: '-9999px'}; // and move outside of view

  //e1.style.position = 'fixed'; // prevent scroll from jumping to the bottom when focus is set on iOS. BUT this stops the script on my iPhone.
  document.body.appendChild(el);
  el.value = str;     // Set value (string to be copied)
  // Maybe add: 
 

  var result = false, device="";
  if (navigator.userAgent.match(/ipad|ipod|iphone/i)) {
    // On iOS, Safari need extra settings: https://stackoverflow.com/questions/34045777/copy-to-clipboard-using-javascript-in-ios
	device = "iOS: ";
//alert(device);
    // create a selectable range:
	var range = document.createRange();
    // convert to editable with readonly to stop iOS keyboard opening??  el.contentEditable = true; el.readOnly = true;
	el.contentEditable = true;  // Maybe:  "contenteditable=true" only belongs to divs. And for <textarea> is not applicable? OR: "If the element holding the text is not inside a <form>, then it must be contenteditable.
    el.readOnly = false;
    range.selectNodeContents(el);
    
	// select the range
    var s = window.getSelection();
    s.removeAllRanges();
    s.addRange(range);
    el.setSelectionRange(0, str.length); // or a big number, 999999, to cover anything that could be inside the element. or:  e1.value.length fails on my iPhone in safari.
    // The following isn't necessary:
    el.contentEditable = false;
    el.readOnly = true;
    }
  else { // on Android, etc
    el.setAttribute('readonly', '');     // Set non-editable to avoid focus. My note: But on iOS needs to be editable  
    el.select();  // Select text inside element
    }

  try {
    result = document.execCommand('copy');     // Copy text to clipboard
     // returns false if the command is not supported or enabled. 
	 // We wrap execCommand() in a try and catch since the 'cut' and 'copy' commands can throw an error in a few scenarios ( https://developers.google.com/web/updates/2015/04/cut-and-copy-commands )
     // In Microsoft Edge (which was fixed in Nov 2017) that: "document.execCommand("copy") always returns false" https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/14080262/ 
	console.log("old_copy_string_to_clipboard():",result);
    }
  catch(err) {
    console.log("FAILED: old_copy_string_to_clipboard():",err);
    result = false;
    }
   // Note: If the user selected anything when you ran the function, this selection will be cleared. If you need to preserve the selection, see this Hackernoon article for a more elaborate solution..
   // Because the execCommand() call is inside a click event handler, you don't need any special permissions here.

  document.body.removeChild(el);    // Remove temporary element

  // Manual copy fallback using prompt:
  //if (!result) {
  //  var isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
  //  var copyHotkey = isMac ? '⌘C' : 'CTRL+C';
  //  result = prompt(`Press ${copyHotkey}`, string); // eslint-disable-line no-alert
  //}

  if (msg_span) {msg_span.innerHTML = result ? device + "<span style='color:"+green+"'>"+msg_success+"</span>" : msg_span.innerHTML = device + "<span style='color:"+red+"'>"+msg_failure+"</span>";}
  return result;
}



/*
This function causes script to fail to run on my Moto G phone (preventing the whole app from running) which has an older version of the Chrome browser
It works okay on my newer Moto Z phone.  
function new_copy_string_to_clipboard(str, msg_span, msg_success, msg_failure) {
  // Is ASYNC and only supported on https: 
  // From: https://developers.google.com/web/updates/2018/03/clipboardapi

   // Alternatively use the newer Clipboard API which is async: https://developers.google.com/web/updates/2018/03/clipboardapi
   // As with many new APIs, navigator.clipboard is only supported for pages served over HTTPS. To help prevent abuse, clipboard access is only allowed when a page is the active tab. Pages in active tabs can write to the clipboard without requesting permission, but reading from the clipboard always requires permission.
   // To make things easier, two new permissions for copy & paste have been added to the Permissions API. The clipboard-write permission is granted automatically to pages when they are the active tab.
  
  // (location.protocol !== 'https:') ||   // navigator.clipboard also works in local "file:" pages.
  if (!navigator.clipboard) {old_copy_string_to_clipboard(str, msg_span, msg_success, msg_failure); return;}

  // This new clipboard API is ASYNC, and using a promise: 
  navigator.clipboard.writeText(str)
    .then(() => {
      console.log('New Clipboard API: Text copied to clipboard');
      msg_span.innerHTML = msg_success;
    })
    .catch(err => {  // This can happen if the user denies clipboard permissions:
      console.error('New Clipboard API: Could NOT copy text, so trying old method now: ', err);
      old_copy_string_to_clipboard(str, msg_span, msg_success, msg_failure); // So try the old method.
      // msg_span.innerHTML = msg_failure;
    });
  // As this is ASYNC then cannot return success or failure from the above writeText() functon call.
  }
*/  
  
/* 
// This also causes error preventing the whole app from running, on my Moto G phone Chrome browser:
// Similarly, we can write this as an async function, then await the return of writeText():
async function new2_copy_string_to_clipboard(str, msg_span, msg_success, msg_failure) {
  // From: https://developers.google.com/web/updates/2018/03/clipboardapi
  // This new clipboard API is ASYNC, so using await:
  if (!navigator.clipboard) {old_copy_string_to_clipboard(str, msg_span, msg_success, msg_failure);}
  try {
    await navigator.clipboard.writeText(str);
    console.log('New Clipboard API: Text copied to clipboard');
    msg_span.innerHTML = msg_success;
  } catch (err) {   // This can happen if the user denies clipboard permissions:
    console.error('New Clipboard API: Could NOT copy text (maybe no permissions, or not using https), so trying old method now: ', err);
    old_copy_string_to_clipboard(str, msg_span, msg_success, msg_failure); // So try the old method.
    // msg_span.innerHTML = msg_failure;
  }
}
*/


function copy_param(param, msg_span_id) {
  var msg_span = document.getElementById(msg_span_id); // msg_span_id is eg: 'myparam_copied_progress'
  return old_copy_string_to_clipboard(param, msg_span, "Copied to clipboard", "Failed to copy to clipboard");
}


function copy_url_to_share_link(this_button) {
  var url = document.getElementById("url_to_share_link_to_copy").innerHTML.trim(),
      msg_span = document.getElementById("url_to_share_link_to_copy_progress"),
      success_msg = "<br>Successfully copied the share url to you clipboard.<br>You can now paste this into an email or Word document, etc, by pressing [Ctrl] V, or right clicking and select 'paste'",
      error_msg = "ERROR: Failed to copy the share url gene to the clipboard - you need to use the mouse to manually select the link text, then either: press [Ctrl] C OR right click and select 'copy' from the popup menu.";

  if (url.indexOf('file://') > -1) success_msg += "<br><b>Note:</b> This link uses the local 'file://' protocol, so needs changed to the web address to share."

  return old_copy_string_to_clipboard(url, msg_span, success_msg, error_msg);
}


function copy_selected_genenames_to_clipboard(this_button) {  

//alert("copy_selected_genenames_to_clipboard");
  // *** Not used at present....*** as just asking people to contact office for details to encourage payment by Skipe.
   
  // returns false if the copy fails.
  //var buff_names = "SONG NAMES, formatted as: (EasyWorshipSongId) Title [Author]\n";
  //var buff_words = "\n\n\nSONG WORDS:\n";  
  //for (var j=0; j<songs_saved.length; j++) {
  //  var i = songs_saved[j], song_name, song_words;    
  //  if (i<0) {
  //    song_name = 'Song ('+ (-i) + ') NOT found in updated EasyWorship songs list.';
  //    song_words = '';
  //  } else {
  //    song_name = '('+songs[i][0]+')  '+songs[i][1]+ ( songs[i][2]=='' ? '' : '  ['+songs[i][2]+']' );
  //    song_words = songs[i][3]+'\n\n';
  //    }
  //  buff_names += '\n'+song_name+'\n';
  //  buff_words += '\n'+song_name+'\n\n'+song_words;
  //  }

  
  var msg_span = (this_button.id === "copy_genelist_button_for_david") ? document.getElementById("copy_selected_genenames_message_for_david") : document.getElementById("copy_selected_genenames_message");
  // copy_genelist_button_for_david button is on the DAVID tab.  
    
  if (selected_gene_list.length == 0) {
    var msg="No genes are currently selected. Please select genes first.";
    show_progress(msg_span, msg, 'red');
    alert(msg);
    return false;
    }

  var sep = document.getElementById("copy_separator").value;  // space( ), comma(, ), new-line(nl)
  if (sep === "nl") sep="\n";
  else if (sep === "tab") sep="\t";
  
  var buff = selected_gene_list.join(sep); 

// if (selected_gene_list.length > 0 && confirm('Clear the existing selected gene list first?\n\n(These '+selected_gene_list.length+' genes are currently selected: '+selected_gene_list.splice(0,30).join(', ')+'...)')) { // Empty selected list first.
  
  return old_copy_string_to_clipboard(buff, msg_span, "Successfully copied the "+selected_gene_list.length+" selected genes to clipboard.<br>You can now paste this into another website textarea, or Word document, etc, by pressing [Ctrl] V, or right clicking and select 'paste'", "ERROR: Failed to copy the select gene to the clipboard - you need to use the mouse to manually select this list of genes, then either: press [Ctrl] C OR right click and select 'copy' from the popup menu.");
  }




var gprofiler_gost_url = "https://biit.cs.ut.ee/gprofiler/gost";

function gprofiler(this_elem) {
  // Using form post below instead as the length of a get query is limited to 2048 characters, so a post query is better for long list of genes - but POST to gprofiler gives a "405 Not Allowed"
  // "If you are using the GET method, you are limited to a maximum of 2,048 characters, minus the number of characters in the actual path. However, the POST method is not limited by the size of the URL for submitting name/value pairs.
  if (selected_gene_list.length==0) {alert("You need to select genes first."); return false;}
  
  // TODO : Nov 2022 : get the 'gprofiler_id' species from select box here.

  var url = gprofiler_gost_url + '?organism='+gprofiler_id+'&query=' + encodeURIComponent(selected_gene_list.join("\n")); // '%0A' will be the URL-encoding of a newline. eg: https://biit.cs.ut.ee/gprofiler/gost?organism=mmusculus&query=VEGFA%0AVEGFB
  
  
  //var url = 'https://biit.cs.ut.ee/gprofiler/gost?organism='+gprofiler_id+'&query=' + encodeURIComponent(selected_gene_list.join("\n")); // '%0A' will be the URL-encoding of a newline. eg: https://biit.cs.ut.ee/gprofiler/gost?organism=mmusculus&query=VEGFA%0AVEGFB
  if (url.length > 2028) {url = url.substring(0,2048);}
  this_elem.href = url;



  // OR: - see function below: set_gprofiler_genelist()
  // Could set the form fields: <input type="hidden" id="gprofiler_organism" name="organism" value="">
  //                       and: <input type="hidden" id="gprofiler_query_genelist" name="query" value="">
  // Then submit as an http post request:

  // document.getElementById("gprofiler_organism").value = gprofiler_id;
  // document.getElementById("gprofiler_query_genelist".value = selected_gene_list.join("\n");

  return true;
}

/*
Although this url length limit may not apply in newer browsers, eg: https://stackoverflow.com/questions/417142/what-is-the-maximum-length-of-a-url-in-different-browsers
Browser     Address bar   document.location
                          or anchor tag
------------------------------------------
Chrome          32779           >64k
Android          8192           >64k
Firefox          >64k           >64k
Safari           >64k           >64k
IE11             2047           5120
Edge 16          2047          10240
*/




function set_organism_and_genelist(this_button, gprofiler_or_david) {
  // The organism is set by the organism select change event, as the text name needs to be visible before clicking the gprofiler button.
  if (selected_gene_list.length===0) {alert("You need to select genes first."); return false;}
  if (taxid === "") {alert("You need to select Organism/Species first."); return false;}

  if (gprofiler_or_david === 'gprofiler') {

    document.getElementById("gprofiler_query_genelist").value = selected_gene_list.join("\n");  // DON'T USE AS OTHERWISE %0A APPEARS IN THE GPROFILER FORM:  encodeURIComponent(SELCETC_GENE_LIS...)
    document.getElementById("gprofiler_organism").value = gprofiler_id;

    // As can no longer use POST for gprofiler, then check the url length:
    
    var progress_elem = document.getElementById("gprofiler_progress"),
        this_form     = document.getElementById("gprofiler_form"), // as the this_form above is actually the submit button on the form.
        url = gprofiler_gost_url + '?organism='+gprofiler_id+'&query=' + encodeURIComponent(selected_gene_list.join("\n")); // '%0A' will be the URL-encoding of a newline. eg: https://biit.cs.ut.ee/gprofiler/gost?organism=mmusculus&query=VEGFA%0AVEGFB

    //var url = 'https://biit.cs.ut.ee/gprofiler/gost?organism='+gprofiler_id+'&query=' + encodeURIComponent(selected_gene_list.join("\n")); // '%0A' will be the URL-encoding of a newline. eg: https://biit.cs.ut.ee/gprofiler/gost?organism=mmusculus&query=VEGFA%0AVEGFB
    if (url.length > 2028) {
       this_form.target='_self';
       this_form.action = '#gprofiler_table'; // empty reloads the page.
       progress_elem.innerHTML = 'The number of genes selected exceeds the 2028 character limit of a get url.<br>You can use the "Copy selected genes to clipboard" button above (selecting "new-line" to separate the genes)<br>then go to: <a href="'+gprofiler_gost_url+'" target="_blank">'+gprofiler_gost_url+'</a><br>and paste the gene list (using [Ctrl]-V or mouse right-click) into G:Profiler';
       progress_elem.style.color = 'red';
       return false;
       }

    progress_elem.innerHTML = "Redirecting to G:Profiler in a new tab ...";
    progress_elem.style.color = 'green';

    document.getElementById("gprofiler_organism").value = gprofiler_id;
    document.getElementById("gprofiler_query_genelist").value = selected_gene_list.join("\n"); // should be white-space separated. This form field will be encoded by the browser. 

    this_form.target = '_blank';
    this_form.action = gprofiler_gost_url;
    return true;

  // *** BUT: 405 Not Allowed, even with encodeURIComponent(...)

  // So I've set the form method to GET (instead of POST).
  // This form currently opens in a new browser tab. 
  // Alternatively, to open in a new browser window could use:
  //  <form method="post" 
  //      target="print_popup" 
  //      action="/myFormProcessorInNewWindow.aspx"
  //      onsubmit="window.open('about:blank','print_popup','width=1000,height=800');">
  // or:
  // <form action="..." ... onsubmit="window.open('google.html', '_blank', 'scrollbars=no,menubar=no,height=600,width=800,resizable=yes,toolbar=no,status=no');return true;"> 

  }
  else if (gprofiler_or_david === 'david') {



//https://david.ncifcrf.gov/helps/list_manager.html#list

//If the gene identifiers are official gene symbols, you will need to enter the species name or Taxon ID (step 2a, this option is not available for other identifiers). At step 3, you will choose the usage of the uploaded gene list ("Gene List" or "Background") followed by submission in step 4.

//https://david.ncifcrf.gov/api.jsp?type=OFFICIAL_GENE_SYMBOL&ids=MALAT1,VEGFA,FRAT1&tool=summary

//https://reactome.org/PathwayBrowser/#TOOL=AT

//https://tools.dice-database.org/

//https://guides.ucsf.edu/bistats/pathenrich



    // DAVID APIs (alpha) allow other bioinformatics web sites to directly link to DAVID tools and functions ONLY for light-duty jobs (i.e. a gene list with no more than 400 genes).

    // https://david.ncifcrf.gov/api.jsp?type=ENTREZ_GENE_ID&ids=2919,6347,6348,6364&tool=summary
    // https://david.ncifcrf.gov/api.jsp?type=OFFICIAL_GENE_SYMBOL&ids=Prkca%2CH3f3b%2CH2bu2&tool=summary

    // https://david.ncifcrf.gov/api.jsp?type=OFFICIAL_GENE_SYMBOL&ids=VEGFA&tool=summary  (EGR1) MALAT1 ERBB4

    // https://david.ncifcrf.gov/api.jsp?type=OFFICIAL_GENE_SYMBOL&ids=EGR1%2CMALAT1%2CVEGFA%2CEGFR&tool=summary  
    
    // https://david.ncifcrf.gov/api.jsp?type=ENTREZ_GENE_ID&ids=2919,6347,6348,6364&tool=summary

    //https://david.ncifcrf.gov/api.jsp?type=OFFICIAL_GENE_SYMBOL&ids=H3F3B,CSLC35C2,CPDE7B,CLRI&tool=summary

    //alert("In set_organism_and_genelist(): gprofiler_or_david="+gprofiler_or_david);


    var david_url = "https://david.ncifcrf.gov",
        david_api_url = david_url + "/api.jsp",
        gene_symbol_type = document.getElementById('gene_symbol_type').value,
        david_tool = "summary",
        // david_annot = "",
        progress_elem = document.getElementById("david_progress"),
        msg = "";
        
       if (gene_symbol_type === "") {alert("Please select the Gene/Protein symbol type using the drop-down menu on the '<span style=\"color: white; background-color:red;\">(2) Select ids/species/columns</span>' tab."); return false;} // this_link.target="_self"; // this_link.href="#gene_symbol_type"; return false;}
       if (gene_symbol_type == "GENE_SYMBOL") gene_symbol_type = "OFFICIAL_GENE_SYMBOL"; // DAVID no longer accepts just "GENE_SYMBOL"

        // **** Browser will remove any query param eg: ?=..... from the form action: https://stackoverflow.com/questions/1116019/when-submitting-a-get-form-the-query-string-is-removed-from-the-action-url
        // so cannot use this for the : 
        var url = david_api_url + '?type='+gene_symbol_type + '&tool='+david_tool + '&ids=' + encodeURIComponent(selected_gene_list.slice(0,400).join(",").toUpperCase()); // DAVID uses a comma to separate the genes.
        // Not using: + '&annot='+david_annot
               
       if (selected_gene_list.length > 400) {
         msg += "The number of genes selected exceeds 400 gene limit set by the DAVID API. So *not* all the selected genes will be sent to DAVID webserver.";
       }
       if (url.length > 2028) {
         url = url.substring(0, 2048); // then remove to the final '\n' character.
         msg += 'The number of genes selected exceeds the 2028 character limit of a get url.<br>You can use the "Copy selected genes to clipboard" button above (selecting "new-line" to separate the genes)<br>then go to: <a href="'+david_url+'" target="_blank">'+david_url+'</a><br>and paste the gene list (using [Ctrl]-V or mouse right-click) into DAVID';
       }

       progress_elem.innerHTML = msg !== "" ? msg : "Going to the DAVID website now...";
       if (msg !== "") alert(msg);

       document.getElementById("david_tool").value = "summary";
       document.getElementById("david_gene_type").value = gene_symbol_type;

       document.getElementById("david_ids_genelist").value = selected_gene_list.slice(0,400).join(",").toUpperCase(); // Comma-separated. This form field will be encoded by the browser.

       var this_form = document.getElementById("david_form"); // as the this_form above is actually the submit button on the form.

       //this_form.method = 'GET';
       //this_form.target = '_blank';
       //this_form.target = '_self';

       this_form.action = david_api_url; // ie. without the params.

       // alert("Setting form action to: "+this_form.action);

       return true;
        // <form method="get" target="_blank" action="?type=xxxxx&ids=XXXXX,XXXXX,XXXXXX,&tool=xxxx&annot=xxxxx,xxxxxx,xxxxx," onclick="set_organism_and_genelist(this, 'david');">
  }

  else {alert("set_organism_and_genelist() Unexpected gprofiler_or_david="+gprofiler_or_david); return false;}
  
}

/*
TO FINISH:

==

<!-- (A) DRAW DUMMY CANVAS -->
<canvas id="demo" width="200" height="200"></canvas>
<script>
let ctx = document.getElementById("demo").getContext("2d");
ctx.beginPath();  
ctx.fillRect(0, 0, 100, 100);
ctx.fillRect(50, 50, 100, 100);



==
function candown (target, type) {
  // (B1) GET CANVAS
  let canvas = document.getElementById(target);
 
   // (B2) CREATE LINK
  let anchor = document.createElement("a");
  anchor.download = "download." + type;
  anchor.href = canvas.toDataURL("image/" + type);
 
  // (B3) "FORCE DOWNLOAD"
  anchor.click();
  anchor.remove();
 
  // (B4) SAFER ALTERNATIVE - LET USER CLICK ON LINK
  // anchor.innerHTML = "Download";
  // document.body.appendChild(anchor);
}

=====

  var link = document.getElementById('link');
  link.setAttribute('download', 'MintyPaper.png');
  link.setAttribute('href', canvas.toDataURL("image/png").replace("image/png", "image/octet-stream"));
  link.click();
  
======

From: https://stackoverflow.com/questions/10673122/how-to-save-canvas-as-an-image-with-canvas-todataurl

<canvas width="100" height="100"></canvas>
<div><a href="#" download="image.png">download image</a></div>

const canvas = document.querySelector('canvas');
const context = canvas.getContext('2d');
const anchor = document.querySelector('a');
const rand = i=>Math.random()*i<<0
const fileName = `image${100+rand(100)}.png`;

drawOntoCanvas();
anchor.addEventListener('click', onClickAnchor);

function onClickAnchor(e) {
  if (window.navigator.msSaveBlob) {
  	window.navigator.msSaveBlob(canvas.msToBlob(), fileName);
    e.preventDefault();
  } else {
    anchor.setAttribute('download', fileName);
    anchor.setAttribute('href', canvas.toDataURL());
  }
}

function drawOntoCanvas(){
  const size = 100;
  context.fillStyle = 'rgba(255,0,0,0.4)';
  let i = 10;
  while (i--) {
    context.fillRect(rand(size),rand(size),rand(size),rand(size));
  }
}
===== 
*/


function clear_heatmap_show_image_size() {
  
  document.getElementById("draw_heatmap_show_image_size_text").innerHTML = "";

  /*
  
  var margin = draw_margin;

  // Global:
  draw_col_width  = Number(document.getElementById("download_heatmap_col_width").value);      // 200
  draw_font_size  = Number(document.getElementById("download_heatmap_font_size").value);      // 16
  draw_text_padding = Number(document.getElementById("download_heatmap_text_padding").value); // 7
  draw_row_height = draw_text_padding + draw_font_size + draw_text_padding -1;

 
  if (typeof logfcs === 'undefined' || logfcs === null) {alert("logfcs null"); return;}

  var rows_to_draw = document.getElementById("download_heatmap_rows_to_draw").value;
    
  // Get array of indexes of the rows in draw
  var num_rows = (rows_to_draw === "byfilter") ? filtered_row_list.length : (rows_to_draw === "bycheckbox") ? selected_gene_list.length : (rows_to_draw === "all") ? logfcs.length-1 : -999;
  num_rows += 2; // Add the 2 header (head1 and head2) rows.

  var num_cols = logfcs[0].length,
      iwidth   = num_cols * draw_col_width  + 2 * margin, // Image Width
      iheight  = num_rows * draw_row_height + 2 * margin; // Image Height

      document.getElementById("draw_heatmap_show_image_size").innerHTML = "Image size: &nbsp; Width "+iwidth+" pixels, &nbsp; Height: "+iheight+ " pixels";
*/
}


function show_heatmap_title(fold_change_type, cluster_type) {
    document.getElementById('fold_change_or_pvalue_title').innerHTML = fold_change_type;
    document.getElementById('cluster_type_in_title').innerHTML = cluster_type;  // title = match[1];
    document.getElementById('heatmap_title_text').style.display = (cluster_type || fold_change_type) ? '' : 'none';
}


function show_filter_heatmap_message(msg, color) {
  // The setTimeout() method calls a function after a number of milliseconds.
  //setTimeout(function() {
  var progress_text = document.getElementById("filter_heatmap_message");
  progress_text.innerHTML = msg; 
  if (color) progress_text.style.color = color;
  // }, 0.1);
}


function show_display_options_message(msg, color) {
  // The setTimeout() method calls a function after a number of milliseconds.
  //setTimeout(function() {
  var progress_text = document.getElementById("display_options_message");
  progress_text.innerHTML = msg; 
  if (color) progress_text.style.color = color;
  // }, 0.1);
}


function show_draw_progress(msg, color) {
  var progress_text = document.getElementById("draw_heatmap_image_progress");
  progress_text.innerHTML = msg; 
  if (color) progress_text.style.color = color;
}


function show_validate_input_data_parameters_message(msg, color) {
  var progress_text = document.getElementById("show_validate_input_data_parameters_progress");
  progress_text.innerHTML = msg; 
  if (color) progress_text.style.color = color;
}


function show_image_download_progress(msg, color) {
  var progress_text = document.getElementById("download_heatmap_image_progress");
  progress_text.innerHTML = msg; 
  if (color) progress_text.style.color = color;
}


function show_download_single_data_file_progress(msg,color) {
  var progress_elem = document.getElementById("download_single_data_file_progress");
  progress_elem.innerHTML = msg;
  if (color) progress_elem.style.color = color;
}


function show_progress(progress_elem_or_id, msg, color) {
  // generic show progress/result message. 
  // progress_elem_or_id can be the id (as a string) or the element ref.
  var progress_elem = (typeof progress_elem_or_id === 'string') ? document.getElementById(progress_elem_or_id) : progress_elem_or_id;
  progress_elem.innerHTML = msg;  
  if (color) progress_elem.style.color = color;
  if (progress_elem.style.display === 'none') progress_elem.style.display = '';
}




function draw_heatmap_button_clicked() {
  show_draw_progress("Drawing heatmap image...", 'blue');
  
  setTimeout(draw_heatmap(), 40); // To let the browser display the above message.
}


function clear_and_shrink_canvas() {
  var canvas = document.getElementById("my_heatmap_canvas"),
      c = canvas.getContext('2d');
  c.clearRect(0, 0, canvas.width, canvas.height);
  canvas.height = canvas.width = 0;
  }



var max_canvas_height = 32767; 
// In my test on MacAir: On Chrome: 65535 works, but 66000 fails; On Firefox 32767 works, but 33000 causes an 'Uncaught NS_ERROR_FAILURE'.
// This max canvas size is from: https://github.com/jhildenbiddle/canvas-size#test-results and: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/canvas#maximum_canvas_size
// but is lower on Mobile phones/tablets.
function cal_max_heatmap_rows_for_canvas(margin_size, row_height) {
  var num_rows = Math.floor((max_canvas_height - 2*margin_size)/row_height);
  return num_rows;
}



function draw_heatmap() {
  // This function is partly based on Sanjay Mahto's code:  https://wacky-sam.medium.com/making-table-in-canvas-e453a5e7fb7d

  // (An alternative to this code, is this canvas-table js library: https://github.com/el/canvas-table )
  // Maybe: https://gist.github.com/asimihsan/9275527
  
  if (typeof logfcs === 'undefined' || logfcs === null || logfcs.length < 2) {var msg = "You need to load data before drawing the heatmap image."; show_draw_progress(msg, 'red'); alert(msg); return false;}
  //alert("draw_and_download_heatmap() 3 ....");  



  // Or use this tiny TEST data:
  if (typeof logfcs === 'undefined' || logfcs === null || logfcs.length < 2) {
    logfcs = [['Gene','Early','Mid','Late'],['ABC', 5.4,-3,0], ['DEFG',1,-4.2,null], ['VEGF', 3.2,-1.8,3]];
    var fc_min_lower = -5, fc_max_higher = 6;
    fc_hue_factor_red  =  60/fc_max_higher;
    fc_hue_factor_blue = -60/fc_min_lower;
    // draw_heatmap_show_image_size();
  }

  // for logfcs[0] = ['ABC', 12,56,67], this Object.keys(logfcs[0]) gives: ['0', '1', '2', '3']
  // let bh = (logfcs.length + 1) * 40; // Calculating Border Height Me: The +1 was because original used Object.keys(...) for heading row above.


  // Get array of indexes of the rows in logfcs to draw the headmap image:
  var draw, rows_to_draw = document.getElementById("download_heatmap_rows_to_draw").value;

  if (rows_to_draw === "byfilter") { // Selected by the 'Filter genes'
     draw = filtered_row_list; 
     if (draw.length === 0) {var msg = "There are no rows to draw. You need to set the filters above in the 'Filter rows (eg: genes)' box to have some rows to draw."; show_draw_progress(msg, 'red'); alert(msg); return;}
  }
  else if (rows_to_draw === "bycheckbox") { // Selected by the check-boxed rows in the table
     draw = get_selected_gene_row_numbers();
     if (draw.length === 0) {var msg = "You need to select rows to plot using the checkboxes at left of the table below."; show_draw_progress(msg, 'red'); alert(msg); return;}
  }
  else if (rows_to_draw === "all") { // All rows in logfcs
    var n = logfcs.length;
    draw = new Array(n - 1); // create empty array, the -1 is to ignore the header row. 
    for (var i = 1; i < n; i++) draw[i-1] = i;
    if (draw.length === 0) {var msg = "There are no rows to draw. You need to read the input data files first."; show_draw_progress(msg, 'red'); alert(msg); return;}
  }

  else {var msg = "Unexpected value selected for rows_to_draw="+rows_to_draw; show_draw_progress(msg, 'red'); alert(msg); return;}
    
  //  var num_rows = (rows_to_draw === "byfilter") ? filtered_row_list.length : (rows_to_draw === "bycheckbox") ? selected_gene_list.length : (rows_to_draw === "all") ? logfcs.length-1 : -999;

  //Logic to find border width and border height:
  //let bw = (Object.keys(data[0]).length) * 200; //Calculating Border Width

  var margin     = Number(document.getElementById("download_heatmap_margin_size").value), // Margin in pixels around the table. default is 7.
      col_width  = Number(document.getElementById("download_heatmap_col_width").value),      // 200
      font_size  = Number(document.getElementById("download_heatmap_font_size").value),      // 16
      text_padding = Number(document.getElementById("download_heatmap_text_padding").value), // 7
      background_colour = document.getElementById("heatmap_background_colour").value,
      draw_fc_numbers = document.getElementById("draw_fc_numbers").checked,
      row_height = text_padding + font_size + text_padding -1,
      num_cols = logfcs[0].length, // or head1.length
      num_rows = draw.length + 2,  // Add the 2 header (head1 and head2) rows. 'draw' has no header rows. 'logfcs' includes one header row, but we want head1 and head2 rows so add 1 for num_rows in table.
      bw = num_cols * col_width,   // Border Width
      bh = num_rows * row_height,  // Border Height
      canvas_width  = bw + 2 * margin, // Image Width
      canvas_height_needed = bh + 2 * margin, // Image Height
      canvas_height = canvas_height_needed,
      canvas   = document.getElementById("my_heatmap_canvas"),
      c        = canvas.getContext('2d'),
      msg      = "";
  
  // A rectangle, with a black stroke for borders.
  // vertical and horizontal lines for creating rows and columns in that rectangle.


  if (canvas_height_needed > max_canvas_height) {
//alert("canvas_height="+canvas_height+" > max_canvas_height="+max_canvas_height+" so reducing num_rows from "+num_rows);
    var original_num_rows = num_rows;
    num_rows = Math.floor((max_canvas_height - 2*margin)/row_height);
//alert("so reduced num_rows="+num_rows);
    bh = num_rows * row_height;
    canvas_height = bh + 2 * margin; // Image Height
    msg = "Only drawing "+num_rows+" of the "+original_num_rows+" as otherwise the canvas height needed of "+canvas_height_needed+" pixels exceeds the maximum canvas height "+max_canvas_height+" pixels allowed by the web-browser.";
  }

  canvas.height = canvas_height; // Image Height
  canvas.width  = canvas_width;  // Image Width

  msg = "Image size: &nbsp; Width "+canvas.width+" pixels, &nbsp; Height: "+canvas.height+ " pixels.<br>" + msg;

  document.getElementById("draw_heatmap_show_image_size_text").innerHTML = msg;

// alert("w="+canvas.width+ " h="+canvas.height);
  // In the above logic, based on the CSV data that has been passed, I have parsed that data into the JSON format first. after that, calculate the number of keys in a single object and multiplied it by 200 (can be any value based upon your choice) to find the border width. similarly, calculated the length of the object of arrays and added 1 more row as header, and multiplied it with 40 (can be any value based upon your choice) to find the border height. and assigned a variable P = 10 (as a margin).

//alert("draw_and_download_heatmap() 4 ....");

  // Clear the canvas before drawing or redrawing the Table:
  c.fillStyle = background_colour; // "white";
  // c.clearRect(0, 0, canvas.width, canvas.height);

  // The clearRect() method sets the pixels in a rectangular area to transparent black (rgba(0,0,0,0)).

  c.beginPath();

  c.fillRect(0, 0, canvas.width, canvas.height);
   
  // Setting properties for the border lines in the table drawn:
  c.strokeStyle = "black";
  
  // Drawing row borders for the table:
//  for (var y = 0;  y <= bh;  y += row_height) {
//    c.moveTo(m,  m + 0.5 + y);
//    c.lineTo(m + bw,  m + 0.5 + y);
//if (y<100) console.log("row: ",m,  m + 0.5 + y, " To: ", m + bw,  m + 0.5 + y)
//  }

  for (var i = 0, y = margin + 0.5;  i <= num_rows;  i++, y += row_height) {
    c.moveTo(margin,      y);
    c.lineTo(margin + bw, y);
    // if (y<100) console.log(i,"row: ",margin, y, " To: ", margin + bw, y)
  }


  // Drawing column borders for the table:
  //for (var x = 0;  x <= bw;  x += col_width) {
  //  c.moveTo(m + 0.5 + x,  m);
  //  c.lineTo(m + 0.5 + x,  m + bh);
  //}
  for (var i = 0, x = margin + 0.5;  i <= num_cols;  i++, x += col_width) { // y <= bh 
    c.moveTo(x,  margin);
    c.lineTo(x,  margin + bh);
  }

  // Draw the lines: 
  c.stroke();
  c.closePath();
  
  
  // let keys = Object.keys(data[0]); // finding keys in each JSON object

  // To print the values in the Table Excluding Header:

  // let i count is used to track the number of rows to be filled.
  // let j keyCount is used to track the number of columns to be filled.

  // Could rotate the headings to be vertical to save space: https://stackoverflow.com/questions/3167928/drawing-rotated-text-on-a-html5-canvas 
  // To Print the Header:

  // Options: ctx.textAlign = 'center'; ctx.textBaseline = "bottom"; Etc.
  
  c.beginPath();
    
  c.font = "bold "+font_size+"px Verdana"; // bold text
  c.fillStyle = "black";
  y = margin + row_height;

  var max_text_width = col_width - text_padding;
  for (var j = 0, x = margin + 0.5;  j < num_cols;  j++, x += col_width) { // x < bw
     c.fillText(head1[j],  x + text_padding,  y - text_padding, max_text_width); // y-axis zero is at top so subtract text_padding. 
     c.fillText(head2[j],  x + text_padding,  y - text_padding + row_height, max_text_width);
     // c.fillText(logfcs[0][j],  x + text_padding,  y - text_padding, col_width);  
   }

//console.log("draw[0]=",draw[0]);
//alert("draw[0]="+draw[0]);

  c.font = "normal "+font_size+"px Verdana";
  // y = m + row_height; // y is already set above for headings.
  for (var i = 1, y = margin + 3*row_height;  i <= draw.length;  i++, y += row_height) { // y <= bh // using logfcs.length instead of num_rows here (as num_rows includes the extra head2 row.)
    x = margin;    
    c.fillStyle = "black";
    var idraw = draw[i-1]; // As the draw array starts at draw[0]
    c.fillText(logfcs[idraw][0],  0.5 + x + text_padding,  y - text_padding, max_text_width); // Gene name.   // text_padding was 5
    for (var j = 1;  j < num_cols;  j++) { // x < bw
      x += col_width; // x is set to 'margin' above okay.
      
      var fc = logfcs[idraw][j];

      if (fc === null) continue;
      c.fillStyle = hsl_color(fc); // Heat map color, HSL can be used directly in canvas: https://riptutorial.com/html5-canvas/example/13472/fillstyle--a-path-styling-attribute-
      c.fillRect(x + 1,  y,  col_width - 1,  1 - row_height); // +1 is to start after border.
      
      if (draw_fc_numbers) {
        c.fillStyle = "black";
        c.fillText(fc,  0.5 + x + text_padding,  y - text_padding, max_text_width);  // text_padding was 5. Here col_width is the maxWidth of the text
      }
    }
  } // NOTE: fillRect draws directly to the canvas without modifying the current path, so any subsequent fill() or stroke() calls will have no effect on it.
    // width : The rectangle's width. Positive values are to the right, and negative to the left.
    // height : The rectangle's height. Positive values are down, and negative are up.

  c.closePath();

  c.save(); // Save the context into the Stack.

  show_draw_progress("Finished drawing the heatmap image below.", 'green');
  
  set_image_download_types();
  
  document.getElementById("download_image_type_label_and_select").style.display = '';
  document.getElementById("download_heatmap_image_link").style.display = ''; // Show the download link.

  show_hide_table_row('download_heatmap_image', true);

  document.getElementById("preview_heatmap_button").scrollIntoView(true);
}



function download_heatmap(evt,this_elem) {

  show_image_download_progress("Downloading image...", 'blue');

  // https://developer.mozilla.org/en-US/docs/Web/HTML/Element/a#using_the_download_attribute_to_save_a_canvas_as_a_png

 // if (window.navigator.msSaveBlob) {
 // 	window.navigator.msSaveBlob(canvas.msToBlob(), fileName);
 //   e.preventDefault();
 // } else {

  // convert canvas content to data-uri for link. When download
  //   attribute is set the content pointed to by link will be
  //   pushed as "download" in HTML5 capable browsers
  // evt.target.href = c.toDataURL('image/png;base64'); // default is image/png

  var image_type = document.getElementById("download_image_type").value;  // 'png'; // or jpeg  png=Higher quality, jpg=Smaller file size.
  console.log("download_heatmap() image_type=",image_type);
  if (image_type === "") {alert("download_heatmap(): ERROR: No image_type selected"); return;}

  var filename = "hive_heatmap." + (image_type==='jpeg' ? 'jpg' : image_type);
  this_elem.download = filename;

  var canvas = document.getElementById("my_heatmap_canvas");
  // alert('canvas.toDataURL(): image/'+image_type); // removed:    +';base64'
  this_elem.href = canvas.toDataURL('image/'+image_type); // default is image/png, the jpg is image/jpeg

  // Safari doesn't support: "image/webp"

  show_image_download_progress("Downloading this Heatmap image.<br>(The '"+filename+"' image file will be in your computer browser's Downloads folder. The filename may have include a number if downloaded a second time, eg: '"+filename+" (2)' )", 'green');
  // return true or false??
}



function set_image_download_types() {
  // All should support: image/png.
  // If your dataUri now contains the same string JPEG is supported. Otherwise the string will be image/png.

  var canvas = document.getElementById("my_heatmap_canvas"),
      html = '';

  if (canvas.toDataURL('image/png').match('image/png'))   html += '<option value="png" selected>PNG = Higher quality (Usually the best option)</option>';
  if (canvas.toDataURL('image/jpeg').match('image/jpeg')) html += '<option value="jpeg">JPEG/JPG = Larger file size for this heatmap (although is smaller for photos, etc)</option>';
  if (canvas.toDataURL('image/webp').match('image/webp')) html += '<option value="webp">WebP = Newer google (more compact) file for webpages</option>';
  if (canvas.toDataURL('image/jxl').match('image/jxl'))   html += '<option value="jxl">JPEG XL = Newer more compressed file for webpages</option>';
  if (canvas.toDataURL('image/avif').match('image/avif')) html += '<option value="avif">AVIF = Newer more compressed file for webpages</option>'; 
  if (canvas.toDataURL('image/gif').match('image/gif'))   html += '<option value="gif">Gif = Older format, Small file size for this heatmap</option>';

  document.getElementById("download_image_type").innerHTML = html;

  // toData(type, quality) quality is optional  
}

// JPEG XL generally has better compression than WebP, JPEG, PNG and GIF and is designed to supersede them. 
// JPEG XL competes with AVIF which has similar compression quality but fewer features overall.


function download_single_data_file(evt,this_elem) {
  // alert("Download this DGE data as single data file isn't fully implemented yet."); return false;
  
  if (logfcs.length < 2) {var msg = "LogFC array is empty. Please open the input data files first."; show_download_single_data_file_progress(msg, 'red'); alert(msg); return false;}
  if (logfcs[0].length != logfcs[1].length) {var msg = "WARNING: The number of columns in the header="+logfcs[0].length+" is different from the number of data columns="+logfcs[1].length; show_download_single_data_file_progress(msg,'red'); alert(msg);}

  show_download_single_data_file_progress("Starting to create and download this data as a single file ...", 'blue');
  
  var gene_symbol_type    = document.getElementById('gene_symbol_type').value,
      taxid_organism_elem = document.getElementById("organism_species"),
      other_organism_div  = document.getElementById("other_organism_species_div");

  var tax_ensembl_gprofiler_ids = (taxid_organism_elem.value === "OTHER") ? other_organism_div.value.trim() : taxid_organism_elem.value;
  
  // The hive params line:
  var buff = 'HIVE:\t' + gene_symbol_type + '\t' + tax_ensembl_gprofiler_ids + '\n'; // Add the HIVE prefix to the first column header, (WAS 'HIVE:Gene' or 'HIVE:Protein') which indicates the filetype in my function parse_single_file(..)

  buff += logfcs[0].join('\t')+'\n'; // header row.

  var write_pvs = logpvs.length > 1;
  var write_pct12s = pct1s.length > 1 || pct2s.length > 1;

  for (var i = 1; i < logfcs.length; i++) {
    if (logfcs[i][j] !== null) buff += logfcs[i][0] + '\t'; // The gene name column.

    for (var j = 1; j < logfcs[i].length; j++) {
      if (logfcs[i][j] !== null) {
        buff += logfcs[i][j];
      
        if (write_pvs) {
          buff += ':';
          if (logpvs[i][j] !== null) buff += logpvs[i][j];   
        } // end of: if (write_pvs)
      
        if (write_pct12s) {
          buff += ':';
          if (pct1s[i][j] !== null) buff += pct1s[i][j];   
          buff += ':';
          if (pct2s[i][j] !== null) buff += pct2s[i][j];
        } // end of: if (write_pct12s)
      }
      
      if (j < logfcs[i].length-1) buff += '\t';
    }
    buff += '\n';
  }

  // Add the date time so OS won't added a (1), (2) etc....
  var filename = "hive_data.tsv";
  this_elem.download = filename;
  this_elem.href = "data:text/plain;charset=utf-8," + encodeURIComponent(buff);

// Or using a Blob:
//  var blob = new Blob([buff], { type: 'text/plain' });    
//  this_elem.setAttribute('download', filename);
//  this_elem.setAttribute('href', window.URL.createObjectURL(blob));

  
  show_download_single_data_file_progress("Downloading this data as a single file.<br>(The '"+filename+"' file will be in your computer's browser Downloads folder.<br>If a file with that name already exists, then a number will be added, eg:<br> 'hive_data<b>-2</b>.tsv' on Safari browser, or 'hive_data.tsv <b>(2)</b>' on Chrome browser)", 'green');
}




function sort_data(this_select) {
  // var logsort = null; - is initialised in 
  var sort_on = this_select===null ? 'none' : this_select.value,
      logfcs_len = logfcs.length; // Note: the -1 is because the first row is the heading, which is always first.

  if (logsort === null) {
    logsort = new Array(logfcs_len-1);
    for (var i=1; i < logfcs_len; i++) logsort[i-1] = new Array(2);
  }

  if (logsort.length !== logfcs.length-1) alert("sort_data(): logsort.length="+logsort.length+" !== logfcs.length-1="+(logfcs.length-1));


  for (var i=1; i < logfcs_len; i++) {
    logsort[i-1][0] = i; // The i-1 is because the first row of logfcs is the heading, which is always first.

    if      (sort_on === 'none') logsort[i-1][1] = i;
    
    else if (sort_on === 'gene_id') logsort[i-1][1] = logfcs[i][0].toUpperCase();

    else if (sort_on === 'fc_max' || sort_on === 'fc_min') {
       var c = logfcs[i], max = null; // or:  min = 0, max = 0; 
       for (var j=1; j < c.length; j++) { // start at j=1 as 0 is the gene name
         if (c[j] === null) continue;
         else if (max === null || Math.abs(c[j]) > max) max = Math.abs(c[j]);
       }
       logsort[i-1][1] = max === null ? -1 : max; // setting rows with no fold-changes to -1 so will be at end.
    }

    else if (sort_on === 'fc_range') {
       var c = logfcs[i], min = null, max = null; // or:  min = 0, max = 0; 
       for (var j=1; j < c.length; j++) { // start at j=1 as 0 is the gene name
         if (c[j] === null) continue;
         else if (min === null || c[j] < min) min = c[j];
         else if (max === null || c[j] > max) max = c[j];
       }
       var range = (max === null ? 0 : max) - (min === null ? 0 : min);
       // var range = max - min;
       logsort[i-1][1] = Math.abs(range);
    }

    else if (sort_on === 'p_value') {
       if (!has_pvalues_columns) {alert("sort_data(): THsi data doesn't have p-values/FDR/q-values, so cannot sort on p-values/FDR/q-values"); return;}

       var c = logpvs[i], min = null; // or:  min = 1.1;
       for (var j=1; j < c.length; j++) { // start at j=1 as 0 is the gene name
         if (c[j] === null) continue;
         else if (min === null || c[j] < min) min = c[j];
       }
       logsort[i-1][1] = min === null ? 1.1 : min; // setting rows with no p-value to 1.1 so will be at end, as p is probability so won't be over 1.
    }
    
    else {alert("Unexpected sort_on="+sort_on); return;}
  }
  
  if (logsort.length !== logfcs.length-1) alert("sort_data(): logsort.length="+logsort.length+" !== logfcs.length-1="+(logfcs.length-1));

  // Sort this array:
  if      (sort_on === 'none') return; // as just keep natural order.
  else if (sort_on === 'gene_id') { // Alphabetic:
//    logsort.sort( function(a, b) { a[1].localeCompare(b[1]); } );
    logsort.sort( function(a, b) { return (a[1] > b[1]) ? 1 : (a[1] < b[1]) ? -1 : 0; } ); // Should return -ive, 0 or +ive so NOT using: a[1] > b[1];
  }

  else if (sort_on === 'fc_min') { // Numeric - putting smallest at start:
    logsort.sort( function(a, b) {
      if (a[1] > b[1]) return 1;
      if (a[1] < b[1]) return -1;
      return 0;
    });
  }
  
  else if (sort_on === 'fc_max' || sort_on === 'fc_range') { // Numeric - putting largest at start:
    logsort.sort( function(a, b) {
      if (a[1] < b[1]) return 1;
      if (a[1] > b[1]) return -1;
      return 0;
    });
    // OR: logsort.sort( function(a, b) { return (a[1] < b[1]) ? 1 : (a[1] > b[1]) ? -1 : 0; };
    // OR: logsort.sort((a, b) => a[1] - b[1]);
  }

  else if (sort_on === 'p_value') { // Numeric - putting smallest at start:
    logsort.sort( function(a, b) {
      if (a[1] > b[1]) return 1;
      if (a[1] < b[1]) return -1;
      return 0;
    });
  }

  else {alert("Unexpected sort_on="+sort_on); return;}  
  // To sort in alphabetics order: 
  // logsort.sort((a,b) => a[1].toUpperCase().localeCompare(b[1].toUpperCase()));
  // logsort.sort((a,b) => a[1].localeCompare(b[1]));
  // where:
  // const arr = [
  //   [500, 'Foo'],
  //   [600, 'bar'],
  //   [700, 'Baz']
  // ];  
}



function clear_vein_diagram() {
  document.getElementById("vein_diagram").innerHTML = "";
  document.getElementById("vein_diagram_message").innerHTML = "";
}




var vein_genes = {}; // for the "Select" buttons is index of gene in the logfcs[index][0] array
function count_vein_diagram() {
  // This is an UpSet like plot rotated 90 degrees clockwise.
  // Using '.' to separate the indexes as otherwise 12 would be same 1.2
  // so will be eg: '.1.3.8.'
  // alternatively could use binary as 1 or 0 at each position.... but integers are 32 bits (signed integer or 64) so limits. 
  vein_genes = {}; // empty the existing lists.

  var vein_fc_threshold_select = document.getElementById("vein_fc_threshold"),
      fc_threshold_text = vein_fc_threshold_select.options[vein_fc_threshold_select.selectedIndex].text, //the vein_fc_threshold_select.text is also used below 
      fc_threshold = vein_fc_threshold_select.value, 
      fc_sign = fc_threshold.charAt(0), // is '+' or '-' or 'A' for > or < or Abs()> or a for Abs()< 
      pvalue = document.getElementById("vein_pvalue").value, //e g: 'Any' or 0.5 to 0.001
      counts = {}, 
      fc_sums = {},
      j;

  if (!has_pvalues_columns) pvalue = 'Any'; // To force it to any pvalue as none available.
  
  fc_threshold = Number(fc_threshold.substring(1));
  if (fc_sign === '-') fc_threshold = -fc_threshold;
  else if (fc_sign !== '+' && fc_sign !== 'A' && fc_sign !== 'a') {alert("count_vein_diagram(): Unexpected fc_sign="+fc_sign); return;}

  if (pvalue !== 'Any') pvalue = Number(pvalue); 

  for (var i = 1; i < logfcs.length; i++) {
    var fc_row = logfcs[i],
        key = '.', // setting empty to . as cannot use '' as index.
        pv_row;

    if (pvalue !== 'Any') pv_row = logpvs[i];

    // First get the key for this row, eg: '.02.04.07.' so is columns 2,4,7 
    for (j = 1; j < fc_row.length; j++) { // starting at j=1 as 0 is gene name.
      if (fc_row[j] !== null
           && (pvalue === 'Any' || pv_row[j] <= pvalue)
           && ( (fc_sign==='+' && fc_row[j] >= fc_threshold) ||
                (fc_sign==='-' && fc_row[j] <= fc_threshold) ||
                (fc_sign==='A' && Math.abs(fc_row[j]) >= fc_threshold) ||
                (fc_sign==='a' && Math.abs(fc_row[j]) <= fc_threshold)
              )
         )
        key += ( (j<10 ? '0':'') + j.toString() + '.' ); // Using j<10 .. as padStart(2,'0') not supported in older browsers;
    }
    
    
    var fc_sum;
    if (key in counts) {
      counts[key] += 1;
      vein_genes[key].push(i);
      fc_sum = fc_sums[key]; // fc_sum is a reference, not a copy.
    }
    else {
      counts[key] = 1;
      vein_genes[key] = [i]; // index of the gene.
      fc_sum = fc_sums[key] = new Array(head1.length);
      for (j=1; j<fc_sum.length; j++) fc_sum[j] = 0; // or .fill(0);
    }
    if (key !== '.') { // a key of '.' means has no cells over the threshold fold-change so nothing to add here:
      for (j=1; j<fc_row.length; j++)
        if (fc_row[j] !== null 
             && (pvalue === 'Any' || pv_row[j] <= pvalue)
             && ( (fc_sign==='+' && fc_row[j] >= fc_threshold) ||
                  (fc_sign==='-' && fc_row[j] <= fc_threshold) ||
                  (fc_sign==='A' && Math.abs(fc_row[j]) >= fc_threshold) ||
                  (fc_sign==='a' && Math.abs(fc_row[j]) <= fc_threshold)
                )
           )

          fc_sum[j] += (fc_sign==='A' || fc_sign==='a') ? Math.abs(fc_row[j]) : fc_row[j]; // Using abs for teh Absolute threshold, here as otherwise could average to zero below?

    }
  } // end of: for i=1; .... 


  var keys = Object.keys(counts);
  console.log("keys:",keys);

  // sort keys by length then by alphabetically. The dot (. and also comma) is before 0 in ascii table so '.01.02.' will correctly come before '.12.'
  keys.sort(function(a, b) { return a.length - b.length || a.localeCompare(b) });
  
  var title = '<p style="font-size: 90%;">This is a kind of UpSet plot (rotated 90 degrees) + HeatMap combined for:<br>' + fc_threshold_text + 
             '<br>The number (and colour) in each table-cell below is the ' + (fc_sign==='A' || fc_sign==='a' ? 'Average(Absolute(fold-change) where "Absolute()" means negative fold-changes are counted as positive' : 'Average(fold-change)') + '</p>';

  var html = '<table>\n<tr><th>Num columns</th><th>' + head1.slice(1).join('</th><th>') + '</th><th>Num genes</th><th>Action</th></tr>\n' +
                      '<tr><th></th><th>'            + head2.slice(1).join('</th><th>') + '</th><th></th><th></th></tr>\n';

  var counts_sum = 0;

  for (var k=0; k < keys.length; k++) { 
    var key = keys[k], 
        num_cols = Math.floor(key.length/3), // as each col will eg: '.02.03.'   OR: (key.length-1)/3
        count = counts[key],
        fc_sum = fc_sums[key];

    console.log(key, " count=",count,"  fc_sum=",fc_sum);
    
    html += '<tr><td>'+num_cols+'</td>'; // could use black square to make simple bar chart: &#9632;
    
    var style;
    for (j = 1; j < head1.length; j++) {
      var j_in_key = '.' + (j<10 ? '0':'') + j.toString()+'.';
      console.log(key,  "  j_in_key=",j_in_key);
      if (key.indexOf(j_in_key) > -1) {
         var fc_mean = fc_sum[j]/count;
         style=' style="background-color: ' + hsl_color( fc_mean )+ ';"'; // eg: is '.03.' in '.01.03.08.10'
         html += '<td'+style+'>' +( Math.round(10*fc_mean)/10.0 )+'</td>';      
      }
      else html += '<td> </td>';
    }
    html += '<td style="text-align:left;">'+count+'</td><td> <button onclick="select_vein_genes(\''+key+'\');">Select</button><button onclick="copy_vein_genes(\''+key+'\');">Copy</button> </td></tr>\n';
    counts_sum += count;
  }
  html += '<tr><td colspan="'+head1.length+'" style="text-align:right;">Total number of genes:</td><td colspan="2" style="text-align:left;">'+counts_sum+'</td></tr>'; 
  html += '</table>\n';

  document.getElementById("vein_diagram").innerHTML = title + html;
  
  if (counts_sum !== logfcs.length-1) {alert('counts_sum='+counts_sum+' !== logfcs.length-1='+(logfcs.length-1)); return;}
  show_progress("vein_diagram_message", "UpSet/Vein table drawn okay.", 'green');
}




function select_vein_genes(key) { 
  if (key in vein_genes) {
    // alert('This selecting of genes/proteins is not enabled here yet.');

    var iList = vein_genes[key]; 
    if (iList.length === 0) alert("ERROR: List vein_genes[key] is empty but shouldn't be empty."); 
    
    var clear_currently_selected = false; 
    if (selected_gene_list.length > 0 && confirm('Clear the existing selected gene list first?\n(as '+selected_gene_list.length+' genes are currently selected: '+selected_gene_list.splice(0,10).join(', ')+'...)')) {
      // Empty selected list - would be more efficient to unselect just the currently selected gene checkboxes before emptying this list, then select only the selected, but selected_gene_list is gene ids not locfcs array indexes. 
      clear_currently_selected = true;
      selected_gene_list = [];
    }
    // maybe also: && selected_gene_list.length < document.getElementById('heatmap_tbody').rows.length 
 
    // Optionally use a timer so can update progress message: timer3 = setTimeout(function() { ...},...)
    
      // for (var i=0; i<selected_gene_list.length; i++) document.getElementById('c'+selected_gene_list[i]).checked = false;
    var num_selected = 0, num_already_selected = 0, num_without_checkboxes = 0;
    for (var i=1; i < logfcs.length; i++) {
       // Not testing for 'if (tr is visible) ...' as cb should exist if tr exists.
       var cb = document.getElementById('c'+i); // 'c' + row in the logfcs array.
       if (cb) { // the current filter might hide some genes so cannot select them.       
          if (iList.indexOf(i) > -1) {
             if (!clear_currently_selected && cb.checked) num_already_selected++;
             else {
                cb.checked = true;
                // if (clear_currently_selected && selected_gene_list.indexOf(logfcs[i][0])===-1) error: ......
                // if clear_currently_selected if false then this gene might already be in this selected_gene_list list, but could test: if (!cb.checked)....
                selected_gene_list.push(logfcs[i][0]);
                num_selected++;
             }             
             // else if (selected_gene_list.indexOf(logfcs[i][0]) === -1) {alert("ERROR: Gene "+logfcs[i][0]+" is checked but is not in the selected_gene_list");}
          }
          else if (clear_currently_selected && cb.checked) cb.checked = false;
       }
       else num_without_checkboxes++;
    }
    var msg = "Selected "+num_selected+" genes.";
    if (num_already_selected > 0) msg += " "+num_already_selected+" were already selected."
    if (num_without_checkboxes > 0) msg += " " +num_without_checkboxes+" are not visible to select due to your current '<i>(4) Filter rows</i>' setting."
    show_progress("vein_diagram_message", msg, 'green');
    show_genes_list_and_enable_stringdb_options();
  }
  else {var msg = 'ERROR: key="'+key+'" is NOT in the vein_genes data'; show_progress("vein_diagram_message", msg, 'red'); alert(msg); return false;}
}


function copy_vein_genes(key) {
  var progress_elem = document.getElementById("vein_diagram_message");
  
  if (key in vein_genes) {
    var iList = vein_genes[key]; 
    if (iList.length === 0) alert("ERROR: List vein_genes[key] is empty but shouldn't be empty."); 

    var gList = [];
    // as iList[i] is the index of the gene in the logfcs[index]
    for (var i=0; i<iList.length; i++) gList.push(logfcs[iList[i]][0]);  

    // var sep = document.getElementById("copy_separator").value;  // space( ), comma(, ), new-line(nl)
    // if (sep === "nl") sep="\n";
    // else if (sep === "tab") sep="\t";

    var buff = gList.join('\n'); // newline as default separater.
      
    return old_copy_string_to_clipboard(buff, progress_elem, "Successfully copied the "+iList.length+" genes to your Windows/MacOS clipboard.<br>You can now paste this into another website textarea, or Word document, etc, by pressing [Ctrl] V, or right clicking and select 'paste'", "ERROR: Failed to copy the select gene to the clipboard - you need to use the mouse to manually select this list of genes below, then either: press [Ctrl] C OR right click and select 'copy' from the popup menu:");
  }
  
  else {var msg = 'ERROR: key="'+key+'" is NOT in the vein_genes data'; show_progress("vein_diagram_message", msg, 'red'); alert(msg); return false;}
}



   
/*
Vein diagrams:
samples: 1

samples: 1 2
 then:  12

samples: 1 2 3
 then:  12 13 23 ( num=3x2x1/2)
  123

samples: 1 2 3 4
 then:  12 13 14 23 24 34 (n=4x3x2x/2 = )
  123 124 134 234 
  1234

samples: 1 2 3 4 5
 then:  12 13 14 15 23 24 25 34 35 45
  123 124 125 134 135 145 234 235 245 345
  1234 1235 1245 1345
  12345
*/



// Drag the column name table rows - based on: https://www.therogerlab.com/sandbox/pages/how-to-reorder-table-rows-in-javascript?s=0ea4985d74a189e8b7b547976e7192ae.4122809346f6a15e41c9a43f6fcb5fd5
// and: https://web.dev/drag-and-drop/
// Needs: <tr draggable="true" ondragstart="dragstart()" ondragover="dragover()" ondragend="dragend()">  <td>......</td> </tr>
var dragrow;

function color_table_row(tr, colour) {
  var cells = tr.cells;
  for (var i=0; i<cells.length; i++) {
    cells[i].style.backgroundColor = colour;
  } 
}

function dragstart(){  
  // fired when the user starts dragging an element or text selection.
  dragrow = event.target;
  dragrow.style.opacity = '0.4'; // td cells should inherit this row opacity
  // dragrow.style.background = 'rgba(0,0,0,0.4)'; // maybe
  dragrow.style.backgroundColor = 'red'; // need to also set the cell color.
  console.log
  color_table_row(dragrow,'PaleGreen');
}

function dragover(){
  // fired when an element or text selection is being dragged over a valid drop target (every few hundred milliseconds).
  var e = event;
  e.preventDefault(); 
  
  console.log("e.target.parentNode:", e.target.parentNode);
  
  if (e.target.parentNode.tagName !== 'TR') return; // As can drag tr into a td element which gives the error below about: The new child element contains the parent.
  
  let children= Array.from(e.target.parentNode.parentNode.children);
  
  // or mytable.rows.item .....
  
  // Uncaught DOMException: Failed to execute 'after' on 'Element': The new child element contains the parent.
  //  at dragover (HIVE_browser_July2023.html:5495:25) [  this line is:  e.target.parentNode.after(dragrow);  ]
  //  at HTMLTableRowElement.ondragover (HIVE_browser_July2023.html:1:1)
  
  if(children.indexOf(e.target.parentNode)>children.indexOf(dragrow))
    e.target.parentNode.after(dragrow);
  else
    e.target.parentNode.before(dragrow);
}

function dragend() {
  // fired when a drag operation is being ended (by releasing a mouse button or hitting the escape key).
  dragrow.style.opacity = ''; // reset to default for class? or '1' ?
  // dragrow = null; // ??
  color_table_row(dragrow,'');
}

function drop() {
  // fired when an element or text selection is dropped on a valid drop target. 
  // To ensure that the drop event always fires as expected, you should always include a preventDefault() call in the part of your code which handles the dragover event.
  // prevent default action (open as link for some elements)
  event.preventDefault();

}

</script>
</head>
<body style="width: 100%; margin:2px; text-align:center; background-color:#EAF2F8; font-family: Arial, Helvetica, sans-serif;" onload="onLoadPage();">

<!-- Could make table scrollable using: https://vembarrajan.medium.com/html-css-tricks-scroll-able-table-body-tbody-d23182ae0fbc -->

<table id="title_table" class="round_corners">
<tr><td style="border-radius: 15px;">
<h2 style="margin: 0">
<img style="vertical-align: middle;" width="132" alt="HIVE Logo" src="data:image/png;base64,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">
<!-- img src="HIVE_Logo_for_Interactive_Browser.png" --> 
<u>H</u>eatmap for <u>I</u>nteractive <u>V</u>iewing of <u>E</u>xpression data</h2>
<span style="font-size: 80%">Version: 21 August 2023</span>
</td></tr>
</table>
<br>


<div class="sjb_tab_main">
  <input id="sjb_tab1" name="sjb_tabs" class="sjb_tab" type="radio" checked="checked"><label class="sjb_tab" id="sjb_tab1_label" for="sjb_tab1"><span style="font-size: 80%; vertical-align: top;">(1)</span> Input data</label>
  <input id="sjb_tab2" name="sjb_tabs" class="sjb_tab" type="radio" disabled><label class="sjb_tab" id="sjb_tab2_label" for="sjb_tab2"><span style="font-size: 80%; vertical-align: top;">(2)</span> Select ids/species/columns</label>
  <input id="sjb_tab3" name="sjb_tabs" class="sjb_tab" type="radio" disabled><label class="sjb_tab" id="sjb_tab3_label" for="sjb_tab3"><span style="font-size: 80%">(3)</span> Display options</label>
  <input id="sjb_tab4" name="sjb_tabs" class="sjb_tab" type="radio" disabled><label class="sjb_tab" id="sjb_tab4_label" for="sjb_tab4"><span style="font-size: 80%">(4)</span> Filter rows:0</label><!-- This '0' is updated by 'show_num_filtered_rows()' -->
  <input id="sjb_tab5" name="sjb_tabs" class="sjb_tab" type="radio" disabled><label class="sjb_tab" id="sjb_tab5_label" for="sjb_tab5"><span style="font-size: 80%">(5)</span> Selected genes:0</label><!-- This '0' is updated by 'show_selected_genes()' -->
  <input id="sjb_tab6" name="sjb_tabs" class="sjb_tab" type="radio" disabled><label class="sjb_tab" id="sjb_tab6_label" for="sjb_tab6"><span style="font-size: 80%">(6)</span> g:Profiler</label>
  <input id="sjb_tab7" name="sjb_tabs" class="sjb_tab" type="radio" disabled><label class="sjb_tab" id="sjb_tab7_label" for="sjb_tab7"><span style="font-size: 80%">(7)</span> STRING</label>
  <input id="sjb_tab8" name="sjb_tabs" class="sjb_tab" type="radio" disabled><label class="sjb_tab" id="sjb_tab8_label" for="sjb_tab8"><span style="font-size: 80%">(8)</span> DAVID</label>  
  <input id="sjb_tab9" name="sjb_tabs" class="sjb_tab" type="radio" disabled><label class="sjb_tab" id="sjb_tab9_label" for="sjb_tab9"><span style="font-size: 80%">(9)</span> Heatmap image</label>  
  <input id="sjb_tab10" name="sjb_tabs" class="sjb_tab" type="radio" disabled><label class="sjb_tab" id="sjb_tab10_label" for="sjb_tab10"><span style="font-size: 80%">(10)</span> UpSet/Vein</label>  
  <input id="sjb_tab11" name="sjb_tabs" class="sjb_tab" type="radio"><label class="sjb_tab" for="sjb_tab11"><span style="font-size: 80%">(11)</span> Help/Feedback</label>

  <div class="sjb_tab_content">

    <div id="sjb_tab_content1" class="sjb_tab">

<!-- border-collapse:collapse;  -->
<table id="data_input_table" class="input_data_tables round_corners">
<tr><th>(1) Input your data:</th></tr>

<tr><td>
<!-- For the file input, size seems to work on firefox, and style width in other browsers: https://stackoverflow.com/questions/13340747/html5-how-to-specify-the-width-of-a-file-input -->
<p style="text-align:left; margin-bottom: 0;"><label for="file_to_read">Select <b>Local file(s)</b>:</label>
 <!-- input type="file" id="file_to_read" placeholder="Select data csv file" accept=".csv, .tsv, .txt" size="40" style="width:380px" onchange="enable_upload_button()" /-->
 <!-- input type="button" id="file_upload_button" value="Read file into the heatmap" onclick="read_files()" disabled /-->
 <!-- June 2022: Reading file without needing to press the load file button: -->
 <input type="file" id="file_to_read" placeholder="Select data csv file(s)" accept=".csv,.tsv,.txt" size="40" multiple style="width:450px;" onclick="file_to_read_clicked(this)" oninput="read_files(this)" > <!-- Using oninput= not onchange in case wish to reload the same file, after editing and saving the file in an editor -->
 <br>&nbsp;<br><span style="color:red;"><b><i><u>OR:</u></i></b></span> <label for="url_to_read">Enter <b>Web address (URL)</b>:</label> 
  <input type="url" id="url_to_read" maxlength="2048" placeholder="Enter a web-address (URL) to the file, or directory containing the files(s), eg: on Google-Drive, DropBox or OneDrive, etc." style="width:500px;" oninput="enable_read_from_url_button(this)"><button id="read_from_url_button" disabled onclick="url_to_read_clicked(this);">Read from Web URL</button></p>



<!-- NOT using class="tooltip" for this datails, just for the summary as the file format as uses div, etc -->
<br>
<p id="read_input_data_message" style="text-align:center; color:red; font-size: 110%;"><b>Either</b>: Use the above '<b><i>Choose files</i></b>' button to select your local files of gene/protein fold-changes,
<br><i><u>OR</u></i> the '<b><i>Read from Web URL</i></b>' to read one accessible 'by anyone with the link' file from a webserver that returns CORS 'Access-Control-Allow-Origin: *' (eg. Dropbox.com).</b></p> <!-- Onedrive, Google-drive, etc -->

<p id="url_to_share_message" style="text-align:center; color:blue; font-size: 80%;"></p>

<div id="open_multiple_files_message" style="text-align:left; font-size:90%">
After clicking the above 'Choose files' button, when there are several fold-change files (as explained in the 'Input File format' help above), to select more than one<br>
file in the file-open dialog, either: 
<ul>
<li>(a) hold down the '<i>CTRL</i>' (or '<i>cmd</i>' on Mac) and click on each file with the mouse,
<li>or: (b) click first file with the mouse, then hold down the '<i>SHIFT</i>' key, then click on the last file in list.
</ul>
</div>

<details style="text-align: left; margin: 0"><summary class="tooltip" style="text-align: left;">Click here to show/hide: <b>Details about opening files and the file formats</b></summary>
<div style="text-align:left; font-size:85%; border:1px solid black; padding: 10px; margin: 0 0 auto 15px; background: #eee;">
The input files can be either: selected from your computer's local or networked disk-drive, or you can enter a web-address (URL) to one file <!--(or directory containing the files(s), eg: on Google-Drive, or OneDrive --> DropBox.com, etc (that is set to be accessible by anyone with the link - ie. not need any login username/password, eg: in DropBox file permission set to 'Anyone').
<br> &nbsp; <br>
The input file(s) should have columns that are separated by either: comma, tab, space, or semicolon. (These files usually have the extension: '<b>.csv</b>' for '<i>comma-separated-values</i>', or '<b>.tsv</b>' for '<i>tab-separated values</i>'.) The columns in these file(s) can be in <b>one of two possible formats, as explained in '<a href="#details_input_file_formats">3. Input file formats</a>' further below</b>.

<br> &nbsp; <br>
<h3>1. Opening the input files:</h3>
<h4>(a) Local files:</h4>
<p>To read file(s) that are located on your <i>local disk or networked drive</i>: Click the above '<i>Choose file(s)</i>' button. Then to select more than one fold-change file, you can either:</p>
<ul>
<li>(i) hold down the '<i>CTRL</i>' (or '<i>cmd</i>' on Mac) and click on each file with the mouse,
<li>or: (ii) click first file with the mouse, then hold down the '<i>SHIFT</i>' key, then click on the last file in list.
</ul>

<h4>OR: (b) Files on a remote webserver address (URL):</h4>
<p>To read one file located on a remote web server address (eg: DropBox.com, etc), that starts with 'http://' or 'https://' or 'ftp://'), enter the URL in the 'URL:' input box, then click 'Read files from web' button, you need to select more than one file by giving the directory containing the files.</p>
<p>The <b>file needs to have it's access permission set to be accessible 'by anyone with the link'</b> on Dropbox.com publically accessible website (ie. does not need any login username/password), <b>and</b> the website <b>server needs to return CORS 'Access-Control-Allow-Origin: *' (or your own client doman in place of the '*')</b> in the server response, otherwise your webbrowser will block the response with a CORS (Cross-Origin Resource Sharing) error, status=0. (DropBox does return this CORS response, but OneDrive and Google-Drive don't, and still to test GitHub, etc. This CORS is a security feature in webbrowsers to prevent one website you visit from accessing files located on another website).</p>
<p>Two test gene-expression datasets – you can just copy and paste either of these two links (below) directly into the "<i>OR: Enter Web address (URL)</i>" text-box, then click the "<i>Read from Web URL</i>" button:
    <br> &nbsp; (1) Dropbox: https://www.dropbox.com/scl/fi/aomweg8fp963pydh8logf/HIVE_data_27July2023.tsv?rlkey=uz5ck5dazaeonoil6nfyqt96n
    <br> &nbsp; (2) GitHub:  https://raw.githubusercontent.com/QUB-Simpson-lab/HIVE_browser/main/HIVE_data_21July2023_first50genes.tsv</p>

<!-- or for a file on OneDrive, set the file's "Sharing setting" set to "Anyone", and Copy the 'Anyone with the link can view'link, and similar for DropBox or Google drive, GitHub, etc. -->

<br> &nbsp; <br>
<h3>2. Select the gene/protein ID type, Organism/species, and columns to use:</h3>
After the input files are selected, the "(2) Select ids/species/columns" tab will be enabled, which lets you select the identifer types and which columns to use from the input files.
<br>The Default column Main-name and Sub-name based on each input filename. An optional '-' character in the input filename can be used to separate CellType and TimePoint (or Condition, etc), eg: "Amacrine-EARLY.csv".


<br id="details_input_file_formats">
&nbsp; <br>

<h3>3. Input file formats:</h3>
<br>The columns in these file(s) can be in <b>one of two possible formats</b>: 

<h4>(a) Two or more files - each containing the fold-changes for one CellType/TimePoint (or CellType:Condition/Location, etc):</h4>
For example, as output from EdgeR or DeSeq, etc:
<p style="font-family: monospace">
""      "p_val" "avg_log2FC"    "pct.1" "pct.2" "p_val_adj"<br>
"Rpgrip1"       2.4930235653005e-06     -0.708481147064019      0.025   0.186   0.0430420518549132<br>
"Ccdc126"       4.74357225134838e-06    -0.331997242485215      0.006   0.137   0.0818977749195298<br>
"Epha6" 3.5653144527448e-05     0.775907953125201       0.46    0.288   0.61555154026639<br>
"4930578G10Rik" 4.86710360318038e-05    0.598860216647768       0.286   0.124   0.840305437089092<br>
...etc...
</p>
Where:
<ul>
 <li>the first column is the gene/protein name.
 <li>the 'avg_log2FC' or 'avg_logFC' column is the fold-change // TODO: check for other names for this column.
 <li>the 'p_val_adj' is the P=value (if there is no 'p_val_adj' column, then 'p_val' [unadjusted <i>p</i>-value] column is used instead).
</ul>

<p>These columns typically have the following meaning (from: <a href="https://satijalab.org/seurat/articles/de_vignette.html#perform-default-differential-expression-tests-1">Differential expression testing in Seurat</a>):</p>
<ul>
 <li><i>p_val</i> : p_val (unadjusted)
 <li><i>avg_logFC</i> : log fold-change of the average expression between the two groups. Positive values indicate that the feature<br>is more highly expressed in the first group.
 <li><i>pct.1</i> : The percentage of cells where the feature is detected in the first group
 <li><i>pct.2</i> : The percentage of cells where the feature is detected in the second group
 <li><i>p_val_adj</i> : Adjusted <i>p</i>-value, based on bonferroni correction using all features in the dataset.
</ul>

<b>OR:</b>
<h4>(b)  One TSV (Tab-separated values - ie. tab chanacters separating the columns) file containing differential (eg. between test and control samples) fold changes for all the samples:</h4> 
After you have selected several files (as described above) and set column names, then you can <i>optionally</i> downloaded a single file (using the 'Optionally: Download your data as single data file' link, which will appear below the 'Show/Update heatmap' button after the heatmap is displayed). This single file can make future loading of data easier, as then only need to open this one file, and/or share the one file with others in your research group.
<br>It's format is, for example:
<p style="font-family: monospace">
HIVE:	GENE_SYMBOL	10090:Mus_musculus:mmusculus<br>
Gene	Amacrine:EARLY	Amacrine:MID	Amacrine:LATE	Bipolar:EARLY	Bipolar:MID	Bipolar:LATE	Cone:EARLY	Cone:MID	Cone:LATE<br>
Aak1	0,0.6	0,0	-2.1	0,0	0,0.4<br>
Aamp	0,0.3	0,0	-0.6	0,0	0.3,0<br>
Aars	0,0.4	0,0	-0.3	0,1.2	0,0<br>
...etc....
</p>
where:
<br>The first row is:
<ul>
 <li>'HIVE:' indicates that the file is in this HIVE-browser format</li>
 <li>Gene/Protein symbol-type, (which can be one of: ENSEMBL_GENE_ID, ENSEMBL_TRANSCRIPT_ID, ENTREZ_GENE_ID, GENE_SYMBOL, ENSEMBL_PROTEIN_ID, UNIPROT_ID)</li>
 <li>Species/organism in the format: (eg: Mus musculus (Mouse) [10090 : Mus_musculus : mmusculus], OR: Homo sapiens (Human) [9606 : Homo_sapiens : hsapiens], etc)</li>
</ul>
<br>Then second row is: 
<ul>
 <li>first column is either 'Gene' or 'Protein'</li>
 <li>then several columns with heading format: CellType:TimePoint (or CellType:Condition, or CellType:Location, etc), eg: 'Amacrine:LATE' </li>
</ul>
<br>Then multiple rows of:
<ul>
 <li>first column: Gene or Protein name/id
 <li>then several columns with heading format: CellType:TimePoint (or CellType:Condition/Location, etc)
 <li>columns of gene/protein fold-change in format: GeneName, Fold-change:Optional <i>p</i>-value:Optional pct.1:Optional pct2, eg: .....    
</ul>


<br> &nbsp; <br>
(c) It is also possible to export data from a Spreadsheet (eg. Excel) using option to 'Save as..' or 'Export..', and select type 'comma-separated (csv)' or 'tab-separated (tsv)' file. Although <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8357140/" target="_blank">spreadsheets may have changed ('auto-corrected') some gene-names to dates</a>).
<br> &nbsp; <br>

</div>
</details>


</td></tr>
</table>


<!-- border-collapse:collapse;  -->



  </div>
  <div id="sjb_tab_content2" class="sjb_tab">

<!-- *** CANNOT USE "class round_corners" for this input_data_parameters_table table, as it causes all td rows of the enclosed two tables to be rounded -->
<table id="input_data_parameters_table" class="input_data_tables tool_table_show_td" style="display:none;">
<tr><th style="border-top-left-radius: 15px; border-top-right-radius: 15px;">(2) Set parameters for this input file data:

<!-- &nbsp; <button id="show_hide_input_data_parameters_table_button" onclick="show_hide_table_row('input_data_parameters');">Hide</button> -->

</th></tr>
<tr><td style="border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;">
<p style="color: green;">Below, select (a) Gene identifier; (b) Species; (c) Columns for each file; and (d) Data columns.<br>Then click the "<i>Show/Update heatmap</i>" button below to display the heatmap.</p>
<!-- br> pre June 2022: Then click the 'Read file into the heatmap' button to load the file.-->

<!-- NOT USED AS ALWAYS SHOWING P-VALUES IF AVAILABLE
<p><label for="fold_change_or_pvalue_select">Show Fold-change or P-values: </label> 
<select id="fold_change_or_pvalue_select" onchange="fold_change_or_pvalue_changed();">
  <option id="fold_change" selected>Fold change</option>
  <option id="pvalues">P-values for fold-change</option>
</select></p>
-->
<p style="text-align:left; margin-bottom: 0;">
<b><label for="gene_symbol_type">(a) Gene/Protein identifier type:</label></b>
<select id="gene_symbol_type" required onchange="gene_symbol_type_changed()">
 <option value="ENSEMBL_GENE_ID">Ensembl Gene Id (eg: ENSG00000112715 or: ENSMUSG00000023951)</option>
 <option value="ENSEMBL_TRANSCRIPT_ID">Ensembl Transcript Id (eg: ENST00000672860.3 or ENSMUST00000142351.9)</option>
 <option value="ENTREZ_GENE_ID">Entrez Gene Id (eg: 7422)</option>
 <option value="GENE_SYMBOL" selected>Gene symbol (eg: VEGFA)</option>
 <option value="ENSEMBL_PROTEIN_ID">Ensembl Protein Id (eg: ENSP00000500082.3 or ENSMUSP00000115883.3)</option>
 <option value="UNIPROT_ID">UniProt Protein Id (eg: P15692 or or Q99PS1)</option>
</select>
</p>

<span id="organism_species_anchor"></span><!-- so scroll into view organism slect will not hide behind header -->

<details><summary class="tooltip" style="text-align: left; margin: 0 0 auto 15px;">Gene/Protein identifier Help [Click to show/hide]</summary>
<div style="text-align:left; font-size:90%; width:60%; border:1px solid black; padding: 10px; margin: 0 0 auto 15px; background: #eee;">
  Select the Gene/Protein identifier type used in your input data file(s).
</div>
</details> 

<!-- Putting the details at start of paragraph cause p to be centered as doesn't go into paragraph -->

<!--
Maybe RefSeq:
 REFSEQ_GENOMIC
 REFSEQ_MRNA
 REFSEQ_PROTEIN
 REFSEQ_RNA
-->

<!-- TaxId: https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?mode=Info&id=39947&lvl=3&lin=f&keep=1&srchmode=1&unlock -->

<!-- The values below are:  Tax id for StringDB : (optional: plants/)Ensembl_name : Species-short-name-for-GProfiler -->

<!-- http://plants.ensembl.org/ -->
<br>
<p style="text-align:left; margin-bottom: 0;"><b><label for="organism_species">(b) Organism/Species:</label></b>
 <select id="organism_species" name="organism_species" required onchange="organism_species_changed();">
  <option value="" selected disabled>Select species</option>
  <option value="9606:Homo_sapiens:hsapiens">Homo sapiens (Human) [9606 : Homo_sapiens : hsapiens]</option>
  <option value="10090:Mus_musculus:mmusculus">Mus musculus (Mouse) [10090 : Mus_musculus : mmusculus]</option>
  <option value="3702:plants/Arabidopsis_thaliana:athaliana">Arabidopsis thaliana (Thale cress) [3702 : plants/Arabidopsis_thaliana : athaliana]</option>
  <option value="9913:Bos_taurus:btaurus">Bos taurus (Cow) [9913 : Bos_taurus : btaurus]</option>  
  <option value="6239:Caenorhabditis_elegans:celegans">Caenorhabditis elegans (C. elegans Nematode worm) [6239 : Caenorhabditis_elegans : celegans]</option>
  <option value="7955:Danio_rerio:drerio">Danio rerio (Zebrafish) [7955 : Danio_rerio : drerio]</option>  
  <option value="7227:Drosophila_melanogaster:dmelanogaster">Drosophila melanogaster (Fruit fly) [7227 : Drosophila_melanogaster : dmelanogaster]</option>
  <option value="9031:Gallus_gallus:ggallus">Gallus gallus (Chicken) [9031 : Gallus_gallus : ggallus]</option>
  <option value="39947:plants/Oryza_sativa:osativa">Oryza sativa Japonica group (Japanese rice) [39947 : plants/Oryza_sativa : osativa]</option>
  <option value="10116:Rattus_norvegicus:rnorvegicus">Rattus norvegicus (Rat) [10116 : Rattus_norvegicus : rnorvegicus]</option>
  <option value="4932:scerevisiae">Saccharomyces cerevisiae S288C (Baker's Yeast) [4932 : scerevisiae]</option>
  <option value="8364:Xenopus_tropicalis:xtropicalis">Xenopus tropicalis (Western/Tropical clawed frog) [8364 : Xenopus_tropicalis : xtropicalis]</option>
  <option value="4577:plants/Zea_mays:zmays">Zea mays (Maize/corn) [4577 : plants/Zea_mays : zmays]</option>
  <option value="OTHER:OTHER">OTHER</option>
 </select>
</p>
<details><summary class="tooltip" style="text-align: left; margin: 0 0 auto 15px;">Organism/Species Help [Click to show/hide]</summary>
<div style="text-align:left; font-size:90%; width:60%; border:1px solid black; padding: 10px; margin: 0 0 auto 15px; background: #eee;">
 <p>Organism/Species format:  Name [Tax-Id : Ensembl-Id : gProfiler-Id]</p>
 <br>Where:
 <ul>
 <li> TaxId is from: <a href="https://www.ncbi.nlm.nih.gov/taxonomy" title="NCBI Taxonomy search webpage">Tax-id</a></li>
 <li> Ensembl-Id: <a href="https://www.ensembl.org/info/about/species.html" title="Ensembl species list">Ensembl-id</a> <i><b>OR</b></i> plant/<a href="https://plants.ensembl.org/species.html" title="Ensembl plant species list">Ensembl-plant-id</a></li> 
 <li> gProfiler-Id: <a href="https://biit.cs.ut.ee/gprofiler/page/organism-list" title="gProfiler organism list">gProfiler-species-id</a></li>
 <li>Eg: &nbsp; 9606 : Homo_sapiens : hsapiens</li>
</ul>
</div>
</details>

 <div id="other_organism_species_div" style="display:none;">
 <label id="other_organism_species_label" for="other_organism_species">Other species:</label>
 <input type="text" id="other_organism_species" size="30" onchange="other_organism_species_changed();">
 <br><span style="color:gray; font-size:85%;">(Enter 'Other species' in format:  <a href="https://www.ncbi.nlm.nih.gov/taxonomy" title="NCBI Taxonomy search webpage">Tax-id</a> : <a href="https://www.ensembl.org/info/about/species.html" title="Ensembl species list">Ensembl-id</a> <i><b>OR</b></i> plant/<a href="https://plants.ensembl.org/species.html" title="Ensembl plant species list">Ensembl-plant-id</a> : <a href="https://biit.cs.ut.ee/gprofiler/page/organism-list" title="gProfiler organism list">gProfiler-species-id</a><br>Eg: &nbsp; 9606 : Homo_sapiens : hsapiens )</span>
 </div>
<p id="organism_species_message" style="text-align:center; color:red; font-size: 110%; font-weight:bold;"></p>

<br>



<div id="select_column_names_div" style="display:none; margin:0; padding:0; border:0;">

<p style="text-align:left; margin-bottom: 0;"><label><b>(c) Set column names (eg: CellType or TissueType; and eg: TimePoint, Condition or Location) for <i>each input file</i>:</b></label></p>

<details><summary class="tooltip" style="text-align: left; margin: 0 0 auto 15px;">Column Names Help [Click to show/hide]</summary>
<div style="text-align:left; font-size:90%; width:60%; border:1px solid black; padding: 10px; margin: 0 0 auto 15px; background: #eee;">
  Enter the names to use for each column heading (eg. Cell-Type or Tissue-Type) and optional subheading (eg: TimePoint, Condition or Location). You can also click on a row with mouse and drag to change order of the columns.
  <br>&nbsp;<br>For example, if you enter:
  <table>
  <tr><th>Input filename</th><th>Column main-name<br><span style="font-size:90%;">(eg: Cell-type/cluster)</span></th>
      <th>Column sub-name (optional)<br><span style="font-size:90%;">(eg: Time-point or Condition)</span><br></th>
  </tr>
  <tr><td>Liver-Early.csv</td><td>Liver</td><td>Early</td></tr>
  <tr><td>Liver-Late.csv</td><td>Liver</td><td>Late</td></tr>
  <tr><td>Retina-Early.csv</td><td>Retina</td><td>Early</td></tr>
  <tr><td>Retina-Late.csv</td><td>Retina</td><td>Late</td></tr>
  </table>
  <br>then the Heat-map headings will become:
  <table>
   <tr><th></th><th>Liver</th><th>Liver</th><th>Retina</th><th>Retina</th><td>(This is main names)</td></tr>
   <tr><th>Gene</th><th>Early</th><th>Late</th><th>Early</th><th>Late</th><td>(This is sub-names)</td></tr>
   <tr><td>Kras</td><td>1.4</td><td>2.5</td><td>-1.3</td><td>0.3</td><td>(The fold-change results)</td></tr>
   <tr><td>Vegfa</td><td>0.4</td><td>-0.5</td><td>0.1</td><td>0.3</td><td>(Etc...)</td></tr>
  </table>
</div>
</details>

  <table class="round_corners"> <!-- could add, but prevents selecting the filename text: style="user-select: none; -webkit-user-select: none; -->
  <thead><tr><th>Input filename</th><th>Column main-name<br><span style="font-size:90%;">(eg: Cell-type/cluster)</span></th>
             <th>Column sub-name (optional)<br><span style="font-size:90%;">(eg: Time-point or Condition)</span></th>
  </tr></thead>
  <tbody id="unknown_filenames_tbody"></tbody>
  </table>
<p id="column_names_message" style="text-align:center; color:red; font-size: 110%; font-weight:bold;"></p>

<br>

</div>



<div id="select_column_types_div" style="display:none; margin:0; padding:0; border:0;">

<p style="text-align:left; margin-bottom: 0;"><label><b>(d) Select the column data type (eg: Fold-change, P-value, etc) for <i>columns from input files</i>:</b></label></p>
<details><summary class="tooltip" style="text-align: left; margin: 0 0 auto 15px;">Data types Help [Click to show/hide]</summary>
<div style="text-align:left; font-size:90%; width:60%; border:1px solid black; padding: 10px; margin: 0 0 auto 15px; background: #eee;">
  Select the Data Type for each column, eg: Gene/Protein id, Fold change, P-value/FDR/q-value, Percentages of cells, or Not used.
</div>
</details> 

  <table class="round_corners">
  <thead><tr><th>Column number in files</th><th>Column heading from file(s)</th><th>Select Type for this column</th></tr></thead>
  <tbody id="unknown_column_types_tbody"></tbody>
  </table>
<p id="column_types_message" style="text-align:center; color:red; font-size: 110%; font-weight:bold;"></p>

</div>


<div id="select_column_names_and_types_div" style="display:none; margin:0; padding:0; border:0;">

<!-- OR: Name and col types in one table for single non-hive file -->
<p style="text-align:left; margin-bottom: 0;"><label><b>(c) Set column names (eg: CellType or TissueType; and eg: TimePoint, Condition or Location) and data type (eg: Fold-change, P-value, etc) for <i>each column in the input file</i>:</b></label></p>

<details><summary class="tooltip" style="text-align: left; margin: 0 0 auto 15px;">Column Names Help [Click to show/hide]</summary>
<div style="text-align:left; font-size:90%; width:60%; border:1px solid black; padding: 10px; margin: 0 0 auto 15px; background: #eee;">
  Enter the names to use for each column heading (eg. Cell-Type or Tissue-Type) and optional sub-heading (eg: TimePoint, Condition or Location). You can also click on a row with mouse and drag to change order of the columns.
  <br>&nnbsp;<br>For example, if you enter:
  <table>

  <tr><th>Input column heading</th><th>Column main-name<br><span style="font-size:90%;">(eg: Cell-type/cluster)</span></th>
      <th>Column sub-name (optional)<br><span style="font-size:90%;">(eg: Time-point or Condition)</span></th>
      <th>Select Type for this column</th>
  </tr>
  <tr><td>Liver_Early_logFC</td><td>Liver</td><td>Early</td><td>Fold-change</td></tr>
  <tr><td>Liver_Early_Pval</td><td>Liver</td><td>Early</td><td>P-value</td></tr>
  <tr><td>Liver_Late_logFC</td><td>Liver</td><td>Late</td><td>Fold-change</td></tr>
  <tr><td>Liver_Late_Pval</td><td>Liver</td><td>Late</td><td>P-value</td></tr>
  <tr><td>Retina_Early_logFC</td><td>Retina</td><td>Early</td><td>Fold-change</td></tr>
  <tr><td>Retina_Early_Pval</td><td>Retina</td><td>Early</td><td>P-value</td></tr>
  <tr><td>Retina_Late_logFC</td><td>Retina</td><td>Late</td><td>Fold-change</td></tr>
  <tr><td>Retina_late_Pval</td><td>Retina</td><td>Late</td><td>P-value</td></tr>

  </table>
  <br>then the Heat-map headings will become:
  <table>
   <tr><th></th><th>Liver</th><th>Liver</th><th>Retina</th><th>Retina</th><td>(This is main names)</td></tr>
   <tr><th>Gene</th><th>Early</th><th>Late</th><th>Early</th><th>Late</th><td>(This is sub-names)</td></tr>
   <tr><td>Kras</td><td>1.4 (0.05)</td><td>2.5 (0.03)</td><td>-1.3 (0.02)</td><td>0.3 (0.08)</td><td>(The fold-change and p-value results)</td></tr>
   <tr><td>Vegfa</td><td>0.4 (0.02)</td><td>-0.5 (0.07)</td><td>0.1 (0.1)</td><td>0.3 (0.03)</td><td>(Etc...)</td></tr>
  </table>
</div>
</details>

  <table class="round_corners"> <!-- could add, but prevents selecting the filename text: style="user-select: none; -webkit-user-select: none;" -->
  <thead><tr><th>Input column heading</th><th>Column main-name<br><span style="font-size:90%;">(eg: Cell-type/cluster)</span></th>
             <th>Column sub-name (optional)<br><span style="font-size:90%;">(eg: Time-point or Condition)</span></th>
             <th>Select Type for this column</th>
  </tr></thead>
  <tbody id="unknown_column_names_and_types_tbody"></tbody>
  </table>
<p id="column_column_names_and_types_message" style="text-align:center; color:red; font-size: 110%; font-weight:bold;"></p>

</div>

<p><button id="show_heatmap_with_column_names_and_types_button" onclick="show_heatmap_with_column_names_and_types();" style="display: none;">Show/Update heatmap</button></p>

<p id="show_validate_input_data_parameters_progress" style="text-align:center; color:red; font-size: 110%;"></p>

<p id="download_single_data_file_link_p" style="display:none;"><a id="download_single_data_file_link" title="Download this data as a single file to make future loading of data easier, as just need to open one file then." href="#" onclick="download_single_data_file(event,this);" style="font-size:80%;">Optionally: Download your data as single data file.</a>
<br><span id="download_single_data_file_progress"></span>

</div>


<p id="loading_heatmap_message" style="text-align:center; color:red; font-size: 110%;"></p>

</p>

</table>

<br>


  </div>
  <div id="sjb_tab_content3" class="sjb_tab">


<table id="display_options_table" class="filter_and_display_options_tables round_corners" style="display:none;"> <!-- NOT:  tool_table_hide_td -->
<tr><th>(3) Display options:</th></tr>

<tr><td> <!-- style="display:none;" -->

<p id="p_show_pvalues" style="text-align:left; display:none;"><input type="checkbox" id="show_pvalues" onchange="show_heatmap();"> <label for="show_pvalues">Show <i>p</i>-values on the heatmap below.</label></p>

<p id="p_show_pct12_values" style="text-align:left; display:none;"><input type="checkbox" id="show_pct12_values" onchange="show_heatmap();"> <label for="show_pct12_values">Show pct.1 &amp; pct.2 values (percentage of cells where the feature is detected in the first &amp; second groups.)</label></p>

<p id="p_show_sort_order" style="text-align:left;"><label>Sort order of heatmap rows: <select id="logsort_select" onchange="sort_data(this); show_heatmap();">
  <option value="none">Same as input file(s)</option>
  <option value="gene_id">Gene ID/name alphabetically: 0-9A-Z</option>
  <option value="fc_max">Fold-change Max to min = Abs(max_fc in the row) : decreasing order</option>
  <option value="fc_min">Fold-change Min to max = Abs(max_fc in the row) : increasing order</option>
  <option value="fc_range">Fold-change Range = Abs(max_fc - min_fc in the row) : decreasing order</option>
  <option value="p_value">P-value/FDR/q-value = (min p-value in the row) : increasing order</option>
 </select>
</label>

<p id="display_options_message" style="text-align:center; color:red; font-size: 100%;"></p>


</td></tr></table>




<!-- An instruction to select ...  to perform the steps below ... -->

<!-- Not in GProfiler: Escherichia coli (E. coli) -->

<br>

  </div>
  <div id="sjb_tab_content4" class="sjb_tab">


<table id="filter_heatmap_table" class="filter_and_display_options_tables round_corners" style="display:none;"> <!-- NOT:  tool_table_hide_td -->
<tr><th>(4) Filter heatmap rows (ie: genes/proteins):</th></tr>

<tr><td style="text-align:left;">
<p><b>Show only heatmap rows (eg: genes/proteins) that have:</b></p> 

<fieldset><legend>Select the Fold change:</legend>
  <p><label for="fc_amount" style="vertical-align:top;"><b>Fold change of:</b></label>
 <!-- p>(a) <label for="fc_more_or_less" style="vertical-align:top;"><b>Fold-change of:</b></label -->

 <select id="fc_more_or_less" onchange="show_heatmap();" style="display:none; vertical-align:top;">
  <option value="Any" selected>Any fold-change</option>
  <option value="more">&ge; &plus; (eg. &ge; 2)</option>
  <option value="less">&le; &minus; (eg. &le; -2)</option>
  <option value="absMore">Abs() &ge; (eg. Abs(fc) &ge; 2. Abs() removes any negative sign from the fold change)</option>
  <option value="absLess">Abs() &le; (eg. Abs(fc) &le; 2. Abs() removes any negative sign from the fold change)</option>
 </select>

 <select id="fc_amount" onchange="fc_amount_changed()" style="vertical-align:top;"></select>

 <br><span id="p_show_all_foldchanges_in_row" style="display:none"><input type="checkbox" id="show_all_foldchanges_in_row" checked onchange="show_heatmap();"> 
  <label for="show_all_foldchanges_in_row">Show Fold-changes values that are outside this fold-change filter value.</label>
 </span>

 </p>
</fieldset>

<p><fieldset><legend>and Select the p-value/FDR/q-value:</legend>
<!-- The following pvalue_less_than is only shown when has_pvalues_columns is true -->
<p><label id="pvalue_less_than_label" for="pvalue_less_than"><b><i>P</i>-value/FDR/q-value of:</b></label>
 <select id="pvalue_less_than" onchange="pvalue_less_than_changed()">
  <option value="Any">Any p-value/FDR/q-value</option>
  <option value="0.5" selected>&le; 0.5</option>
  <option value="0.1">&le; 0.1</option>
  <option value="0.05">&le; 0.05</option>
  <option value="0.01">&le; 0.01</option>
  <option value="0.005">&le; 0.005</option>
  <option value="0.001">&le; 0.001</option>
 </select>
 <span id="pvalue_less_than_message"></span>

 <br><span id="p_show_all_pvalues_in_row" style="display:none"><input type="checkbox" id="show_all_pvalues_in_row" checked onchange="show_heatmap();"> 
  <label for="show_all_pvalues_in_row">Show fold-change values (and <i>p</i>-values/FDR/<i>q</i>-values if checked on the '<i>(3) Display options</i>' tab) that are above this <i>p</i>-value filter.</label>
 </span>

  <!-- OLD: pre Aug 2023: Show all <i>p</i>-values/FDR/<i>q</i>-values in rows with at least one <i>p</i>-value/FDR/<i>q</i>-value under the above <i>p</i>-value/FDR/<i>q</i>-value filter<br>(otherwise hides table cells that are above this <i>p</i>-value filter).</label></span> -->
</p>

</fieldset>
</p>

<!--
<p><b>(a)</b> <select id="min_num_fc_for_gene" onchange="show_heatmap();">
  <option value="0">0</option>
  <option value="1" selected>1</option>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
  <option value="5">5</option>
  <option value="6">6</option>
  <option value="7">7</option>
  <option value="8">8</option>
  <option value="9">9</option>
</select>
<label for="min_num_fc_for_gene">or more <b>columns having fold-changes</b>.</label>
</p>
-->

<!--
(a) Fold changes in at least:
<label for="min_num_fc_for_gene2">or more <b>columns having fold-changes</b>: </label>
-->



<!-- br><label for="fc_in_celltype_and_time" style="vertical-align:top;">in cell-type/cluster:</label><br -->

<p>
<fieldset id="fc_separate_celltype_times_checkboxes_fieldset"><legend>and Select the Cell-types/clusters and Time-points/condition:</legend>

 <label for="min_num_fc_for_gene2">In <b>columns</b>: </label>
 <select id="min_num_fc_for_gene2" onchange="min_num_fc_for_gene2_changed(this);"></select> <!-- min_num_fc_for_gene2_changed() also calls: show_heatmap(); -->

<!-- overflow-y: scroll; -->
<div id="old_select_list_menus_div" style="display:none">
 <br><label for="fc_in_celltype" style="vertical-align:top;">in cell-type/cluster:</label><br>
     <select id="fc_in_celltype" multiple onchange="show_heatmap();" style="vertical-align:top; min-width:100px;"></select>
     <br><button onclick="select_all_options('fc_in_celltype', 'all')">All</button> <button onclick="select_all_options('fc_in_celltype', 'none')">None</button>

 <br><label for="fc_at_time" style="vertical-align:top;">at time-point or condition:</label><br>
     <select id="fc_at_time" multiple onchange="show_heatmap();" style="vertical-align:top; min-width:100px;"></select> 
     <br><button onclick="select_all_options('fc_at_time', 'all')">All</button> <button onclick="select_all_options('fc_at_time', 'none')">None</button>
</div>


<details><summary class="tooltip" style="text-align: left; margin: 0 0 auto 15px;">Select columns Help [Click to show/hide]</summary>
<div style="text-align:left; font-size:90%; width:60%; border:1px solid black; padding: 10px; margin: 0 0 auto 15px; background: #eee;">
  Changing any '<i>Cell-type/cluster</i>' or '<i>Time-point or condition</i>' check-boxes (left &amp; middle below) will update the '<i>Heatmap columns</i>' check-boxes (on the right below), and <i>vice-versa</i>. After changing a 'Heatmap columns' check-box (on right below) the corresponding 'Cell-types/clusters' or 'Time-points/condition' checkbox (on left below) can become a minus sign or grey, meaning that it is only partly checked, based on which 'Heatmap columns' are checked, which is okay (eg. if 'EARLY' is both checked any unchecked in the 'Heatmap columns' then 'EARLY' will become indeterminate (a minus sign) in the 'Timepoint' checkbox.). The Heatmap rows will be filtered using the selected 'Heatmap columns' check-boxes.
</div>
</details> 


<table style="border:0;">
 <tr><td style="vertical-align:top; border:0;">

  <table>
   <thead><tr><th>Cell-type/cluster:</th></tr></thead>
   <tbody id="celltypes_tbody">
   </tbody>
   <tbody>
    <tr><td>
     <button id="fc_in_celltype_checkboxes_all_button" onclick="select_all_checkboxes('fc_in_celltype_checkboxes', 'all'); show_heatmap();">All</button> <button id="fc_in_celltype_checkboxes_none_button" onclick="select_all_checkboxes('fc_in_celltype_checkboxes', 'none'); show_heatmap();">None</button>
    </td></tr>
   </tbody>
  </table>

 </td><td style="vertical-align:top; border:0;">

  <table>
   <thead><tr><th>Time-point or condition:</th></tr></thead>
   <tbody id="times_tbody">
   </tbody>
   <tbody>
    <tr><td>
     <button id="fc_at_time_checkboxes_all_button" onclick="select_all_checkboxes('fc_at_time_checkboxes', 'all'); show_heatmap();">All</button> <button id="fc_at_time_checkboxes_none_button" onclick="select_all_checkboxes('fc_at_time_checkboxes', 'none'); show_heatmap();">None</button>
    </td></tr>
   </tbody>
  </table>

 </td><td style="vertical-align:middle; border:0;">

 <!-- &#8882; -->&#9664;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9654; <!-- &#8658; &#8883;--> <!-- &#9552; or &boxH; is a unicode Box Drawings Double Horizontal, defined in unicode 1.1 1993 -->
 <br><span style="font-size:85%">Clicking check-boxes on the left<br>will update check-boxes on the right,<br>and <i>vice-versa</i>.</span>
 
 </td><td style="vertical-align:top; border:0;">

 <table>
  <thead><tr><th style="text-align:center;">Heatmap Columns<br>Cell-type/cluster : Time-point/condition</th></tr>

  <tbody>
   <tr><td id="fc_in_celltype_and_time_checkboxes_td" style="text-align: left; border-radius:0;"></thead>
   </td></tr>

   <tr><td>
    <button id="fc_in_celltype_and_time_checkboxes_all_button" onclick="select_all_checkboxes('fc_in_celltype_and_time_checkboxes', 'all'); show_heatmap();">All</button> <button id="fc_in_celltype_and_time_checkboxes_none_button" onclick="select_all_checkboxes('fc_in_celltype_and_time_checkboxes', 'none'); show_heatmap();">None</button>
   </td></tr>
  </tbody>
 </table>

 </td></tr>
</table>

<div style="font-size:85%; text-align:center; margin: 0 auto;">(You can optionally select several checkboxes at once in the above 'Cell-type/cluster', 'Time-point/condition' or 'Heatmap Columns menus:<br> after clicking one checkbox with nmouse, hold down the [Shift] key while clicking a second checkbox, then the checkboxes between will also be checked.)</div>

</fieldset>
</p>

<!--
<button id="show_fc_single_celltype_times_checkboxes_fieldset_button" onclick="show_celltype_times_checkboxes_fieldset('single')" style="display:none">Heatmap columns list</button>
<button id="show_fc_separate_celltype_times_checkboxes_fieldset_button" onclick="show_celltype_times_checkboxes_fieldset('separate')" style="display:none">Cell-type/cluster &amp; Time-point/condition lists</button>

<fieldset id="fc_single_celltype_times_checkboxes_fieldset" style="display:none"><legend>Select the Columns:</legend>
 <table>
  <thead><tr><th style="text-align:center;">Heatmap Columns<br>Cell-type/cluster : Time-point/condition</th></tr>

  <tbody>
   <tr><td id="fc_in_celltype_and_time_checkboxes_td" style="text-align: left; border-radius:0;"></thead>
   </td></tr>

   <tr><td>
    <button id="fc_in_celltype_and_time_checkboxes_all_button" onclick="select_all_checkboxes('fc_in_celltype_and_time_checkboxes', 'all'); show_heatmap();">All</button> <button id="fc_in_celltype_and_time_checkboxes_none_button" onclick="select_all_checkboxes('fc_in_celltype_and_time_checkboxes', 'none'); show_heatmap();">None</button>
   </td></tr>
  </tbody>
 </table>
<div style="font-size:80%; text-align:center; margin: 0 auto;">(You can optionally select several checkboxes at once in the above 'Heatmap Columns : Cell-type/cluster : Time-point/condition' menu:<br> after clicking one checkbox with nmouse, hold down the [Shift] key while clicking a second checkbox, then the checkboxes between will also be checked.)</div>
</fieldset>


<fieldset id="fc_separate_celltype_times_checkboxes_fieldset" style="display:none"><legend>Select the Cell-types/clusters and Time-points/condition:</legend>
<table style="border:0;">
 <tr><td style="vertical-align:top; border:0;">

  <table>
   <thead><tr><th>Cell-type/cluster:</th></tr></thead>
   <tbody id="celltypes_tbody">
   </tbody>
   <tbody>
    <tr><td>
     <button id="fc_in_celltype_checkboxes_all_button" onclick="select_all_checkboxes('fc_in_celltype_checkboxes', 'all'); show_heatmap();">All</button> <button id="fc_in_celltype_checkboxes_none_button" onclick="select_all_checkboxes('fc_in_celltype_checkboxes', 'none'); show_heatmap();">None</button>
    </td></tr>
   </tbody>
  </table>

 </td><td style="vertical-align:top; border:0;">

  <table>
   <thead><tr><th>Time-point or condition:</th></tr></thead>
   <tbody id="times_tbody">
   </tbody>
   <tbody>
    <tr><td>
     <button id="fc_at_time_checkboxes_all_button" onclick="select_all_checkboxes('fc_at_time_checkboxes', 'all'); show_heatmap();">All</button> <button id="fc_at_time_checkboxes_none_button" onclick="select_all_checkboxes('fc_at_time_checkboxes', 'none'); show_heatmap();">None</button>
    </td></tr>
   </tbody>
  </table>
 </td></tr>
</table>
<div style="font-size:80%; text-align:center; margin: 0 auto;">(You can optionally select several checkboxes at once in the above timepoint/condition or celltype/cluster menus:<br> after clicking one checkbox with nmouse, hold down the [Shift] key while clicking a second checkbox, then the checkboxes between will also be checked.)</div>
</fieldset>
-->


     <!-- input type="checkbox" id="fc_in_celltype_and_time_2" name="fc_in_celltype_and_time" value="2" onclick="return ValidatePetSelection();"><label for="fc_in_celltype_and_time_2">2</label><br -->
     <!-- input type="checkbox" id="fc_in_celltype_and_time_3" name="fc_in_celltype_and_time" value="3" onclick="return ValidatePetSelection();"><label for="fc_in_celltype_and_time_3">3</label><br -->

     <!-- select id="fc_in_celltype_and_time" multiple onchange="show_heatmap();" style="vertical-align:top; min-width:100px;"></select -->


<!-- <label for="fc_or_and" style="vertical-align:top;">or/and:</label> <select id="fc_or_and" onchange="show_heatmap();" style="vertical-align:top;"><option value="OR">OR</option><option value="AND">AND</option></select> --> 

</p>
<!-- div style="font-size:80%; text-align:center; margin: 0 auto;">(NOTE: To select more than one timepoint/condition or celltype/cluster in the above menus:<br> hold down [Ctrl] key on Windows, or [Cmd] key on Mac,<br>while selecting the options with the mouse.)</div-->

<p style="text-align:center; font-size:85%">You can also optionally filter these by name/id by entering part or all of a gene-name in the left "Gene" column in the heatmap below.</p>

<p id="filter_heatmap_message" style="text-align:center; color:red; font-size: 120%;"><b><i>Loading heatmap ...</i></b></p>
</td></tr></table><br>


  </div>
  <div id="sjb_tab_content5" class="sjb_tab">

<table id="copy_selected_genes_table" class="tool_table round_corners"> <!-- class="..tool_table_hide_td "  style="display:none;" -->
<tr><th>Copy selected genes to clipboard:
 <!-- &nbsp; <button id="show_hide_copy_selected_genes_table_button" onclick="show_hide_table_row('copy_selected_genes');">Show</button> -->
</th></tr>

<tr id="copy_selected_genes_table_row"><td>
<ol style="font-size:85%; text-align:left; margin: 0 auto;">
<li>Select gene(s) using the check-boxes in left column of the heatmap table below.</li>
<li>Separate the genes in the list with:
<select id="copy_separator">
  <option value=" ">space</option>
  <option value=", ">comma</option>
  <option value="nl">new-line</option>
  <option value="tab">tab</option>
</select></li>
</ol>

<p><button id="copy_genelist_button" onclick="copy_selected_genenames_to_clipboard(this);" disabled>Copy selected genes to Windows/Mac/Linux clipboard</button></p>
<p id="copy_selected_genenames_message"></p>
</td></tr></table><br>


<table id="selected_genes_table" class="tool_table round_corners"> <!-- class = tool_table_hide_td" ... style="display:none;" -->
<tr><th>Selected genes: <span id="num_selected_genes" style="color:red">0</span>
 <!-- &nbsp; <button id="show_hide_selected_genes_table_button"  onclick="show_hide_table_row('selected_genes');">Show</button> -->
</th></tr>
<tr id="selected_genes_table_row"><td>
<p><span id="selected_genes" style="font-weight:bold;"></span></p>
<p style="font-size:85%">Select gene(s) using the check-boxes in left column of the heatmap table below.</p>
</td></tr></table><br>

  </div>
  <div id="sjb_tab_content6" class="sjb_tab">

 
<table id="gprofiler_table" class="tool_table round_corners"> <!-- class=tool_table_hide_td  style="display:none;" -->
<tr><th>G:Profiler:
<!-- &nbsp; <button id="show_hide_gprofiler_table_button" onclick="show_hide_table_row('gprofiler');">Show</button> -->

</th></tr>

<tr id="gprofiler_table_row"><td>
<ol style="font-size:85%; text-align:left; margin: 0 auto;">
<li>This uses the 'organism/species' selected on the '<i>(2) Select columns</i>' tab.</li>
<li>And your Selected gene(s) (selected using the check-boxes in left column of the heatmap table below).</li>
</ol>

<!-- target="_blank" action="https://biit.cs.ut.ee/gprofiler/gost" -->
<form id="gprofiler_form" method="get" target="_blank">
  <!-- 15 Nov 2022: changed the above to method to "post", as allows more genes than "get" -->
  <!-- **** FEB 2023: BUT POST NOW GIVES A: "405 Not Allowed" -->

  <!--p><b>Organism:</b> <select id="gprofiler_organism" name="organism"><option value="hsapiens">Homo sapiens (Human)</option><option value="mmusculus" selected>Mus musculus (Mouse)</option><option value="rnorvegicus">Rattus norvegicus (Rat)</option></select></p-->

  <p><b>Organism: </b><span id="gprofiler_organism_text">Select species using the drop-down menu above.</span></p>
  <input type="hidden" id="gprofiler_organism" name="organism" value="">
  <input type="hidden" id="gprofiler_query_genelist" name="query" value="">
  <p style="text-align:center">
  Number of genes selected: <b><span id="gprofiler_num_selected_genes">0</span></b><br>
  <input type="submit" id="submit_gprofiler_button" disabled onclick="set_organism_and_genelist(this, 'gprofiler');">
  </p>
  <p><span id="gprofiler_progress"></span></p>
</form>
</td></tr></table><br>
<!-- p style="text-align:center;">
<a href="" title="G:Profiler" target="_blank" onclick="gprofiler(this);">G:Profiler with selected genes</a>
</p -->


  </div>
  <div id="sjb_tab_content7" class="sjb_tab">



<table id="stringdb_table" class="tool_table round_corners"> <!-- class=tool_table_hide_td  style="display:none;" -->
<tr><th>String DB:
<!-- &nbsp; <button id="show_hide_stringdb_table_button" onclick="show_hide_table_row('stringdb');">Show</button> -->
</th></tr>

<tr id="stringdb_table_row"><td>

<ol style="font-size:85%; text-align:left; margin: 0 auto;">
<li>This uses the 'organism/species' selected on the '<i>(2) Select columns</i>' tab.</li>
<li>And your Selected gene(s) (selected using the check-boxes in left column of the heatmap table below).</li>
<li>You can then set the 'Required-score', 'Additional network nodes', and 'Network flavor' options below.</li>
<li>For the 'Require score' option: a lower score includes more interactions.</li>
<li>After clicking this "Show Stringdb image" button, if the String image doesn't appear within a couple of 
<br>seconds, it's probably because the gene(s) is not be in StringDB for the selected Organism/species.</li>
<li>Some genes (eg: 'Malat1') are in Human but not in Mouse Stringdb.</li>
<li>Click on a gene in the String image to show its abstract.</li>
<li>Click the 'STRING' logo to go to the String webpage in a new browser tab (eg. to view the interaction details).</li>
</ol>

<input type="hidden" id="stringdb_species" name="stringdb_species" value="">
<p><span style="font-size:80%"> Organism/Species: <b><span id="stringdb_species_text">Select organism/species above.</span></b>

<!-- label><input type="radio" id="stringdb_species_mouse" name="stringdb_species" value="mouse" onclick="enable_stringdb_button();" disabled checked>Mouse (Mus musculus: tax_id=10090)</label> &nbsp;
<label><input type="radio" id="stringdb_species_human" name="stringdb_species" value="human" onclick="enable_stringdb_button();" disabled>Human (Homo sapiens: tax_id=9606)</label-->


<br>Number of rows (genes) selected: <b><span id="stringdb_num_selected_genes">0</span></b>

<br>
Required score: <select id="stringdb_required_score" name="required_score" onchange="enable_stringdb_buttons();" disabled>
  <option value="0">0</option>
  <option value="100">100</option>
  <option value="200">200</option>
  <option value="300">300</option>
  <option value="400">400</option>
  <option value="500" selected>500</option>
  <option value="600">600</option>
  <option value="700">700</option>
  <option value="800">800</option>
  <option value="900">900</option>
  <option value="1000">1000</option>
</select> &nbsp; 
Additional network nodes: <select id="stringdb_additional_network_nodes" name="additional_network_nodes" onchange="enable_stringdb_buttons();" disabled>
  <option value="0" selected>0</option>
  <option value="5">5</option>
  <option value="10">10</option>
  <option value="20">20</option>
  <option value="30">30</option>
  <option value="40">40</option>
  <option value="50">50</option>
  <option value="60">60</option>
  <option value="70">70</option>
  <option value="80">80</option>
  <option value="90">90</option>
  <option value="100">100</option>
</select> &nbsp;
Network flavor: <select id="stringdb_network_flavor" name="network_flavor" onchange="enable_stringdb_buttons();" disabled>
  <option value="confidence" selected>Confidence</option> 
  <option value="evidence">Evidence</option>
  <option value="actions">Actions</option>
</select>
</span>


  <!-- 
  <input type="hidden" id="form_stringdb_organism"                 name="species"                  value="">
  <input type="hidden" id="form_stringdb_genelist"                 name="identifiers"              value="">
  <input type="hidden" id="form_stringdb_show_query_node_labels"   name="show_query_node_labels"   value="1"> 
  <input type="hidden" id="form_stringdb_caller_identity"          name="caller_identity"          value="qub.ac.uk"> 
     var stringdb_caller_identity = 'qub.ac.uk'; // Temporary.
  -->

<br> &nbsp; <br><button id="stringdb_embedded_button" onclick="stringdb('embedded');">Show StringDB image here</button> <!-- Not using disable now - instead give error mesage if taxid or genes not selected -->
&nbsp; &nbsp; 

<a id="stringdb_in_newtab_anchor_link" target="_blank" onclick="stringdb('in_newtab');"><button id="stringdb_in_newtab_button">Show StringDB in new browser tab</button></a> <!-- Not using disable now - instead give error mesage if taxid or genes not selected -->
 
  <!--p><b>Organism:</b> <select id="gprofiler_organism" name="organism"><option value="hsapiens">Homo sapiens (Human)</option><option value="mmusculus" selected>Mus musculus (Mouse)</option><option value="rnorvegicus">Rattus norvegicus (Rat)</option></select></p-->

<!-- onclick="set_form_stringdb_organism_and_genelist();" -->



<!-- Is correctly GET here, or I need to set the to field for POST  -->
<!-- NOT using this form now: 
<form id="form_stringdb" method="GET" target="_blank"> 

  <input type="hidden" id="form_stringdb_to" name="to" value="">

  <input type="submit" id="form_stringdb_in_newtab_submit_button" name="form_stringdb_submit_button" onclick="stringdb('in_newtab');" value="Open StringDB with this selected gene-list" disabled>
</form>
-->

<p id="stringdb_message"></p>

<div id="stringEmbedded" style="margin:0 auto; text-align:center;"></div>
</td></tr></table><br>
<!-- NOTE: for radio button, onclick isn't fired if use keyboard tab+space to select, so could also add oninput or onchange(which isn't fired in some browsers) -->



  </div>
  <div id="sjb_tab_content8" class="sjb_tab">

<table id="david_table" class="tool_table  round_corners"> <!-- class= tool_table_hide_td  style="display:none;" -->
<tr><th>DAVID Bioinformatics Resources (at LHRI):
<!-- &nbsp; <button id="show_hide_david_table_button" onclick="show_hide_table_row('david');">Show</button> -->
</th></tr>

<tr id="david_table_row"><td>

<!-- p style="font-size:85%">First, organism/species (above) and Gene/Protein name type (above), and select gene(s)/proteins (using the check-boxes in left column of the heatmap table below).</p-->

<!--form method="get" target="_blank" action="https://david.ncifcrf.gov/api.jsp?type=xxxxx&ids=XXXXX,XXXXX,XXXXXX,&tool=xxxx&annot=xxxxx,xxxxxx,xxxxx," onclick="set_organism_and_genelist(this, 'david');"-->

<form id="david_form" method="get"> <!-- target="_blank"-->

<!-- form method="post" target="_blank" action="https://david.ncifcrf.gov/api.jsp" onclick="set_organism_and_genelist(this, 'david');" -->

  <!-- See: https://david.ncifcrf.gov/content.jsp?file=DAVID_API.html   action="https://david.ncifcrf.gov/api.jsp?type=xxxxx&ids=XXXXX,XXXXX,XXXXXX,&tool=xxxx&annot=xxxxx,xxxxxx,xxxxx," -->
  <!-- URL has a charactor size limitation (<= 2048 characters in total), i.e., the very large gene list may not be able to completely passed by URL. -->

  
  <p>To submit your selected gene list to DAVID:</p>
  <input type="submit" id="submit_david_button" value="Send selected gene list to the DAVID webserver" disabled onclick="set_organism_and_genelist(this, 'david');">
  <p><span id="david_progress"></span></p>

  <!-- set_david_type_tool_and_genelist();  https://david.ncifcrf.gov/api.jsp?type=xxxxx&ids=XXXXX,XXXXX,XXXXXX,&tool=xxxx&annot=xxxxx,xxxxxx,xxxxx, -->

  <!-- 15 Nov 2022: changed the above to method to "post", as allows more genes that "get" -->

  <!--p><b>Organism:</b> <select id="david_organism" name="organism"><option value="hsapiens">Homo sapiens (Human)</option><option value="mmusculus" selected>Mus musculus (Mouse)</option><option value="rnorvegicus">Rattus norvegicus (Rat)</option></select></p-->

<!-- 
  <p><b>Organism: </b><span id="david_organism_text"></span></p>
  <input type="hidden" id="david_organism" name="organism" value="">

  <input type="hidden" id="david_annot" name="annot" value="">

-->

  <input type="hidden" id="david_tool" name="tool" value="">

  <input type="hidden" id="david_gene_type" name="type" value="">

  <input type="hidden" id="david_ids_genelist" name="ids" value="">
    
<!--
<p><label for="david_tool_name">DAVID Tool name:</label>
<select id="david_tool_name" name="tool">
 <option value="gene2gene">Gene Functional Classification</option>
 <option value="term2term">Funtional Annotation Clustering</option>
 <option value="summary">Functional Annotation Summary</option>
 <option value="chartReport">Functional Annotation Chart</option>
 <option value="annotationReport">Functional Annotation Table</option>
 <option value="list">Show Gene List Names in Batch</option>
 <option value="geneReport">Gene Report</option>
 <option value="geneReportFull">Gene Full Report</option>
</select>

  <input type="submit" id="submit_david_button" name="submit_david_button" value="Go to DAVID with this selected gene-list" disabled>
  </p>
-->

</form>

  <p><b>However</b>, for 'OFFICIAL_GENE_SYMBOL' identifiers (eg: VEGFA), the above button may fail as DAIVD may be unable to match the gene symbol or one symbol can often apply to multiple species. (Eg. This does work for well establisted symbols, eg: EGR1, MALAT1, VEGFA, EGFR, but not for less established symbols. The above button doesn't have a way to specify the species to DAVID in the API). However you can manually submit your selected genes as explained below:</p>
  <ol style="font-size:85%; text-align:left; margin: 0 auto;">
   <li>Select your gene(s)/proteins (using the check-boxes in left column of the heatmap table below)</li>
   <li>Copy your list of selected genes/proteins using the '<i>Copy selected genes to Windows/Mac/Linux clipboard</i>' button (below)</li>
   <li>then go to: <a href="https://david.ncifcrf.gov/tools.jsp" target="_blank">DAVID Bioinformatics Resources, NIAID/NIH (at LHRI)</a> (opens in new tab in your browser)</li>
   <li>and paste your list into 'Step 1: Enter gene list'</li>
   <li>then on then DAVID website 'Step 2: Select identifier type', etc.</li>
  </ol>
 
  <p style="text-align:center">
  Number of genes/proteins selected: <b><span id="david_num_selected_genes">0</span></b><br>

  <p><button id="copy_genelist_button_for_david" onclick="copy_selected_genenames_to_clipboard(this);" disabled>Copy selected genes to Windows/Mac/Linux clipboard</button></p>
  <p id="copy_selected_genenames_message_for_david"></p>

</td></tr></table><br>
<!-- p style="text-align:center;">
<a href="" title="G:Profiler" target="_blank" onclick="gprofiler(this);">G:Profiler with selected genes</a>
</p -->
<!-- For "tool" tag: -->


  </div>
  <div id="sjb_tab_content9" class="sjb_tab">


<!-- display:none;  -->
<table id="create_heatmap_image_table" class="tool_table  round_corners"> <!-- class=tool_table_hide_td   style="display:none;" -->
<tr><th>Create heatmap image (to download):
<!-- &nbsp; <button id="show_hide_create_heatmap_image_table_button" onclick="show_hide_table_row('create_heatmap_image');">Show</button> -->
</th></tr>


<tr id="create_heatmap_image_table_row"><td> <!-- style="display:none;" -->

<p><label>Rows to plot: <select id="download_heatmap_rows_to_draw" onchange="clear_heatmap_show_image_size();"><option value="byfilter" selected>As selected by the 'Filter genes' above</option><option value="bycheckbox">As chosen by the checkboxes in left column below (so are in the genelist above)</option><option value="all">All rows</option></select></label></p>
<p><label>Columns to plot (not implemented): <select id="heatmap_images_columns_select" onchange="clear_heatmap_show_image_size();"><option value="allcolumns" selected onchange="show_hide_select_column_checkboxes()">All columns</option><option value="selectedcolumns">Select the columns to plot</option></select></label>
<br><span id="heatmap_image_select_columns_span" style="display:none"></span></p>

<p><label for="download_heatmap_margin_size">Margin width: </label>
<select id="download_heatmap_margin_size" onchange="clear_heatmap_show_image_size();">
<option value="0">0</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
<option value="6">6</option>
<option value="7" selected>7</option>
<option value="8">8</option>
<option value="9">9</option>
<option value="10">10</option>
<option value="11">11</option>
<option value="12">12</option>
<option value="13">13</option>
<option value="14">14</option>
<option value="15">15</option>
<option value="16">16</option>
<option value="17">17</option>
<option value="18">18</option>
<option value="19">19</option>
<option value="20">20</option>
</select> pixels.</p>


<p><label for="download_heatmap_col_width">Column width: </label>
<select id="download_heatmap_col_width" onchange="clear_heatmap_show_image_size();">
<option value="20">20</option>
<option value="40">40</option>
<option value="60">60</option>
<option value="80">80</option>
<option value="100">100</option>
<option value="120" selected>120</option>
<option value="140">140</option>
<option value="160">160</option>
<option value="180">180</option>
<option value="200">200</option>
<option value="200">220</option>
<option value="200">240</option>
</select> pixels.</p>

<p><label for="download_heatmap_font_size">Font height: </label>
<select id="download_heatmap_font_size" onchange="clear_heatmap_show_image_size();">
<option value="10">10</option>
<option value="12">12</option>
<option value="14">14</option>
<option value="16" selected>16</option>
<option value="18">18</option>
<option value="20">20</option>
<option value="22">22</option>
<option value="24">24</option>
</select> pixels.</p>

<p><label for="download_heatmap_text_padding">Space around text: </label>
<select id="download_heatmap_text_padding" onchange="clear_heatmap_show_image_size();">
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5" selected>5</option>
<option value="6">6</option>
<option value="7">7</option>
<option value="8">8</option>
<option value="9">9</option>
<option value="10">10</option>
</select> pixels.</p>

<p><label for="heatmap_background_colour">Background colour: </label><input type="color" id="heatmap_background_colour" value="#FFFFFF" onchange="clear_heatmap_show_image_size();">

<p><input type="checkbox" id="draw_fc_numbers"><label for="draw_fc_numbers">Draw fold-change numbers on the heatmap coloured boxes.</label></p>

<p>NOTE: This currently ignores the "<i>Show fold-change values .... that are above this <i>p</i>-value filter</i>" setting on the '<i>(4) Filter rows</i>' tab, and draws all cells with fold-changes.</p>

<!--  style="display:none; -->
<p><button id="preview_heatmap_button" onclick="draw_heatmap_button_clicked();">Preview the Heatmap image below</button></p>

<p id="draw_heatmap_show_image_size_text"></p>
<p><span id="draw_heatmap_image_progress"></span></p>

<!-- https://developer.mozilla.org/en-US/docs/Web/HTML/Element/a#using_the_download_attribute_to_save_a_canvas_as_a_png -->

  <!-- p style="text-align:center"><input type="submit" id="submit_heatmap_image_button" name="submit_heatmap_image_button" value="Open G:Profiler with this selected gene-list" disabled></p-->
</td></tr></table>


<table id="download_heatmap_image_table" class="tool_table tool_table_hide_td round_corners" style="display:none;">
<tr><th>View or Download your heatmap image:
 &nbsp; <button id="show_hide_download_heatmap_image_table_button" onclick="show_hide_table_row('download_heatmap_image');">Show</button>
</th></tr>

<tr id="download_heatmap_image_table_row"><td> <!-- style="display:none;" -->

 <p id="download_image_type_label_and_select" style="display:none;">
 <label for="download_image_type">Select Image download file type: </label>
 <select id="download_image_type"></select>

 <p>then: <a id="download_heatmap_image_link" href="#" onclick="download_heatmap(event,this);" style="display:none;">Download this heatmap image file (as image file type selected above)</a></p>

 <p><span id="download_heatmap_image_progress"></span></p>

 <!-- This canvas needs to be outside the above table, as if canvas image is wide then it makes the table wide so the above moves to the right out of view. -->
 <canvas id="my_heatmap_canvas" width="0" height="0" style="border: 0; padding: 0;">Your Browser doesn’t support Canvas.</canvas>
 <!-- canvas id="canvasTable" width=”1800px” height=”700px” style=”position: absolute; top: 0px; left: 0px; z-index: 2; width: 1428px; height: 761px; padding-top: 0px; padding-left: 0px;”>Your Browser doesn’t support Canvas.</canvas -->
</td></tr></table>
<br>


<!-- p style="text-align:center;">
<a href="" title="G:Profiler" target="_blank" onclick="gprofiler(this);">G:Profiler with selected genes</a>
</p -->


  </div>
  
  <div id="sjb_tab_content10" class="sjb_tab">

<table id="upset_vein_table" class="tool_table round_corners">
<tr><th>(10) UpSet/Vein type diagram of fold-changes:
</th></tr>

<tr><td>

<p style="font-size:80%;">NOTE: This UpSet/Vein does <b><i>not</i></b> use any of your settings on the '(3) Display options', '(4) Filter rows', or '(5) Selected genes' tabs,<br> rather it includes all genes and uses the following fold-change and p-value settings:</p>
<p><label for="vein_fc_threshold">Fold-change of:</label>
 <select id="vein_fc_threshold" onchange="count_vein_diagram();">
  <optgroup label="fold-change &ge; &plus; ...">
   <option value="+0.5" selected>fold-change &ge; &plus;0.5</option>
   <option value="+1.0">fold-change &ge; &plus;1.0</option>
   <option value="+1.5">fold-change &ge; &plus;1.5</option>
   <option value="+2.0">fold-change &ge; &plus;2.0</option>
   <option value="+3.0">fold-change &ge; &plus;3.0</option>
   <option value="+4.0">fold-change &ge; &plus;4.0</option>
   <option value="+5.0">fold-change &ge; &plus;5.0</option>
  </optgroup>
    
  <optgroup label="fold-change &le; &minus; ...">
   <option value="-0.5">fold-change &le; &minus;0.5</option>
   <option value="-1.0">fold-change &le; &minus;1.0</option>
   <option value="-1.5">fold-change &le; &minus;1.5</option>
   <option value="-2.0">fold-change &le; &minus;2.0</option>
   <option value="-3.0">fold-change &le; &minus;3.0</option>
   <option value="-4.0">fold-change &le; &minus;4.0</option>
   <option value="-5.0">fold-change &le; &minus;5.0</option>
  </optgroup>
  
  <optgroup label="Absolute(fold-change) &ge; ...">
   <option value="A0.5">Absolute(fold-change) &ge; 0.5 (ie. &ge; &plus;0.5 OR &le; &minus;0.5)</option>
   <option value="A1.0">Absolute(fold-change) &ge; 1.0 (ie. &ge; &plus;1.0 OR &le; &minus;1.0)</option>
   <option value="A1.5">Absolute(fold-change) &ge; 1.5 (ie. &ge; &plus;1.5 OR &le; &minus;1.5)</option>
   <option value="A2.0">Absolute(fold-change) &ge; 2.0 (ie. &ge; &plus;2.0 OR &le; &minus;2.0)</option>
   <option value="A3.0">Absolute(fold-change) &ge; 3.0 (ie. &ge; &plus;3.0 OR &le; &minus;3.0)</option>
   <option value="A4.0">Absolute(fold-change) &ge; 4.0 (ie. &ge; &plus;4.0 OR &le; &minus;4.0)</option>
   <option value="A5.0">Absolute(fold-change) &ge; 5.0 (ie. &ge; &plus;5.0 OR &le; &minus;5.0)</option>
  </optgroup>
  
  <optgroup label="Absolute(fold-change) &le; ...">  
   <option value="a0.5">Absolute(fold-change) &le; 0.5 (ie. &le; &plus;0.5 AND &ge; &minus;0.5)</option>
   <option value="a0.3">Absolute(fold-change) &le; 0.3 (ie. &le; &plus;0.3 AND &ge; &minus;0.3)</option>
   <option value="a0.1">Absolute(fold-change) &le; 0.1 (ie. &le; &plus;0.1 AND &ge; &minus;0.1)</option>
   <option value="a0.01">Absolute(fold-change) &le; 0.01 (ie. &le; &plus;0.01 AND &ge; &minus;0.01)</option>
  </optgroup>
 </select>

<br><label for="vein_pvalue">And p-value of:</label>
 <select id="vein_pvalue" onchange="count_vein_diagram();">
  <option value="Any" selected>Any p-value/FDR/q-value</option>
  <option value="0.5">&le; 0.5</option>
  <option value="0.1">&le; 0.1</option>
  <option value="0.05">&le; 0.05</option>
  <option value="0.01">&le; 0.01</option>
  <option value="0.005">&le; 0.005</option>
  <option value="0.001">&le; 0.001</option>
 </select>
</p>

<p style="text-align: center;"><button id="vein_diagram_button" onclick="count_vein_diagram();">Show UpSet/Vein type diagram</button></p>

</td></tr></table>

<!-- Putting the vein_diagram below outside the above table otherwise the round_corners puts rounded cornerns on each upset table row. -->
<br><div id="vein_diagram">
</div>
<p id="vein_diagram_message"></p>




  </div> <!-- end of: sjb_tab_content10 -->
  <div id="sjb_tab_content11" class="sjb_tab">

<table id="feedback_table" class="tool_table round_corners">
<tr><th>(11) Help/Feedback:
</th></tr>

<tr><td style="text-align:left;">

<p>First select your <i>Input data</i>, then <i>Select ids/species/columns</i> and <i>Display options</i>, then the heatmap will be displayed. You can then set <i>Filter</i> and <i>Select genes</i> to send to <i>g:Profile</i>, <i>STRING</i>, <i>DAVID</i>, and download a <i>Heatmap image</i>.</p>

<p>Web links:</p>
<ul>
<li><a href="https://qub-simpson-lab.github.io/HIVE_browser/" target="_blank">GitHub Page for using this HIVE browser</a></li>

<li><a href="......" target="_blank">Vignette/Examples for HIVE browser</a></li>

<li><a href="https://youtube.com..........." target="_blank">Video tutorial on Youtube [TODO]</a></li>

<li><a href="......" target="_blank">HIVE Manuscript</a></li>

<li><a href="https://github.com/QUB-Simpson-lab/HIVE_browser/" target="_blank">GitHub HIVE browser source</a></li>

<li>Two test gene-expression datasets – you can just copy and paste either of these two links (below) directly into the "<i>OR: Enter Web address (URL)</i>" text-box, then click the "<i>Read from Web URL</i>" button:
    <br> &nbsp; (1) Dropbox: https://www.dropbox.com/scl/fi/aomweg8fp963pydh8logf/HIVE_data_27July2023.tsv?rlkey=uz5ck5dazaeonoil6nfyqt96n <button onclick="copy_param('https://www.dropbox.com/scl/fi/aomweg8fp963pydh8logf/HIVE_data_27July2023.tsv?rlkey=uz5ck5dazaeonoil6nfyqt96n', 'help_sample_data1_copied_progress')">Copy this url</button><span id="help_sample_data1_copied_progress"></span>
    <br> &nbsp; (2) GitHub:  https://raw.githubusercontent.com/QUB-Simpson-lab/HIVE_browser/main/HIVE_data_21July2023_first50genes.tsv <button onclick="copy_param('https://raw.githubusercontent.com/QUB-Simpson-lab/HIVE_browser/main/HIVE_data_21July2023_first50genes.tsv', 'help_sample_data2_copied_progress')">Copy this url</button><span id="help_sample_data2_copied_progress"></span>
</li>

<li><a href="https://www.qub.ac.uk/research-centres/wwiem/OurResearch/ResearchThemes/VisionandVascularMedicine/" target="_blank">Simpson Lab group at WWIEM Vision and Vascular medicine</a></li>

</ul>

<p>We welcome your feedback either on: <a href="https://github.com/QUB-Simpson-lab/HIVE_browser/issues" target="_blank">GitHub</a> Issues, or <a href="mailto:........">Email - maybe a gmail address so won't get spammed, eg: hivebrowser@gmail.com .........</a></p>

<p>In addition to the tools called (STRING, g:Profiler, DAVID), the following might also be useful:</p>
<ul style="font-size: 85%;">
<li><a href="https://geoexplorer.rosalind.kcl.ac.uk/" target="_blank">GEOexplorer</a></li>
<li><a href="https://reactome.org/" target="_blank">Reactome</a></li>
<li><a href="https://www.webgestalt.org/" target="_blank">WebGestalt</a></li>
<li><a href="https://maayanlab.cloud/Enrichr/" target="_blank">Enrichr</a></li>
<li><a href="https://www.genome.jp/kegg/" target="_blank">KEGG</a></li>
<li><a href="https://bioinformatics.cse.unr.edu/software/cpa/" target="_blank">Consensus pathway analysis (CPA)</a></li>
<li><a href="http://149.165.154.220/idep/" target="_blank">iDEP</a></li>
<li><a href="http://www.ilincs.org/apps/grein/" target="_blank">GEO RNA-seq Experiments Interactive Navigator (GRAIN)</a></li>
<li><a href="https://kuanrongchan-stages-stages-vpgh46.streamlit.app/" target="_blank">STAGEs</a></li>
<li><a href="https://www.pathwaycommons.org/" target="_blank">Pathway commons</a></li>
<li><a href="https://imeg-ku.shinyapps.io/RNAseqChef/" target="_blank">RNAseqChef</a></li>
<li>and more at, eg: <a href="https://guides.ucsf.edu/bistats/pathenrich" target="_blank">UCSF - Bioinformatics and Statistics Resources</a></li>
</ul>

</td></tr></table>
<br>

  </div> <!-- end of: sjb_tab_content11 -->


</div> <!-- end of: div sjb_tab_content -->
</div> <!-- end of: sjb_tab_main -->


<h4 style="text-align:center; display:none" id="heatmap_title_text"><!--Differential Expression (DE) Log-2 --> 
  <span id="fold_change_or_pvalue_title"></span> Heatmap for: <span id="cluster_type_in_title"></span>
  </h4>

<table id="heatmap_scale_table" class="round_corners" style="padding:2px;"><tbody id="heatmap_scale_tbody"></tbody></table> <!-- WAS <table style="padding:2px; margin:0 auto; border-collapse:collapse; border: 1px solid #cccccc; background-color:#e6eeff;" -->

<p id="filter_heatmap_table_instructions" style="text-align:center; font-size:85%; display:none;">Clicking the Row-id (Gene name) in the left or right columns will open a new browser tab showing the NCBI Entrez entry for that gene name in the Species selected above (eg: mouse: Mus musculus).
<br>Columns with no fold-changes have their column heading in grey (eg: <span style="color:#a0a0a0;">'EARLY' or 'MID' or 'LATE'.</span>)
</p>

<table style="padding:2px;" class="round_corners"> <!-- WAS: margin:0 auto; border-collapse:collapse; border: 1px solid #cccccc; background-color:#e6eeff;" -->
 <thead id="heatmap_thead" style="position: sticky; top: 0;"></thead>
 <tbody id="heatmap_tbody"></tbody>
</table>


</body>
</html>
